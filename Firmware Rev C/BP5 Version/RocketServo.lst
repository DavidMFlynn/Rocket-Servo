RocketServo.asm                                                       Page: 1
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00001 0000 	;====================================================================================================
00002 0000 	;
00003 0000 	;   Filename:	RocketServo.asm (BP5 Hold version)
00004 0000 	;   Date:	10/14/2024
00005 0000 	;   File Version:	1.2b1
00006 0000 	;
00007 0000 	;    Author:	David M. Flynn
00008 0000 	;    Company:	Oxford V.U.E., Inc.
00009 0000 	;    E-Mail:	dflynn@oxfordvue.com
00010 0000 	;    Web Site:	http://www.oxfordvue.com/
00011 0000 	;
00012 0000 	;====================================================================================================
00013 0000 	;    RC Servo Activator for high power rocketry uses PIC12F1822
00014 0000 	;
00015 0000 	;    History:
00016 0000 	; 1.2b1   10/14/2024	Updated for Rev C PCBA, added Continuity enable, low battery fast blink
00017 0000 	; 1.1b3   8/6/2023	Added BP3Hold mode.
00018 0000 	; 1.1b2   5/4/2023	Fixed batt V blink, 10 or 11 blinks.
00019 0000 	; 1.1b1   12/28/2022	Added battery voltage sensing RA0 9.75C/V 3 for diode
00020 0000 	; 1.0b2   11/7/2022	Inverted CmdInputBit to active low
00021 0000 	; 1.0b1   8/31/2022    Copied from SM_Ctrl_RC_Servo.
00022 0000 	;
00023 0000 	;====================================================================================================
00024 0000 	; Options
00025 0000 0001 	HasEnable	EQU	1
00026 0000 0001 	HasBattV	EQU	1	;Set to 0 or 1
00027 0000 0001 	BP3Hold	EQU	1	;Hold at reverse value
00028 0000 	;====================================================================================================
00029 0000 	; To Do's
00030 0000 	;
00031 0000 	;====================================================================================================
00032 0000 	;====================================================================================================
00033 0000 	; What happens next:
00034 0000 	;
00035 0000 	;   The system LED blinks once per second
00036 0000 	;  Once at power-up:
00037 0000 	;   Blink battery voltage i.e. _ ......... _
00038 0000 	;   Do not arm if <7.5 NiMH, fast blink for 10 seconds
00039 0000 	;   Set position to the commanded position for 3 seconds.
00040 0000 	;
00041 0000 	;  Setup mode:
00042 0000 	;   If SW1 is pressed Increment the set value for the control condition.
00043 0000 	;   If SW2 is pressed Decrement the set value for the control condition.
00044 0000 	;
00045 0000 	;   If Control is High (active)
00046 0000 	;      move to set point 1 for 3 seconds
00047 0000 	;   else if Control is Low (Normal, Inactive)
00048 0000 	;      move to set point 2 for 3 seconds
00049 0000 	;
00050 0000 	;   CCP1 outputs a 900uS to 2100uS (1800..4200 counts) pulse every 16,000uS
00051 0000 	;
00052 0000 	;   Resolution is 0.5uS
00053 0000 	;
00054 0000 	;  if kInPosShutdown is set servo will power down after 3s
00055 0000 	;
00056 0000 	; MS62 25kgcm servo turns CW as pulse width increases as viewed from the servo.
00057 0000 	;
00058 0000 	;====================================================================================================
00059 0000 	;
00060 0000 	;  Pin 1 VDD (+5V)		+5V
00061 0000 	;  Pin 2 RA5		CCP1
00062 0000 	;  Pin 3 RA4		System LED Active Low/SW2 Dec switch Active Low
00063 0000 	;  Pin 4 RA3/MCLR*/Vpp (Input only)	Command = Active Low
00064 0000 	;  Pin 5 RA2		LED 2 Active Low/SW1 Inc switch Active Low
00065 0000 	;  Pin 6 RA1/ICSPCLK		RA1, Conductivity Enable Active Low
00066 0000 	;  Pin 7 RA0/ICSPDAT		AN0, Battery (volts-0.5)/21
00067 0000 	;  Pin 8 VSS (Ground)		Ground
00068 0000 	;
00069 0000 	;====================================================================================================
00070 0000 	;
00071 0000 	;
00072 0000 		list	p=12f1822,r=hex,w=1	; list directive to define processor
00073 0000 	;
00001 0000 		nolist
00002 0000 		nolist
00003 0000 	;==========================================================================
00004 0000 	; MPASM PIC12F1822 processor include
00005 0000 	;	
00006 0000 	; (c) Copyright 1999-2014 Microchip Technology, All rights reserved
00007 0000 	;==========================================================================
00008 0000 	;==========================================================================
01039 0000 		NOLIST
01040 0000 		NOLIST
00076 0000 		list
00077 0000 	;
00078 8007 EFA4 		__CONFIG _CONFIG1,_FOSC_INTOSC & _WDTE_OFF & _MCLRE_OFF & _IESO_OFF
00079 0000 	;
00080 0000 	;
00081 0000 	;
00082 0000 	; INTOSC oscillator: I/O function on CLKIN pin
00083 0000 	; WDT disabled
00084 0000 	; PWRT disabled
00085 0000 	; MCLR/VPP pin function is digital input
00086 0000 	; Program memory code protection is disabled
00087 0000 	; Data memory code protection is disabled
00088 0000 	; Brown-out Reset enabled
00089 0000 	; CLKOUT function is disabled. I/O or oscillator function on the CLKOUT pin
00090 0000 	; Internal/External Switchover mode is disabled
00091 0000 	; Fail-Safe Clock Monitor is enabled
RocketServo.asm                                                       Page: 2
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00092 0000 	;
00093 8008 DEFF 		__CONFIG _CONFIG2,_WRT_OFF & _PLLEN_OFF & _LVP_OFF
00094 0000 	;
00095 0000 	; Write protection off
00096 0000 	; 4x PLL disabled
00097 0000 	; Stack Overflow or Underflow will cause a Reset
00098 0000 	; Brown-out Reset Voltage (Vbor), low trip point selected.
00099 0000 	; Low-voltage programming Disabled ( allow MCLR to be digital in )
00100 0000 	;  *** must set apply Vdd before Vpp in ICD 3 settings ***
00101 0000 	;
00102 0000 	; '__CONFIG' directive is used to embed configuration data within .asm file.
00103 0000 	; The lables following the directive are located in the respective .inc file.
00104 0000 	; See respective data sheet for additional information on configuration word.
00105 0000 	;
00106 0000 		constant	oldCode=0
00107 0000 		constant	useRS232=0
00108 0000 	;
00109 0000 0003 	#Define	_C	STATUS,C
00110 0000 0003 	#Define	_Z	STATUS,Z
00111 0000 	;
00112 0000 	; 0.5uS res counter from 8MHz OSC
00113 0000 0009 	CCP1CON_Clr	EQU	b'00001001'	;Clear output on match
00114 0000 0008 	CCP1CON_Set	EQU	b'00001000'	;Set output on match
00115 0000 000A 	CCP1CON_Int	EQU	b'00001010'
00116 0000 	;
00117 0000 0041 	MinBattVolts	EQU	d'65'	;V/20 * 204c/v = 6.5V
00118 0000 	;
00119 0000 012C 	ActivationTime	EQU	d'300'	;3 seconds
00120 0000 07FF 	kOffsetCtrValue	EQU	d'2047'
00121 0000 03E8 	kMinPulseWidth	EQU	d'1000'	;500uS
00122 0000 0BB8 	kMidPulseWidth	EQU	d'3000'	;1500uS
00123 0000 1388 	kMaxPulseWidth	EQU	d'5000'	;2500uS
00124 0000 		if BP3Hold
00125 0000 03E8 	kDefaultPosition2	EQU	d'1000'	;500uS Locked
00126 0000 1388 	kDefaultPosition1	EQU	d'5000'	;2500uS Open
00127 0000 0001 	HoldOpen	EQU	1
00128 0000 		else
00132 0000 		endif
00133 0000 7D00 	kServoDwellTime	EQU	d'32000'	;16mS
00134 0000 0002 	kInPosShutdown	EQU	b'00000010'	;b'00000010' enabled 0x00 disabled
00135 0000 	;
00136 0000 	;====================================================================================================
00139 0000 		nolist
00140 0000 	;
00141 0000 	;    Port A bits
00142 0000 00DD 	PortADDRBits	EQU	b'11011101'
00143 0000 010C 	#Define	ContEnable	LATA,1	;Output: 0=Enabled
00144 0000 010C 	#Define	LED2	LATA,2	;Output: 0=LED ON, Input: 0 = Switch Pressed
00145 0000 008C 	#Define	LED2TrisBit	TRISA,2
00146 0000 000C 	#Define	IncBtnBit	PORTA,2
00147 0000 000C 	#Define	CmdInputBit	PORTA,3
00148 0000 010C 	#Define	SystemLED	LATA,4	;Output: 0=LED ON, Input: 0 = Switch Pressed
00149 0000 008C 	#Define	SysLEDTrisBit	TRISA,4
00150 0000 000C 	#Define	DecBtnBit	PORTA,4
00151 0000 000C 	#Define	RA5_In	PORTA,5	;CCP1
00152 0000 	;
00153 0000 0002 	PortAValue	EQU	b'00000010'
00154 0000 	;
00155 0000 	;====================================================================================================
00156 0000 	;====================================================================================================
00157 0000 	;
00158 0000 	;Constants
00159 0000 00FF 	All_In	EQU	0xFF
00160 0000 0000 	All_Out	EQU	0x00
00161 0000 	;
00162 0000 0064 	LEDTIME	EQU	d'100'	;1.00 seconds
00163 0000 000A 	LEDErrorTime	EQU	d'10'
00164 0000 	;
00165 0000 0001 	T1CON_Val	EQU	b'00000001'	;PreScale=1,Fosc/4,Timer ON
00166 0000 	;T1CON_Val	EQU	b'00100001'	;PreScale=4,Fosc/4,Timer ON
00167 0000 0072 	OSCCON_Value	EQU	b'01110010'	;8MHz
00168 0000 	;OSCCON_Value	EQU	b'11110000'	;32MHz
00169 0000 004E 	T2CON_Value	EQU	b'01001110'	;T2 On, /16 pre, /10 post
00170 0000 	;T2CON_Value	EQU	b'01001111'	;T2 On, /64 pre, /10 post
00171 0000 007D 	PR2_Value	EQU	.125
00172 0000 	;
00173 0000 	;
00174 0000 0000 	CCP1CON_Value	EQU	0x00	;CCP1 off
00175 0000 	;
00176 0000 	;================================================================================================
00177 0000 	;***** VARIABLE DEFINITIONS
00178 0000 	; there are 128 bytes of ram, Bank0 0x20..0x7F, Bank1 0xA0..0xBF
00179 0000 	; there are 256 bytes of EEPROM starting at 0x00 the EEPROM is not mapped into memory but
00180 0000 	;  accessed through the EEADR and EEDATA registers
00181 0000 	;================================================================================================
00182 0000 	;  Bank0 Ram 020h-06Fh 80 Bytes
00183 0000 	;
00184 0000 		cblock	0x20
00185 0000 	;
00186 0000 0020 M		ISR_Temp		;scratch mem
00187 0000 0021 M		LED_Time
00188 0000 0022 M		LED2_Time
00189 0000 0023 M		LED_Ticks		;Timer tick count
00190 0000 0024 M		LED2_Ticks
00191 0000 0025 M		LED_Blinks		;nBlinks, 0xFF=system blink, 0=Off
00192 0000      M	;
00193 0000      M	;
00194 0000 0026 M		EEAddrTemp		;EEProm address to read or write
00195 0000 0027 M		EEDataTemp		;Data to be writen to EEProm
RocketServo.asm                                                       Page: 3
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00196 0000      M	;
00197 0000      M	;
00198 0000 0028 M		Timer1Lo		;1st 16 bit timer
00199 0000 0029 M		Timer1Hi		; not used
00200 0000 002A M		Timer2Lo		;2nd 16 bit timer
00201 0000 002B M		Timer2Hi		; Servo active timer
00202 0000 002C M		Timer3Lo		;3rd 16 bit timer
00203 0000 002D M		Timer3Hi		; Activation timer
00204 0000 002E M		Timer4Lo		;4th 16 bit timer
00205 0000 002F M		Timer4Hi		; debounce timer and power up delay timer
00206 0000      M	;
00207 0000 0030 M		Dest:2
00208 0000 0032 M		CurPos:2
00209 0000      M	;
00210 0000 0034 M		Position1:2
00211 0000 0036 M		Position2:2
00212 0000 0038 M		SysFlags
00213 0000      M	;
00214 0000 0039 M		Debounce
00215 0000      M	;
00216 0000      M		endc
00217 0000      M	;
00218 0000 0038 M	#Define	PulseSent	SysFlags,0
00219 0000 0038 M	#Define	InPosShutdown	SysFlags,1
00220 0000 0038 M	#Define	InPosition	SysFlags,2
00221 0000 0038 M	#Define	BattV_OK	SysFlags,3
00222 0000      M	;
00223 0000 0034 M	#Define	FirstRAMParam	Position1
00224 0000 0038 M	#Define	LastRAMParam	SysFlags
00225 0000      M	;
00226 0000      M	;================================================================================================
00227 0000      M	;  Bank1 Ram 0A0h-0BFh 32 Bytes
00228 0000      M	;
00229 0000      M	;
00230 0000      M	;=======================================================================================================
00231 0000      M	;  Common Ram 70-7F same for all banks
00232 0000      M	;      except for ISR_W_Temp these are used for paramiter passing and temp vars
00233 0000      M	;=======================================================================================================
00234 0000      M	;
00235 0000      M		cblock	0x70
00236 0000 0070 M		SigOutTime
00237 0000 0071 M		SigOutTimeH
00238 0000 0072 M		Flags
00239 0000      M	;
00240 0000 0073 M		Param73
00241 0000 0074 M		Param74
00242 0000      M	;
00243 0000 0075 M		CalcdDwell
00244 0000 0076 M		CalcdDwellH
00245 0000 0077 M		Param77
00246 0000 0078 M		Param78
00247 0000 0079 M		Param79
00248 0000 007A M		Param7A
00249 0000 007B M		Param7B
00250 0000 007C M		Param7C
00251 0000 007D M		Param7D
00252 0000 007E M		Param7E
00253 0000 007F M		Param7F
00254 0000      M		endc
00255 0000      M	;
00256 0000      M	; Flags bits
00257 0000 0072 M	#Define	IncBtnFlag	Flags,0
00258 0000 0072 M	#Define	DecBtnFlag	Flags,1
00259 0000 0072 M	#Define	LED2Flag	Flags,2
00260 0000 0072 M	#Define	DataChangedFlag	Flags,3
00261 0000 0072 M	#Define	ServoOff	Flags,4
00262 0000 0072 M	#Define	SMRevFlag	Flags,5
00263 0000 0072 M	#Define	NewSWData	Flags,6
00264 0000      M	;
00265 0000 012C M	ServoMoveTime	EQU	.300	;time servo is powered when CMD changes
00266 0000      M	;
00267 0000 0002 M	BtnChangeRate	EQU	0x02	;change by 1uS per 0.05 seconds
00268 0000 0040 M	SlewChangeRate	EQU	0x40	;change by 8uS per 0.01 seconds
00269 0000      M	;
00270 0000      M	;=========================================================================================
00271 0000      M	;Conditionals
00272 0000 0080 M	HasISR	EQU	0x80	;used to enable interupts 0x80=true 0x00=false
00273 0000      M	;
00274 0000      M	;=========================================================================================
00275 0000      M	;==============================================================================================
00276 0000      M	; ID Locations
00277 0000      M		__idlocs	0x12B1
00278 0000      M	;
00279 0000      M	;==============================================================================================
00280 0000      M	; EEPROM locations (NV-RAM) 0x00..0x7F (offsets)
00281 0000      M		org	0xF000
00282 F000      M	;
00283 F000 0088      M		de	LOW kDefaultPosition1	;nvPosition1Lo
00284 F001 0013      M		de	HIGH kDefaultPosition1
00285 F002 00E8      M		de	LOW kDefaultPosition2
00286 F003 0003      M		de	HIGH kDefaultPosition2
00287 F004      M	;
00288 F004 0002      M		de	kInPosShutdown	;nvSysFlags
00289 F005      M	;
00290 F005      M		cblock	0x00
00291 F005 0000 M		nvPosition1Lo
00292 F005 0001 M		nvPosition1Hi
00293 F005 0002 M		nvPosition2Lo
00294 F005 0003 M		nvPosition2Hi
RocketServo.asm                                                       Page: 4
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00295 F005      M	;
00296 F005 0004 M		nvSysFlags
00297 F005      M		endc
00298 F005      M	;
00299 F005 0000 M	#Define	nvFirstParamByte	nvPosition1Lo
00300 F005 0004 M	#Define	nvLastParamByte	nvSysFlags
00301 F005      M	;
00302 F005      M	;
00303 F005      M	;==============================================================================================
00304 F005      M	;============================================================================================
00305 F005      M	;
00306 F005      M	;
00307 F005      M		ORG	0x000	; processor reset vector
00308 0000 0183      M		CLRF	STATUS
00309 0001 018A      M		CLRF	PCLATH
00310 0002 285F      M	  	goto	start	; go to beginning of program
00311 0003      M	;
00312 0003      M	;===============================================================================================
00313 0003      M	; Interupt Service Routine
00314 0003      M	;
00315 0003      M	; we loop through the interupt service routing every 0.01 seconds
00316 0003      M	;
00317 0003      M	;
00318 0003      M		ORG	0x004	; interrupt vector location
00319 0004 0020      M		movlb	0	; bank0
00320 0005      M	;
00321 0005 1C91      M		btfss	PIR1,TMR2IF
00322 0006 282F      M		goto	IRQ_2
00323 0007 1091      M		bcf	PIR1,TMR2IF	; reset interupt flag bit
00324 0008      M	;
00325 0008      M	;Decrement timers until they are zero
00326 0008      M	;
00327 0008 0185      M		CLRF	FSR0H
00328 0009 224A      M		call	DecTimer1	;if timer 1 is not zero decrement
00329 000A 2248      M		call	DecTimer2
00330 000B 2246      M		call	DecTimer3
00331 000C 2244      M		call	DecTimer4
00332 000D      M	;
00333 000D      M	;-----------------------------------------------------------------
00334 000D      M	; blink LEDs
00335 000D 0021      M		movlb                  1                      ;bank 1
00336 000E 160C      M		BSF	SysLEDTrisBit	;LED off
00337 000F 150C      M		BSF	LED2TrisBit	;LED2 off
00338 0010      M	;
00339 0010 0020      M		movlb	0	;bank 0
00340 0011 1072      M		BCF	IncBtnFlag
00341 0012 1D0C      M		BTFSS	IncBtnBit
00342 0013 1472      M		BSF	IncBtnFlag
00343 0014      M	;
00344 0014 10F2      M		BCF	DecBtnFlag
00345 0015 1E0C      M		BTFSS	DecBtnBit
00346 0016 14F2      M		BSF	DecBtnFlag
00347 0017      M	;
00348 0017 1772      M		bsf	NewSWData	;New data every 0.01s
00349 0018      M	;
00350 0018 0BA3      M	SystemBlink_1	DECFSZ	LED_Ticks,F	;Time to blink?
00351 0019 320B      M		bra	SystemBlink_end	; no
00352 001A      M	;
00353 001A 0821      M		MOVF	LED_Time,W
00354 001B 00A3      M		movwf	LED_Ticks
00355 001C      M	;
00356 001C 08A5      M		movf	LED_Blinks,F	;nBlinks, 0xFF=system blink, 0=Off
00357 001D 		SKPNZ
00357 001D 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00358 001E 3206 		BRA	SystemBlink_end
00359 001F 0F25 		incfsz	LED_Blinks,W
00360 0020 3201 		BRA	SystemBlink_Blinking
00361 0021 3201 		BRA	SystemBlink_on
00362 0022 03A5 	SystemBlink_Blinking	decf	LED_Blinks,F
00363 0023 0021 	SystemBlink_on	movlb                  1                      ;bank 1
00364 0024 120C 		BCF	SysLEDTrisBit	;LED on
00365 0025 0020 	SystemBlink_end	MOVLB	0                      ;bank 0
00366 0026 	;
00367 0026 0BA4 		decfsz	LED2_Ticks,F
00368 0027 3206 		bra	LED2_End
00369 0028 	;
00370 0028 0822 		MOVF	LED2_Time,W
00371 0029 00A4 		movwf	LED2_Ticks
00372 002A 	;
00373 002A 1D72 		BTFSS	LED2Flag
00374 002B 3202 		bra                    LED2_End
00375 002C 0021 		movlb                  1                      ;bank 1
00376 002D 110C 		BCF	LED2TrisBit
00377 002E 	;
00378 002E 0020 	LED2_End	MOVLB	0
00379 002F 	;-----------------------------------------------------------------
00380 002F 	;
00381 002F 	IRQ_2:
00382 002F 	;==================================================================================
00383 002F 	;
00384 002F 	; Handle CCP1 Interupt Flag, Enter w/ bank 0 selected
00385 002F 	;
00386 002F 0020 	IRQ_Servo1	MOVLB	0	;bank 0
00387 0030 1D11 		BTFSS	PIR1,CCP1IF
00388 0031 285E 		GOTO	IRQ_Servo1_End
00389 0032 	;
00390 0032 1438 		BSF	PulseSent
00391 0033 1E72 		BTFSS	ServoOff	;Are we sending a pulse?
00392 0034 2838 		GOTO	IRQ_Servo1_1	; Yes
RocketServo.asm                                                       Page: 5
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00393 0035 	;
00394 0035 	;Oops, how did we get here???
00395 0035 0025 		MOVLB	0x05                   ;Bank 5
00396 0036 0193 		CLRF	CCP1CON
00397 0037 285C 		GOTO	IRQ_Servo1_X
00398 0038 	;
00399 0038 0025 	IRQ_Servo1_1	MOVLB	0x05                   ;Bank 5
00400 0039 1813 		BTFSC	CCP1CON,CCP1M0	;Set output on match?
00401 003A 2850 		GOTO	IRQ_Servo1_OL	; No
00402 003B 	; An output just went high
00403 003B 	;
00404 003B 0870 		MOVF	SigOutTime,W	;Put the pulse into the CCP reg.
00405 003C 0791 		ADDWF	CCPR1L,F
00406 003D 0871 		MOVF	SigOutTime+1,W
00407 003E 3D92 		ADDWFC	CCPR1H,F
00408 003F 0020 		movlb	0	;Bank 0
00409 0040 300A 		movlw	CCP1CON_Int
00410 0041 1CB8 		btfss	InPosShutdown
00411 0042 3009 		MOVLW	CCP1CON_Clr	;Clear output on match
00412 0043 1D38 		btfss	InPosition
00413 0044 3009 		MOVLW	CCP1CON_Clr	;Clear output on match
00414 0045 0025 		movlb	5	;Bank 5
00415 0046 0093 		MOVWF	CCP1CON	;CCP1 clr on match
00416 0047 	;Calculate dwell time
00417 0047 3000 		MOVLW	LOW kServoDwellTime
00418 0048 00F5 		MOVWF	CalcdDwell
00419 0049 307D 		MOVLW	HIGH kServoDwellTime
00420 004A 00F6 		MOVWF	CalcdDwellH
00421 004B 0870 		MOVF	SigOutTime,W
00422 004C 02F5 		SUBWF	CalcdDwell,F
00423 004D 0871 		MOVF	SigOutTime+1,W
00424 004E 3BF6 		SUBWFB	CalcdDwellH,F
00425 004F 285C 		GOTO	IRQ_Servo1_X
00426 0050 	;
00427 0050 	; output went low so this cycle is done
00428 0050 3000 	IRQ_Servo1_OL	MOVLW	LOW kServoDwellTime
00429 0051 0791 		ADDWF	CCPR1L,F
00430 0052 307D 		MOVLW	HIGH kServoDwellTime
00431 0053 3D92 		ADDWFC	CCPR1H,F
00432 0054 	;
00433 0054 0020 		movlb	0	;Bank 0
00434 0055 300A 		movlw	CCP1CON_Int
00435 0056 1CB8 		btfss	InPosShutdown
00436 0057 3008 		MOVLW	CCP1CON_Set	;Set output on match
00437 0058 1D38 		btfss	InPosition
00438 0059 3008 		MOVLW	CCP1CON_Set	;Set output on match
00439 005A 0025 		movlb	5	;Bank 5
00440 005B 0093 		MOVWF	CCP1CON	;Idle output low
00441 005C 	;
00442 005C 0020 	IRQ_Servo1_X	MOVLB	0x00                   ;Bank 0
00443 005D 1111 		BCF	PIR1,CCP1IF
00444 005E 	IRQ_Servo1_End:
00445 005E 	;--------------------------------------------------------------------
00446 005E 	;
00447 005E 0009 		retfie		; return from interrupt
00448 005F 	;
00449 005F 	;
00450 005F 	;==============================================================================================
00451 005F 	;**********************************************************************************************
00452 005F 	;==============================================================================================
00453 005F 	;
00454 005F 0021 	start	MOVLB	0x01	; select bank 1
00455 0060 1795 		bsf	OPTION_REG,NOT_WPUEN	; disable pullups on port B
00456 0061 1295 		bcf	OPTION_REG,TMR0CS	; TMR0 clock Fosc/4
00457 0062 1195 		bcf	OPTION_REG,PSA	; prescaler assigned to TMR0
00458 0063 1415 		bsf	OPTION_REG,PS0	;111 8mhz/4/256=7812.5hz=128uS/Ct=0.032768S/ISR
00459 0064 1495 		bsf	OPTION_REG,PS1	;101 8mhz/4/64=31250hz=32uS/Ct=0.008192S/ISR
00460 0065 1515 		bsf	OPTION_REG,PS2
00461 0066 	;
00462 0066 3072 		MOVLW	OSCCON_Value
00463 0067 0099 		MOVWF	OSCCON
00464 0068 3017 		movlw	b'00010111'	; WDT prescaler 1:65536 period is 2 sec (RESET value)
00465 0069 0097 		movwf	WDTCON
00466 006A 	;
00467 006A 0023 		MOVLB	0x03	; bank 3
00468 006B 	;
00469 006B 		if HasBattV
00470 006B 3001 		MOVLW	0x01
00471 006C 		else
00473 006C 		endif
00474 006C 	;
00475 006C 008C 		MOVWF	ANSELA	;AN0 only
00476 006D 	;
00477 006D 	; setup timer 1 for 0.5uS/count
00478 006D 	;
00479 006D 0020 		movlb	0	; bank 0
00480 006E 3001 		MOVLW	T1CON_Val
00481 006F 0098 		MOVWF	T1CON
00482 0070 1399 		bcf	T1GCON,TMR1GE
00483 0071 	;
00484 0071 	; clear memory to zero
00485 0071 2215 		CALL	ClearRam
00486 0072 	;
00487 0072 	; Setup timer 2 for 0.01S/Interupt
00488 0072 304E 		MOVLW	T2CON_Value	;Setup T2 for 100/s
00489 0073 009C 		MOVWF	T2CON
00490 0074 307D 		MOVLW	PR2_Value
00491 0075 009B 		MOVWF	PR2
00492 0076 0021 		MOVLB	1	;Bank 1
RocketServo.asm                                                       Page: 6
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00493 0077 1491 		BSF	PIE1,TMR2IE
00494 0078 0020 		movlb	0                      ;Bank 0
00495 0079 	;
00496 0079 	; setup ccp1
00497 0079 	;
00498 0079 1672 		BSF	ServoOff
00499 007A 0022 		movlb	2                      ;bank 2
00500 007B 141D 		BSF	APFCON,CCP1SEL	;RA5
00501 007C 0025 		movlb	5                      ;bank 5
00502 007D 0193 		CLRF	CCP1CON
00503 007E 	;
00504 007E 0021 		MOVLB	0x01	;Bank 1
00505 007F 1511 		bsf	PIE1,CCP1IE
00506 0080 	;
00507 0080 	; setup data ports
00508 0080 0020 		movlb                  0                      ;bank 0
00509 0081 3002 		MOVLW	PortAValue
00510 0082 008C 		MOVWF	PORTA	;Init PORTA
00511 0083 0021 		movlb                  1                      ;bank 1
00512 0084 30DD 		MOVLW	PortADDRBits
00513 0085 008C 		MOVWF	TRISA
00514 0086 	;
00515 0086 0020 		MOVLB	0	;bank 0
00516 0087 0064 		CLRWDT
00517 0088 	;
00518 0088 3064 		MOVLW	LEDTIME
00519 0089 00A1 		MOVWF	LED_Time
00520 008A 3001 		movlw	0x01	;continuos ON
00521 008B 00A2 		movwf	LED2_Time
00522 008C 	;
00523 008C 0064 		CLRWDT
00524 008D 2225 		CALL	CopyToRam
00525 008E 0064 		CLRWDT
00526 008F 	;
00527 008F 	;
00528 008F 170B 		bsf	INTCON,PEIE	; enable periferal interupts
00529 0090 	;	bsf	INTCON,T0IE	; enable TMR0 interupt
00530 0090 178B 		bsf	INTCON,GIE	; enable interupts
00531 0091 	;
00532 0091 0020 		MOVLB	0x00	;bank 0
00533 0092 3004 		movlw	0x04
00534 0093 00AE 		movwf	Timer4Lo	;power up delay
00535 0094 	;
00536 0094 	;=========================================================================================
00537 0094 	;=========================================================================================
00538 0094 	;  Main Loop
00539 0094 	;
00540 0094 		if HasBattV
00541 0094 21AC 		CALL	ReadAN0_ColdStart
00542 0095 20C6 		CALL	LongFlash
00543 0096 	;
00544 0096 219E 		CALL	ReadAN0
00545 0097 219E 		CALL	ReadAN0
00546 0098 	;
00547 0098 	;	if HasEnable
00548 0098 0022 		MOVLB	2	;bank 2
00549 0099 148C 		bsf	ContEnable	;Disable continuity
00550 009A 0020 		MOVLB	0	;bank 0
00551 009B 11B8 		bcf	BattV_OK
00552 009C 08FD 		movf	Param7D,F	;error is not zero
00553 009D 		SKPZ
00553 009D 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00554 009E 3205 		bra	BVBad
00555 009F 3041 		movlw	MinBattVolts
00556 00A0 027C 		subwf	Param7C,W	;ADC-MinBattVolts
00557 00A1 		SKPNB
00557 00A1 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
00558 00A2 3201 		bra	BVBad
00559 00A3 15B8 		bsf	BattV_OK
00560 00A4 	BVBad	
00561 00A4 	;	else
00562 00A4 	;	bsf	BattV_OK
00563 00A4 	;	endif
00564 00A4 	;
00565 00A4 	; devide by 8
00566 00A4 36FD 		lsrf	Param7D,F
00567 00A5 0CFC 		rrf	Param7C,F
00568 00A6 36FD 		lsrf	Param7D,F
00569 00A7 0CFC 		rrf	Param7C,F
00570 00A8 36FD 		lsrf	Param7D,F
00571 00A9 0CFC 		rrf	Param7C,F
00572 00AA 	;
00573 00AA 3032 		movlw	.50	; 1/2 second
00574 00AB 00A1 		movwf	LED_Time
00575 00AC 087C 		movf	Param7C,W
00576 00AD 00A5 		movwf	LED_Blinks
00577 00AE 	;
00578 00AE 	; Wait for blinks to finish
00579 00AE 0064 	Start_L1	CLRWDT
00580 00AF 0825 		movf	LED_Blinks,W
00581 00B0 		SKPZ
00581 00B0 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00582 00B1 33FC 		BRA	Start_L1
00583 00B2 	;
00584 00B2 20CD 		CALL	Delay_1S
00585 00B3 	;
00586 00B3 20C6 		CALL	LongFlash
00587 00B4 	;
00588 00B4 		else
RocketServo.asm                                                       Page: 7
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00590 00B4 		endif
00591 00B4 	;
00592 00B4 1DB8 		btfss	BattV_OK
00593 00B5 3204 		bra	BlinkError
00594 00B6 0022 		MOVLB	2	;bank 2
00595 00B7 108C 		bcf	ContEnable	;Enable continuity
00596 00B8 0020 		MOVLB	0	;bank 0
00597 00B9 3205 		bra	Start_1
00598 00BA 	;
00599 00BA 300A 	BlinkError	movlw	LEDErrorTime
00600 00BB 00A1 		MOVWF	LED_Time
00601 00BC 30FF 		movlw	0xFF
00602 00BD 00A5 		movwf	LED_Blinks
00603 00BE 3204 		bra	Start_Err
00604 00BF 	;
00605 00BF 	; normal system blinks
00606 00BF 3064 	Start_1	MOVLW	LEDTIME
00607 00C0 00A1 		MOVWF	LED_Time
00608 00C1 30FF 		movlw	0xFF
00609 00C2 00A5 		movwf	LED_Blinks
00610 00C3 	;
00611 00C3 21B4 	Start_Err	CALL	StartServo
00612 00C4 20D4 		CALL	HomeServo
00613 00C5 		
00614 00C5 3216 		BRA	MainLoop
00615 00C6 	;
00616 00C6 	;==============================================
00617 00C6 	; One second ON one second OFF
00618 00C6 3064 	LongFlash	movlw	.100
00619 00C7 00A5 		movwf	LED_Blinks
00620 00C8 3001 		movlw	0x01	;constant ON
00621 00C9 00A1 		movwf	LED_Time
00622 00CA 0825 	LongFlash_L1	movf	LED_Blinks,W
00623 00CB 		SKPZ
00623 00CB 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00624 00CC 33FD 		BRA	LongFlash_L1
00625 00CD 	;
00626 00CD 3064 	Delay_1S	movlw	.100
00627 00CE 00A8 		movwf	Timer1Lo
00628 00CF 0828 	Delay_L1	movf	Timer1Lo,W
00629 00D0 		SKPZ
00629 00D0 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00630 00D1 33FD 		bra	Delay_L1
00631 00D2 0064 		CLRWDT
00632 00D3 0008 		return
00633 00D4 	;
00634 00D4 	;==============================================
00635 00D4 0020 	HomeServo	movlb	0	;Bank0
00636 00D5 12F2 		bcf	SMRevFlag
00637 00D6 1172 		bcf	LED2Flag
00638 00D7 302C 		movlw	Low ActivationTime
00639 00D8 00AC 		movwf	Timer3Lo
00640 00D9 3001 		movlw	High ActivationTime
00641 00DA 00AD 		movwf	Timer3Hi
00642 00DB 0008 		return
00643 00DC 	;
00644 00DC 	;=========================================================================================
00645 00DC 	;
00646 00DC 0064 	MainLoop	CLRWDT
00647 00DD 0020 		MOVLB	0x00                   ;Bank 0
00648 00DE 	;
00649 00DE 	; Handle Inc/Dec buttons
00650 00DE 082E 		movf	Timer4Lo,W
00651 00DF 042F 		iorwf	Timer4Hi,W
00652 00E0 		SKPZ		;Timer4 == 0?
00652 00E0 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00653 00E1 3225 		bra	ML_Btns_End	; No
00654 00E2 1C72 		btfss	IncBtnFlag	;Inc button is down?
00655 00E3 3213 		bra	ML_Btns_Dec	; No
00656 00E4 	;
00657 00E4 1CF2 		btfss	DecBtnFlag	;Dec button is down?
00658 00E5 3206 		bra	ML_Btns_Inc	; No
00659 00E6 	; Handle both buttons, move to center
00660 00E6 30B8 		movlw	low kMidPulseWidth
00661 00E7 00B0 		movwf	Dest
00662 00E8 300B 		movlw	high kMidPulseWidth
00663 00E9 00B1 		movwf	Dest+1
00664 00EA 11F2 		bcf	DataChangedFlag
00665 00EB 323B 		bra	Set_Dest_End
00666 00EC 	;
00667 00EC 	; Handle INC button
00668 00EC 217A 	ML_Btns_Inc	call	CopyPosToTemp
00669 00ED 3002 		movlw	BtnChangeRate
00670 00EE 07FC 		addwf	Param7C,F
00671 00EF 3000 		movlw	0x00
00672 00F0 3DFD 		addwfc	Param7D,F
00673 00F1 21E5 		call	ClampInt
00674 00F2 2177 		call	CopyTempToPos
00675 00F3 15F2 		bsf	DataChangedFlag
00676 00F4 	;
00677 00F4 3005 		movlw	0x05	; 0.05 seconds
00678 00F5 00AE 		movwf	Timer4Lo
00679 00F6 3210 		bra	ML_Btns_End
00680 00F7 	;
00681 00F7 1CF2 	ML_Btns_Dec	btfss	DecBtnFlag	;Dec button is down?
00682 00F8 320B 		bra	ML_Btns_Save	; No
00683 00F9 	;
00684 00F9 	; Handle DEC button
00685 00F9 217A 		call	CopyPosToTemp
RocketServo.asm                                                       Page: 8
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00686 00FA 3002 		movlw	BtnChangeRate
00687 00FB 02FC 		subwf	Param7C,F
00688 00FC 3000 		movlw	0x00
00689 00FD 3BFD 		subwfb	Param7D,F
00690 00FE 21E5 		call	ClampInt
00691 00FF 2177 		call	CopyTempToPos
00692 0100 15F2 		bsf	DataChangedFlag
00693 0101 	;
00694 0101 3005 		movlw	0x05	; 0.05 seconds
00695 0102 00AE 		movwf	Timer4Lo
00696 0103 3203 		bra	ML_Btns_End
00697 0104 		bra	ML_Btns_End
00698 0104 19F2 	ML_Btns_Save	btfsc	DataChangedFlag
00699 0105 2234 		call	SaveParams
00700 0106 11F2 		bcf	DataChangedFlag
00701 0107 	ML_Btns_End:
00702 0107 	;
00703 0107 	;-------------------------
00704 0107 	; Set Dest
00705 0107 	;
00706 0107 1F72 		btfss	NewSWData	;10mS interval passed?
00707 0108 321E 		bra	Set_Dest_End	; No
00708 0109 1372 		bcf	NewSWData
00709 010A 	;
00710 010A 198C 		btfsc	CmdInputBit	;Contorl signal active?
00711 010B 320E 		bra	ML_CmdNormal	; No
00712 010C 	; debounce, don't change until we've seen the input 5 times
00713 010C 3005 		movlw	0x05
00714 010D 0239 		subwf	Debounce,W
00715 010E 		SKPZ		;5 times?
00715 010E 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00716 010F 3208 		bra	Rev_Debounce	; No
00717 0110 	;
00718 0110 0020 		movlb	0	;Bank0
00719 0111 16F2 		bsf	SMRevFlag
00720 0112 1572 		bsf	LED2Flag
00721 0113 302C 		movlw	Low ActivationTime
00722 0114 00AC 		movwf	Timer3Lo
00723 0115 3001 		movlw	High ActivationTime
00724 0116 00AD 		movwf	Timer3Hi
00725 0117 320E 		bra	Move_It
00726 0118 	;
00727 0118 0AB9 	Rev_Debounce	incf	Debounce,F
00728 0119 320D 		bra	Set_Dest_End
00729 011A 	;
00730 011A 08B9 	ML_CmdNormal	movf	Debounce,F
00731 011B 		SKPZ
00731 011B 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00732 011C 3207 		bra	Norm_Debounce
00733 011D 	;
00734 011D 0020 		movlb	0	;Bank 0
00735 011E 082C 		movf	Timer3Lo,W
00736 011F 042D 		iorwf	Timer3Hi,W
00737 0120 		SKPZ		;Activation time done?
00737 0120 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00738 0121 3204 		bra	Move_It	; No
00739 0122 		if HoldOpen=0
00741 0122 		endif
00742 0122 1172 		bcf	LED2Flag
00743 0123 3202 		bra	Move_It
00744 0124 	;
00745 0124 03B9 	Norm_Debounce	decf	Debounce,F
00746 0125 3201 		bra	Set_Dest_End
00747 0126 	;
00748 0126 217D 	Move_It	call	CopyPosToDest
00749 0127 	;
00750 0127 	Set_Dest_End:
00751 0127 	;
00752 0127 	;---------------------
00753 0127 	; Move CurPos toward Dest
00754 0127 0020 		movlb	0	;Bank 0
00755 0128 1C38 		btfss	PulseSent
00756 0129 323B 		bra	Move_End
00757 012A 1038 		bcf	PulseSent
00758 012B 	;
00759 012B 0830 		movf	Dest,W
00760 012C 0232 		subwf	CurPos,W
00761 012D 00F8 		movwf	Param78
00762 012E 0831 		movf	Dest+1,W
00763 012F 3B33 		subwfb	CurPos+1,W
00764 0130 04F8 		iorwf	Param78,F
00765 0131 		SKPZ		;Dest == CurPos?
00765 0131 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00766 0132 3205 		bra	Move_It_NIP
00767 0133 082A 		movf	Timer2Lo,W
00768 0134 042B 		iorwf	Timer2Hi,W
00769 0135 		SKPNZ
00769 0135 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00770 0136 1538 		bsf	InPosition
00771 0137 3228 		bra	Move_It_Now	; Yes
00772 0138 	;
00773 0138 302C 	Move_It_NIP	movlw	Low ServoMoveTime
00774 0139 00AA 		movwf	Timer2Lo
00775 013A 3001 		movlw	High ServoMoveTime
00776 013B 00AB 		movwf	Timer2Hi
00777 013C 1138 		bcf	InPosition
00778 013D 	;
00779 013D 0830 		movf	Dest,W
00780 013E 00F8 		movwf	Param78
RocketServo.asm                                                       Page: 9
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00781 013F 0831 		movf	Dest+1,W
00782 0140 00F9 		movwf	Param79
00783 0141 	;
00784 0141 0832 		movf	CurPos,W
00785 0142 00FC 		movwf	Param7C
00786 0143 0833 		movf	CurPos+1,W
00787 0144 00FD 		movwf	Param7D
00788 0145 	;
00789 0145 2206 		call	Param7D_LE_Param79
00790 0146 1C77 		btfss	Param77,0	;CurPos<=Dest?
00791 0147 320C 		bra	Move_It_Neg	; No, CurPos>Dest
00792 0148 	;CurPos<Dest, so move CurPos positive
00793 0148 3040 		movlw	SlewChangeRate
00794 0149 07FC 		addwf	Param7C,F
00795 014A 3000 		movlw	0x00
00796 014B 3DFD 		addwfc	Param7D,F
00797 014C 2206 		call	Param7D_LE_Param79
00798 014D 1C77 		btfss	Param77,0	;CurPos<=Dest Still?
00799 014E 320D 		bra	Move_It_Dest	; No, CurPos>Dest
00800 014F 				; Yes, CurPos+=SlewChangeRate
00801 014F 	;
00802 014F 	; make the calculated position the current position
00803 014F 087C 	Move_It_New	movf	Param7C,W
00804 0150 00B2 		movwf	CurPos
00805 0151 087D 		movf	Param7D,W
00806 0152 00B3 		movwf	CurPos+1
00807 0153 320C 		bra	Move_It_Now
00808 0154 	;
00809 0154 	Move_It_Neg
00810 0154 3040 		movlw	SlewChangeRate
00811 0155 02FC 		subwf	Param7C,F
00812 0156 3000 		movlw	0x00
00813 0157 3BFD 		subwfb	Param7D,F
00814 0158 2206 		call	Param7D_LE_Param79
00815 0159 1877 		btfsc	Param77,0	;CurPos<=Dest now?
00816 015A 3201 		bra	Move_It_Dest	; Yes, CurPos<=Dest
00817 015B 33F3 		bra	Move_It_New
00818 015C 	;
00819 015C 	; make the current position the destination
00820 015C 0830 	Move_It_Dest	movf	Dest,W
00821 015D 00B2 		movwf	CurPos
00822 015E 0831 		movf	Dest+1,W
00823 015F 00B3 		movwf	CurPos+1
00824 0160 	;
00825 0160 	Move_It_Now:
00826 0160 0832 		movf	CurPos,W
00827 0161 00FC 		movwf	Param7C
00828 0162 0833 		movf	CurPos+1,W
00829 0163 00FD 		movwf	Param7D
00830 0164 2166 		CALL	Copy7CToSig
00831 0165 	Move_End:
00832 0165 	;
00833 0165 28DC 		goto	MainLoop
00834 0166 	;
00835 0166 	;========================================================================================
00836 0166 	; Param7D:Param7C >> SigOutTimeH:SigOutTime
00837 0166 	; Entry: Param7D:Param7C
00838 0166 	;
00839 0166 	; Don't disable interrupts if you don't need to...
00840 0166 	; If Param7D:Param7C == SigOutTimeH:SigOutTime then return
00841 0166 087C 	Copy7CToSig	MOVF	Param7C,W
00842 0167 0270 		SUBWF	SigOutTime,W
00843 0168 		SKPZ
00843 0168 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00844 0169 296E 		GOTO	Copy7CToSig_1
00845 016A 087D 		MOVF	Param7D,W
00846 016B 0271 		SUBWF	SigOutTimeH,W
00847 016C 		SKPNZ
00847 016C 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00848 016D 0008 		Return
00849 016E 	;
00850 016E 	;SigOutTimeH:SigOutTime = Param7D:Param7C
00851 016E 138B 	Copy7CToSig_1	bcf	INTCON,GIE
00852 016F 1B8B 		btfsc	INTCON,GIE
00853 0170 33FD 		bra	Copy7CToSig_1
00854 0171 087C 		MOVF	Param7C,W
00855 0172 00F0 		MOVWF	SigOutTime
00856 0173 087D 		MOVF	Param7D,W
00857 0174 00F1 		MOVWF	SigOutTimeH
00858 0175 178B 		bsf	INTCON,GIE
00859 0176 	;
00860 0176 0008 		RETURN
00861 0177 	;
00862 0177 	;=========================================================================
00863 0177 	;
00864 0177 1EF2 	CopyTempToPos	btfss	SMRevFlag
00865 0178 321B 		bra	CopyTempToPos1
00866 0179 321F 		bra	CopyTempToPos2
00867 017A 	;
00868 017A 1EF2 	CopyPosToTemp	btfss	SMRevFlag
00869 017B 320E 		bra	CopyPos1ToTemp
00870 017C 3212 		bra	CopyPos2ToTemp
00871 017D 	;
00872 017D 1EF2 	CopyPosToDest	btfss	SMRevFlag
00873 017E 3201 		bra	CopyPos1ToDest
00874 017F 3205 		bra	CopyPos2ToDest
00875 0180 	;
00876 0180 	;====================================
00877 0180 	;
RocketServo.asm                                                       Page: 10
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00878 0180 0835 	CopyPos1ToDest	movf	Position1+1,W
00879 0181 00B1 		movwf	Dest+1
00880 0182 0834 		movf	Position1,W
00881 0183 00B0 		movwf	Dest
00882 0184 0008 		return
00883 0185 	;
00884 0185 	;=====================================
00885 0185 	;
00886 0185 0837 	CopyPos2ToDest	movf	Position2+1,W
00887 0186 00B1 		movwf	Dest+1
00888 0187 0836 		movf	Position2,W
00889 0188 00B0 		movwf	Dest
00890 0189 0008 		return
00891 018A 	;
00892 018A 	;====================================
00893 018A 	;
00894 018A 0835 	CopyPos1ToTemp	movf	Position1+1,W
00895 018B 00FD 		movwf	Param7D
00896 018C 0834 		movf	Position1,W
00897 018D 00FC 		movwf	Param7C
00898 018E 0008 		return
00899 018F 	;
00900 018F 	;=====================================
00901 018F 	;
00902 018F 0837 	CopyPos2ToTemp	movf	Position2+1,W
00903 0190 00FD 		movwf	Param7D
00904 0191 0836 		movf	Position2,W
00905 0192 00FC 		movwf	Param7C
00906 0193 0008 		return
00907 0194 	;
00908 0194 	;=====================================
00909 0194 	;
00910 0194 087D 	CopyTempToPos1	movf	Param7D,W
00911 0195 00B5 		movwf	Position1+1
00912 0196 087C 		movf	Param7C,W
00913 0197 00B4 		movwf	Position1
00914 0198 0008 		return
00915 0199 	;
00916 0199 087D 	CopyTempToPos2	movf	Param7D,W
00917 019A 00B7 		movwf	Position2+1
00918 019B 087C 		movf	Param7C,W
00919 019C 00B6 		movwf	Position2
00920 019D 0008 		return
00921 019E 	;
00922 019E 	;=========================================================================================
00923 019E 	;=========================================================================================
00924 019E 	; Setup or Read AN0
00925 019E 	; Exit: 10bit analog in 7D:7C
00926 019E 	;
00927 019E 01FC 	ReadAN0	CLRF	Param7C
00928 019F 01FD 		CLRF	Param7D
00929 01A0 0021 		MOVLB	1	;bank 1
00930 01A1 1C1D 		BTFSS	ADCON0,ADON	;Is the Analog input ON?
00931 01A2 29AC 		GOTO	ReadAN0_ColdStart	; No, go start it
00932 01A3 189D 	ReadAN0_L1	BTFSC	ADCON0,NOT_DONE	;Conversion done?
00933 01A4 33FE 		BRA	ReadAN0_L1	; No
00934 01A5 081C 		MOVF	ADRESH,W
00935 01A6 00FD 		MOVWF	Param7D
00936 01A7 081B 		MOVF	ADRESL,W
00937 01A8 00FC 		MOVWF	Param7C
00938 01A9 149D 		BSF	ADCON0,ADGO	;Start next conversion.
00939 01AA 0020 		MOVLB	0	;bank 0
00940 01AB 0008 		RETURN
00941 01AC 	;
00942 01AC 0021 	ReadAN0_ColdStart	MOVLB	1	;bank 1
00943 01AD 30A0 		MOVLW	0xA0	;Right Just fosc/32
00944 01AE 009E 		MOVWF	ADCON1
00945 01AF 3001 		MOVLW	b'00000001'	;Select AN0
00946 01B0 009D 		MOVWF	ADCON0
00947 01B1 149D 		BSF	ADCON0,GO
00948 01B2 0020 	ReadAN0_Rtn	MOVLB	0	;bank 0
00949 01B3 0008 		Return
00950 01B4 	;
00951 01B4 	;=========================================================================================
00952 01B4 	;=========================================================================================
00953 01B4 	; Set CCP1 to go high is 0x100 clocks
00954 01B4 	;
00955 01B4 0020 	StartServo	MOVLB	0	;bank 0
00956 01B5 1E72 		BTFSS	ServoOff
00957 01B6 0008 		RETURN
00958 01B7 1272 		BCF	ServoOff
00959 01B8 	;
00960 01B8 08AE 	SS_Start_Loop	movf	Timer4Lo,F
00961 01B9 		SKPZ
00961 01B9 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00962 01BA 33FD 		bra	SS_Start_Loop
00963 01BB 	;
00964 01BB 	; Initialize to normal position
00965 01BB 0020 	SS_CmdNormal	movlb	0	;Bank 0
00966 01BC 12F2 		bcf	SMRevFlag
00967 01BD 1172 		bcf	LED2Flag
00968 01BE 	;
00969 01BE 217D 	SS_Move_It	call	CopyPosToDest
00970 01BF 21DE 		call	SetDestAsCur
00971 01C0 2166 		CALL	Copy7CToSig
00972 01C1 	;
00973 01C1 3000 		MOVLW	0x00	;start in 0x100 clocks
00974 01C2 0096 		MOVWF	TMR1L
00975 01C3 30FF 		MOVLW	0xFF
RocketServo.asm                                                       Page: 11
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00976 01C4 0097 		MOVWF	TMR1H
00977 01C5 	;
00978 01C5 0025 		MOVLB	0x05                   ;Bank 5
00979 01C6 0192 		CLRF	CCPR1H
00980 01C7 0191 		CLRF	CCPR1L
00981 01C8 3008 		MOVLW	CCP1CON_Set
00982 01C9 0093 		MOVWF	CCP1CON	;go high on match
00983 01CA 0020 		MOVLB	0x00	;Bank 0
00984 01CB 302C 		movlw	low .300	;Do nothing for 3 seconds
00985 01CC 00AE 		movwf	Timer4Lo
00986 01CD 3001 		movlw	high .300
00987 01CE 00AF 		movwf	Timer4Hi
00988 01CF 302C 		movlw	Low ServoMoveTime	;At power up move to commanded position
00989 01D0 00AA 		movwf	Timer2Lo
00990 01D1 3001 		movlw	High ServoMoveTime
00991 01D2 00AB 		movwf	Timer2Hi
00992 01D3 1138 		bcf	InPosition
00993 01D4 0008 		RETURN
00994 01D5 	;
00995 01D5 	;=========================================================================================
00996 01D5 	;
00997 01D5 30B8 	SetMiddlePosition	MOVLW	LOW kMidPulseWidth
00998 01D6 00FC 		MOVWF	Param7C
00999 01D7 00B0 		movwf	Dest
01000 01D8 00B2 		movwf	CurPos
01001 01D9 300B 		MOVLW	HIGH kMidPulseWidth
01002 01DA 00FD 		MOVWF	Param7D
01003 01DB 00B1 		movwf	Dest+1
01004 01DC 00B3 		movwf	CurPos+1
01005 01DD 0008 		Return
01006 01DE 	;
01007 01DE 	;=========================================================================================
01008 01DE 	;
01009 01DE 0830 	SetDestAsCur	movf	Dest,W
01010 01DF 00FC 		MOVWF	Param7C
01011 01E0 00B2 		movwf	CurPos
01012 01E1 0831 		movf	Dest+1,W
01013 01E2 00FD 		MOVWF	Param7D
01014 01E3 00B3 		movwf	CurPos+1
01015 01E4 0008 		Return
01016 01E5 	;
01017 01E5 	;=========================================================================================
01018 01E5 	; ClampInt(Param7D:Param7C,kMinPulseWidth,kMaxPulseWidth)
01019 01E5 	;
01020 01E5 	; Entry: Param7D:Param7C
01021 01E5 	; Exit: Param7D:Param7C=ClampInt(Param7D:Param7C,kMinPulseWidth,kMaxPulseWidth)
01022 01E5 	;
01023 01E5 3013 	ClampInt	MOVLW	high kMaxPulseWidth
01024 01E6 027D 		SUBWF	Param7D,W	;7D-kMaxPulseWidth
01025 01E7 		SKPNB		;7D<Max?
01025 01E7 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
01026 01E8 29F2 		GOTO	ClampInt_1	; Yes
01027 01E9 		SKPZ		;7D=Max?
01027 01E9 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
01028 01EA 2A01 		GOTO	ClampInt_tooHigh	; No, its greater.
01029 01EB 3088 		MOVLW	low kMaxPulseWidth	; Yes, MSB was equal check LSB
01030 01EC 027C 		SUBWF	Param7C,W	;7C-kMaxPulseWidth
01031 01ED 		SKPNZ		;=kMaxPulseWidth
01031 01ED 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
01032 01EE 0008 		RETURN		;Yes
01033 01EF 		SKPB		;7C<Max?
01033 01EF 1803      M		BTFSC	STATUS,C		BTFSC	STATUS,C
01034 01F0 2A01 		GOTO	ClampInt_tooHigh	; No
01035 01F1 0008 		RETURN		; Yes
01036 01F2 	;
01037 01F2 3003 	ClampInt_1	MOVLW	high kMinPulseWidth
01038 01F3 027D 		SUBWF	Param7D,W	;7D-kMinPulseWidth
01039 01F4 		SKPNB		;7D<Min?
01039 01F4 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
01040 01F5 29FC 		GOTO	ClampInt_tooLow	; Yes
01041 01F6 		SKPZ		;=Min?
01041 01F6 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
01042 01F7 0008 		RETURN		; No, 7D>kMinPulseWidth
01043 01F8 30E8 		MOVLW	low kMinPulseWidth	; Yes, MSB is a match
01044 01F9 027C 		SUBWF	Param7C,W	;7C-kMinPulseWidth
01045 01FA 		SKPB		;7C>=Min?
01045 01FA 1803      M		BTFSC	STATUS,C		BTFSC	STATUS,C
01046 01FB 0008 		RETURN		; Yes
01047 01FC 	;
01048 01FC 30E8 	ClampInt_tooLow	MOVLW	low kMinPulseWidth
01049 01FD 00FC 		MOVWF	Param7C
01050 01FE 3003 		MOVLW	high kMinPulseWidth
01051 01FF 00FD 		MOVWF	Param7D
01052 0200 0008 		RETURN
01053 0201 	;
01054 0201 3088 	ClampInt_tooHigh	MOVLW	low kMaxPulseWidth
01055 0202 00FC 		MOVWF	Param7C
01056 0203 3013 		MOVLW	high kMaxPulseWidth
01057 0204 00FD 		MOVWF	Param7D
01058 0205 0008 		RETURN
01059 0206 	;
01060 0206 	;=====================================================================================
01061 0206 	; Less or Equal
01062 0206 	;
01063 0206 	; Entry: Param7D:Param7C, Param79:Param78
01064 0206 	; Exit: Param77:0=Param7D:Param7C<=Param79:Param78
01065 0206 	;
01066 0206 01F7 	Param7D_LE_Param79	CLRF	Param77	;default to >
01067 0207 0879 		MOVF	Param79,W
RocketServo.asm                                                       Page: 12
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

01068 0208 027D 		SUBWF	Param7D,W	;Param7D-Param79
01069 0209 		SKPNB		;Param7D<Param79?
01069 0209 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
01070 020A 2A13 		GOTO	SetTrue	; Yes
01071 020B 		SKPZ		;Param7D>Param79?
01071 020B 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
01072 020C 0008 		RETURN		; Yes
01073 020D 0878 		MOVF	Param78,W	; No, MSB is a match
01074 020E 027C 		SUBWF	Param7C,W	;Param7C-Param78
01075 020F 		SKPNB		;Param7C<Param78?
01075 020F 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
01076 0210 2A13 		GOTO	SetTrue	; Yes
01077 0211 		SKPZ		;LSBs then same?
01077 0211 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
01078 0212 0008 		RETURN		; No
01079 0213 	;
01080 0213 1477 	SetTrue	BSF	Param77,0
01081 0214 0008 		RETURN
01082 0215 	;
01083 0215 		if oldCode
01182 0215 		endif
01183 0215 	;=============================================================================================
01184 0215 	;==============================================================================================
01185 0215 	;
01186 0215 		include	F1822_Common.inc
00001 0215 	;=========================================================================================
00002 0215 	; Commonly used routines PIC16F1822 version
00003 0215 	;
00004 0215 	;    Filename:      F1822 Common.inc
00005 0215 	;    Date:          9/4/2014
00006 0215 	;    File Version:  1.0.1
00007 0215 	;
00008 0215 	;    Author:        David M. Flynn
00009 0215 	;    Company:       Oxford V.U.E., Inc.
00010 0215 	;    E-Mail:        dflynn@oxfordvue.com
00011 0215 	;    Web Site:      http://www.oxfordvue.com/
00012 0215 	;
00013 0215 	;=========================================================================================
00014 0215 	;    History:
00015 0215 	;
00016 0215 	; 1.0.1 9/4/2014	Updated from F1847 Common.inc
00017 0215 	; 1.0   11/16/2013	Updated from F648A Common.inc
00018 0215 	;
00019 0215 	;=========================================================================================
00020 0215 	; Routines:
00021 0215 	;
00022 0215 	; ClearRam	(2+0) Clears all RAM, call once before initializing variables, FSR0
00023 0215 	; CopyToRam	(1+0) copy param memory (EEPROM) to ram, call once, FSR0
00024 0215 	; SaveParams	(1+0) copy ram to param memory (EEPROM), FSR0
00025 0215 	; TX_TheByte	(0+0) Send one byte to UART
00026 0215 	; RX_TheByte	(0+0) Receive one byte from UART
00027 0215 	;
00028 0215 	; DecTimer4	(0+0) Decrement routine for 16 bit timers, FSR0
00029 0215 	; DecTimer3
00030 0215 	; DecTimer2
00031 0215 	; DecTimer1
00032 0215 	;
00033 0215 	; TestT4_Zero	Test for 16 bit timers = zero
00034 0215 	; TestT3_Zero	If Timer is zero return Z flag,1 else Z=0
00035 0215 	; TestT2_Zero
00036 0215 	; TestT1_Zero
00037 0215 	;
00038 0215 	; Delay10uS	(0+0)Delay uS    1 cycle = 1uS, 8Mhz clock version
00039 0215 	; Delay100uS
00040 0215 	; Delay40uS
00041 0215 	; DelayWuS
00042 0215 	;
00043 0215 	; EEReadW	(0+0) Read EEPROM address in W
00044 0215 	; EERead	(0+0) Read EEPROM address in EEAddrTemp
00045 0215 	; EEWriteW	(0+0) Write EEPROM address in W, Data in EEDataTemp
00046 0215 	; EEWrite	(0+0) Write EEPROM address in EEAdrTemp, Data in EEDataTemp, FSR0
00047 0215 	;
00048 0215 	; StoreSerIn	Put the byte in W into the serial input buffer, FSR0
00049 0215 	; GetSerIn	Get a byte from the serial input buffer, FSR0
00050 0215 	; GetSerOutBytes	Get the number of bytes in the serial ouput buffer
00051 0215 	; StoreSerOut	Put the byte in W into the serial output buffer, FSR0
00052 0215 	; POP_SerOut	Remove the last char stored in the output buffer
00053 0215 	; GetSerOut	Get a byte from the serial Output buffer, FSR0
00054 0215 	;
00055 0215 	;=========================================================================================
00056 0215 	; Clears all RAM
00057 0215 	; Entry: none
00058 0215 	; Exit: none
00059 0215 	; RAM used: All
00060 0215 	; Calls:(2+0) ClearRam_L2
00061 0215 	;
00062 0215 0020 	ClearRam	MOVLB	0x00
00063 0216 305F 		MOVLW	0x5F	;Clear 20h-7Eh, 95 bytes
00064 0217 00FF 		MOVWF	Param7F
00065 0218 3020 		MOVLW	0x20
00066 0219 0084 		MOVWF	FSR0
00067 021A 0185 		CLRF	FSR0H
00068 021B 2220 		CALL	ClearRam_L2
00069 021C 	;
00070 021C 3020 		MOVLW	0x20	;Clear A0h-BFh, 32 bytes
00071 021D 00FF 		MOVWF	Param7F
00072 021E 30A0 		MOVLW	0xA0
00073 021F 0084 		MOVWF	FSR0
00074 0220 	;
RocketServo.asm                                                       Page: 13
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00075 0220 0180 	ClearRam_L2	CLRF	INDF0
00076 0221 0A84 		INCF	FSR0,F
00077 0222 0BFF 		DECFSZ	Param7F,F
00078 0223 2A20 		GOTO	ClearRam_L2
00079 0224 0008 		RETURN
00080 0225 	;
00081 0225 	;==========================================================================
00082 0225 	; copy param memory to ram
00083 0225 	;
00084 0225 	CopyToRam:
00085 0225 0020  a		MOVLB	EEAddrTemp	;banksel
00084 0226 		BankSel	EEAddrTemp
00086 0226 3000 		MOVLW	nvFirstParamByte
00087 0227 00A6 		MOVWF	EEAddrTemp
00088 0228 3034 		MOVLW	FirstRAMParam
00089 0229 0084 		MOVWF	FSR0
00090 022A 0185 		CLRF	FSR0H
00091 022B 226D 	CopyToRam_L1	CALL	EERead
00092 022C 0080 		MOVWF	INDF0
00093 022D 3038 		MOVLW	LastRAMParam
00094 022E 0204 		SUBWF	FSR0,W
00095 022F 		SKPNZ
00095 022F 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00096 0230 0008 		RETURN
00097 0231 0A84 		INCF	FSR0,F
00098 0232 0AA6 		INCF	EEAddrTemp,F
00099 0233 2A2B 		GOTO	CopyToRam_L1
00100 0234 	;
00101 0234 	;===========================================================================
00102 0234 	; copy ram to param memory
00103 0234 	;
00104 0234 	SaveParams:
00105 0234 0020  a		MOVLB	EEAddrTemp	;banksel
00104 0235 		BankSel	EEAddrTemp
00106 0235 3000 		MOVLW	nvFirstParamByte
00107 0236 00A6 		MOVWF	EEAddrTemp
00108 0237 3034 		MOVLW	FirstRAMParam
00109 0238 0084 		MOVWF	FSR0
00110 0239 0185 		CLRF	FSR0H
00111 023A 0800 	SaveParams_L1	MOVF	INDF0,W
00112 023B 00A7 		MOVWF	EEDataTemp
00113 023C 2277 		CALL	EEWrite
00114 023D 3038 		MOVLW	LastRAMParam	;last byte
00115 023E 0204 		SUBWF	FSR0,W
00116 023F 		SKPNZ
00116 023F 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00117 0240 0008 		RETURN
00118 0241 0A84 		INCF	FSR0,F
00119 0242 0AA6 		INCF	EEAddrTemp,F
00120 0243 2A3A 		GOTO	SaveParams_L1
00121 0244 	;
00122 0244 	;=====================================================================================================
00123 0244 	;=========================================================================================================
00124 0244 	; Decrement routine for 16 bit timers
00125 0244 	;
00126 0244 302F 	DecTimer4	movlw	Timer4Hi
00127 0245 2A4B 		goto	DecTimer
00128 0246 302D 	DecTimer3	movlw	Timer3Hi
00129 0247 2A4B 		goto	DecTimer
00130 0248 302B 	DecTimer2	movlw	Timer2Hi
00131 0249 2A4B 		goto	DecTimer
00132 024A 3029 	DecTimer1	movlw	Timer1Hi
00133 024B 	;DecTimer
00134 024B 	; entry: FSR=Timer(n)Hi
00135 024B 0084 	DecTimer	MOVWF	FSR0L
00136 024C 0185 		CLRF	FSR0H	;Timers must be in bank 0
00137 024D 0013 		moviw	FSR0--	;TimerNHi
00138 024E 0400 		IORWF	INDF0,W	;TimerNLo
00139 024F 		SKPNZ
00139 024F 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00140 0250 0008 		RETURN
00141 0251 3001 		MOVLW	0x01
00142 0252 0280 		SUBWF	INDF0,F	;TimerNLo
00143 0253 0A84 		INCF	FSR0L,F
00144 0254 3000 		MOVLW	0x00
00145 0255 3B80 		SUBWFB	INDF0,F	;TimerNHi
00146 0256 0008 		RETURN
00147 0257 	;
00148 0257 	;==============================================================================================
00149 0257 	; Test for 16 bit timers = zero
00150 0257 	;If Timer is zero return Z flag,1 else Z=0
00151 0257 	;
00152 0257 082E 	TestT4_Zero	movf	Timer4Lo,W
00153 0258 042F 		iorwf	Timer4Hi,W
00154 0259 0008 		return
00155 025A 	;
00156 025A 082C 	TestT3_Zero	movf	Timer3Lo,W
00157 025B 042D 		iorwf	Timer3Hi,W
00158 025C 0008 		return
00159 025D 	;
00160 025D 082A 	TestT2_Zero	movf	Timer2Lo,W
00161 025E 042B 		iorwf	Timer2Hi,W
00162 025F 0008 		return
00163 0260 	;
00164 0260 0828 	TestT1_Zero	movf	Timer1Lo,W
00165 0261 0429 		iorwf	Timer1Hi,W
00166 0262 0008 		return
00167 0263 	;
00168 0263 	;======================================================================================
RocketServo.asm                                                       Page: 14
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

00169 0263 	;Delay uS    1 cycle = 1uS, 8Mhz clock version
00170 0263 	; RAM used: Param77
00171 0263 	; Calls:(0) none
00172 0263 3005 	Delay10uS	MOVLW	0x05	;(2*3+5)/2=10
00173 0264 2A68 		GOTO	DelayWuS
00174 0265 3041 	Delay100uS	MOVLW	d'65'	;(28*3+5)/2=100
00175 0266 2A68 		GOTO	DelayWuS
00176 0267 3019 	Delay40uS	MOVLW	d'25'	;(11*3+5)=40
00177 0268 00F7 	DelayWuS	MOVWF	Param77
00178 0269 0BF7 	DelayWuS_Loop	DECFSZ	Param77,F
00179 026A 2A69 		GOTO	DelayWuS_Loop
00180 026B 0008 		RETURN
00181 026C 	;
00182 026C 	;==============================================================================================
00183 026C 	; Read EEPROM
00184 026C 	; entry: EEPROM address to read in W
00185 026C 	;        Bank 0 selected
00186 026C 	; exit: W=EEDATA, Bank 0 selected
00187 026C 	;
00188 026C 00A6 	EEReadW	movwf	EEAddrTemp
00189 026D 	;
00190 026D 	;==============================================================================================
00191 026D 	; Read EEPROM
00192 026D 	; entry: EEPROM address to read in EEAddrTemp
00193 026D 	;        Bank 0 selected
00194 026D 	; exit: W=EEDATA, Bank 0 selected
00195 026D 	;
00196 026D 0826 	EERead	MOVF	EEAddrTemp,W	;Data Memory
00197 026E 0023  a		MOVLB	EEADRL	;banksel
00196 026F 		BANKSEL	EEADRL
00198 026F 0091 		MOVWF	EEADRL	;Address to read
00199 0270 	;
00200 0270 1315 		BCF	EECON1,CFGS	;Deselect Config space
00201 0271 1395 		BCF	EECON1,EEPGD	;Point to DATA memory
00202 0272 1415 		BSF	EECON1,RD	;EE Read
00203 0273 0813 		MOVF	EEDATL,W	;W = EEDATL
00204 0274 0020 		MOVLB	0x00	;Bank 0
00205 0275 0008 		return
00206 0276 	;
00207 0276 	;==============================================================================================
00208 0276 	; Write EEPROM
00209 0276 	; entry: EEPROM address to write in W
00210 0276 	;        EEPROM data to write in EEDataTemp
00211 0276 	;        Bank 0 selected
00212 0276 	; exit: Bank 0 selected
00213 0276 	;
00214 0276 00A6 	EEWriteW	movwf	EEAddrTemp
00215 0277 	;
00216 0277 	;==============================================================================================
00217 0277 	; Write EEPROM
00218 0277 	; entry: EEPROM address to write in EEAdrTemp
00219 0277 	;        EEPROM data to write in EEDataTemp
00220 0277 	;        Bank 0 selected
00221 0277 	; exit: Bank 0 selected
00222 0277 	;
00223 0277 0826 	EEWrite	MOVF	EEAddrTemp,W
00224 0278 0023  a		MOVLB	EEADRL	;banksel
00223 0279 		BANKSEL	EEADRL
00225 0279 0091 		MOVWF	EEADRL	;Data Memory Address to write
00226 027A 0020  a		MOVLB	EEDataTemp	;banksel
00225 027B 		BankSel	EEDataTemp
00227 027B 0827 		MOVF	EEDataTemp,W
00228 027C 0023  a		MOVLB	EEDATL	;banksel
00227 027D 		BANKSEL	EEDATL
00229 027D 0093 		MOVWF	EEDATL	;Data Memory Value to write
00230 027E 1315 		BCF	EECON1,CFGS	;Deselect Configuration space
00231 027F 1395 		BCF	EECON1,EEPGD	;Point to DATA memory
00232 0280 138B 		BCF	INTCON,GIE	;Disable INTs.
00233 0281 1515 		BSF	EECON1,WREN	;Enable writes
00234 0282 3055 		MOVLW	0x55
00235 0283 0096 		MOVWF	EECON2	;Write 55h
00236 0284 30AA 		MOVLW	0xAA
00237 0285 0096 		MOVWF	EECON2	;Write AAh
00238 0286 1495 		BSF	EECON1,WR	;Set WR bit to begin write
00239 0287 178B 		BSF	INTCON,GIE	;Enable Interrupts
00240 0288 1115 		BCF	EECON1,WREN	;Disable writes
00241 0289 1895 	EEWriteLoop	BTFSC	EECON1,WR	;Wait for write to complete
00242 028A 2A89 		GOTO	EEWriteLoop
00243 028B 0020 		MOVLB	0x00	;Bank 0
00244 028C 0008 		return
00245 028D 	;
00246 028D 	;=========================================================================================================
00247 028D 		IF useRS232
00396 028D 		ENDIF
00397 028D 	;
00398 028D 	;
00399 028D 	;
01187 028D 	;
01188 028D 	;=========================================================================================
01189 028D 	;=========================================================================================
01190 028D 	;
01191 028D 	;
01192 028D 	;
01193 028D 	;
01194 028D 		END

X-Ref Table
ADCON0	009D 	ReadAN0, ReadAN0_L1, ReadAN0_ColdStart
ADCON1	009E 	ReadAN0_ColdStart
RocketServo.asm   X-Ref Table                                            Page: 15
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

ADGO	0001 	ReadAN0_L1
ADON	0000 	ReadAN0
ADRESH	009C 	ReadAN0_L1
ADRESL	009B 	ReadAN0_L1
ANSELA	018C 	start
APFCON	011D 	start
ActivationTime	012C 	HomeServo, ML_Btns_End
BVBad ^	00A4 	start
BattV_OK	SysFlags,3	start, Start_L1
BlinkError ^	00BA 	Start_L1
BtnChangeRate	0002 	ML_Btns_Inc, ML_Btns_Dec
C	0000 	start, ClampInt, ClampInt_1, Param7D_LE_Param79
CCP1CON	0293 	IRQ_2, IRQ_Servo1_1, IRQ_Servo1_OL, start, SS_Start_Loop
CCP1CON_Clr	0009 	IRQ_Servo1_1
CCP1CON_Int	000A 	IRQ_Servo1_1, IRQ_Servo1_OL
CCP1CON_Set	0008 	IRQ_Servo1_OL, SS_Start_Loop
CCP1IE	0002 	start
CCP1IF	0002 	IRQ_2, IRQ_Servo1_X
CCP1M0	0000 	IRQ_Servo1_1
CCP1SEL	0000 	start
CCPR1H	0292 	IRQ_Servo1_1, IRQ_Servo1_OL, SS_Start_Loop
CCPR1L	0291 	IRQ_Servo1_1, IRQ_Servo1_OL, SS_Start_Loop
CFGS	0006 	EERead, EEWrite
CalcdDwell	0075 	IRQ_Servo1_1
CalcdDwellH	0076 	IRQ_Servo1_1
ClampInt ^	01E5 	ML_Btns_Inc, ML_Btns_Dec
ClampInt_1 ^	01F2 	ClampInt
ClampInt_tooHigh ^	0201 	ClampInt
ClampInt_tooLow ^	01FC 	ClampInt_1
ClearRam ^	0215 	start
ClearRam_L2 ^	0220 	ClearRam, ClearRam_L2
CmdInputBit	PORTA,3	ML_Btns_End
ContEnable	LATA,1	start, Start_L1
Copy7CToSig ^	0166 	Move_It_Now, SS_Start_Loop
Copy7CToSig_1 ^	016E 	Copy7CToSig, Copy7CToSig_1
CopyPos1ToDest ^	0180 	CopyPosToDest
CopyPos1ToTemp ^	018A 	CopyPosToTemp
CopyPos2ToDest ^	0185 	CopyPosToDest
CopyPos2ToTemp ^	018F 	CopyPosToTemp
CopyPosToDest ^	017D 	Move_It, SS_Start_Loop
CopyPosToTemp ^	017A 	ML_Btns_Inc, ML_Btns_Dec
CopyTempToPos ^	0177 	ML_Btns_Inc, ML_Btns_Dec
CopyTempToPos1 ^	0194 	CopyTempToPos
CopyTempToPos2 ^	0199 	CopyTempToPos
CopyToRam ^	0225 	start
CopyToRam_L1 ^	022B 	CopyToRam_L1
CurPos	0032 	Set_Dest_End, Move_It_NIP, Move_It_New, Move_It_Dest, Move_It_Now, SS_Start_Loop
		SetDestAsCur
DataChangedFlag	Flags,3	MainLoop, ML_Btns_Inc, ML_Btns_Dec, ML_Btns_Save
Debounce	0039 	ML_Btns_End, Rev_Debounce, ML_CmdNormal, Norm_Debounce
DecBtnBit	PORTA,4	
DecBtnFlag	Flags,1	, MainLoop, ML_Btns_Dec
DecTimer ^	024B 	DecTimer4, DecTimer3, DecTimer2
DecTimer1 ^	024A 	
DecTimer2 ^	0248 	
DecTimer3 ^	0246 	
DecTimer4 ^	0244 	
DelayWuS ^	0268 	DecTimer
DelayWuS_Loop ^	0269 	DelayWuS_Loop
Delay_1S ^	00CD 	Start_L1
Delay_L1 ^	00CF 	Delay_L1
Dest	0030 	MainLoop, Set_Dest_End, Move_It_NIP, Move_It_Dest, CopyPos1ToDest, CopyPos2ToDest
		SS_Start_Loop, SetDestAsCur
EEADRL	0191 	EERead, EEWrite
EEAddrTemp	0026 	CopyToRam, CopyToRam_L1, SaveParams, SaveParams_L1, DelayWuS_Loop
		EERead, EEWrite
EECON1	0195 	EERead, EEWrite, EEWriteLoop
EECON2	0196 	EEWrite
EEDATL	0193 	EERead, EEWrite
EEDataTemp	0027 	SaveParams_L1, EEWrite
EEPGD	0007 	EERead, EEWrite
EERead ^	026D 	CopyToRam_L1
EEWrite ^	0277 	SaveParams_L1
EEWriteLoop ^	0289 	EEWriteLoop
F	0001 	, SystemBlink_Blinking, SystemBlink_end, IRQ_Servo1_1, IRQ_Servo1_OL, start
		BVBad, ML_Btns_Inc, ML_Btns_Dec, Rev_Debounce, ML_CmdNormal, Norm_Debounce, Set_Dest_End
		Move_It_NIP, Move_It_Neg, SS_Start_Loop, ClearRam_L2, CopyToRam_L1, SaveParams_L1
		DecTimer, DelayWuS_Loop
FSR0	0004 	ClearRam, ClearRam_L2, CopyToRam, CopyToRam_L1, SaveParams, SaveParams_L1
FSR0H	0005 	, ClearRam, CopyToRam, SaveParams, DecTimer
FSR0L	0004 	DecTimer
FirstRAMParam	Position1	CopyToRam, SaveParams
Flags	0072 	, SystemBlink_end, IRQ_2, start, HomeServo, MainLoop, ML_Btns_Inc, ML_Btns_Dec
		ML_Btns_Save, ML_Btns_End, ML_CmdNormal, CopyTempToPos, CopyPosToTemp, CopyPosToDest
		StartServo, SS_Start_Loop
GIE	0007 	start, Copy7CToSig_1, EEWrite
GO	0001 	ReadAN0_ColdStart
HasBattV	0001 	start
HoldOpen	0001 	ML_CmdNormal
HomeServo ^	00D4 	Start_Err
INDF0	0000 	ClearRam_L2, CopyToRam_L1, SaveParams_L1, DecTimer
INTCON	000B 	start, Copy7CToSig_1, EEWrite
IRQ_2 ^	002F 	
IRQ_Servo1_1 ^	0038 	IRQ_2
IRQ_Servo1_End ^	005E 	IRQ_2
IRQ_Servo1_OL ^	0050 	IRQ_Servo1_1
IRQ_Servo1_X ^	005C 	IRQ_2, IRQ_Servo1_1
InPosShutdown	SysFlags,1	IRQ_Servo1_1, IRQ_Servo1_OL
InPosition	SysFlags,2	IRQ_Servo1_1, IRQ_Servo1_OL, Set_Dest_End, Move_It_NIP, SS_Start_Loop
RocketServo.asm   X-Ref Table                                            Page: 16
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

IncBtnBit	PORTA,2	
IncBtnFlag	Flags,0	, MainLoop
LATA	010C 	start, Start_L1
LED2Flag	Flags,2	SystemBlink_end, HomeServo, ML_Btns_End, ML_CmdNormal, SS_Start_Loop
LED2TrisBit	TRISA,2	, SystemBlink_end
LED2_End ^	002E 	SystemBlink_end
LED2_Ticks	0024 	SystemBlink_end
LED2_Time	0022 	SystemBlink_end, start
LEDErrorTime	000A 	BlinkError
LEDTIME	0064 	start, Start_1
LED_Blinks	0025 	, SystemBlink_Blinking, BVBad, Start_L1, BlinkError, Start_1, LongFlash
		LongFlash_L1
LED_Ticks	0023 	
LED_Time	0021 	, start, BVBad, BlinkError, Start_1, LongFlash
LastRAMParam	SysFlags	CopyToRam_L1, SaveParams_L1
LongFlash ^	00C6 	start, Start_L1
LongFlash_L1 ^	00CA 	LongFlash_L1
ML_Btns_Dec ^	00F7 	MainLoop
ML_Btns_End ^	0107 	MainLoop, ML_Btns_Inc, ML_Btns_Dec
ML_Btns_Inc ^	00EC 	MainLoop
ML_Btns_Save ^	0104 	ML_Btns_Dec
ML_CmdNormal ^	011A 	ML_Btns_End
MainLoop ^	00DC 	Start_Err, Move_End
MinBattVolts	0041 	start
Move_End ^	0165 	Set_Dest_End
Move_It ^	0126 	ML_Btns_End, ML_CmdNormal
Move_It_Dest ^	015C 	Move_It_NIP, Move_It_Neg
Move_It_NIP ^	0138 	Set_Dest_End
Move_It_Neg ^	0154 	Move_It_NIP
Move_It_New ^	014F 	Move_It_Neg
Move_It_Now ^	0160 	Set_Dest_End, Move_It_New
NOT_DONE	0001 	ReadAN0_L1
NOT_WPUEN	0007 	start
NewSWData	Flags,6	, ML_Btns_End
Norm_Debounce ^	0124 	ML_CmdNormal
OPTION_REG	0095 	start
OSCCON	0099 	start
OSCCON_Value	0072 	start
PCLATH	000A 	
PEIE	0006 	start
PIE1	0091 	start
PIR1	0011 	, IRQ_2, IRQ_Servo1_X
PORTA	000C 	, start, ML_Btns_End
PR2	001B 	start
PR2_Value	007D 	start
PS0	0000 	start
PS1	0001 	start
PS2	0002 	start
PSA	0003 	start
Param77	0077 	Move_It_NIP, Move_It_Neg, Param7D_LE_Param79, SetTrue, DelayWuS, DelayWuS_Loop
Param78	0078 	Set_Dest_End, Move_It_NIP, Param7D_LE_Param79
Param79	0079 	Move_It_NIP, Param7D_LE_Param79
Param7C	007C 	start, BVBad, ML_Btns_Inc, ML_Btns_Dec, Move_It_NIP, Move_It_New, Move_It_Neg
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToTemp, CopyPos2ToTemp, CopyTempToPos1
		CopyTempToPos2, ReadAN0, ReadAN0_L1, SS_Start_Loop, SetDestAsCur, ClampInt, ClampInt_1
		ClampInt_tooLow, ClampInt_tooHigh, Param7D_LE_Param79
Param7D	007D 	start, BVBad, ML_Btns_Inc, ML_Btns_Dec, Move_It_NIP, Move_It_New, Move_It_Neg
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToTemp, CopyPos2ToTemp, CopyTempToPos1
		CopyTempToPos2, ReadAN0, ReadAN0_L1, SS_Start_Loop, SetDestAsCur, ClampInt, ClampInt_1
		ClampInt_tooLow, ClampInt_tooHigh, Param7D_LE_Param79
Param7D_LE_Param79 ^	0206 	Move_It_NIP, Move_It_Neg
Param7F	007F 	ClearRam, ClearRam_L2
PortADDRBits	00DD 	start
PortAValue	0002 	start
Position1	0034 	CopyPos1ToDest, CopyPos1ToTemp, CopyTempToPos1, CopyToRam, SaveParams
Position2	0036 	CopyPos2ToDest, CopyPos2ToTemp, CopyTempToPos2
PulseSent	SysFlags,0	IRQ_2, Set_Dest_End
RD	0000 	EERead
ReadAN0 ^	019E 	start
ReadAN0_ColdStart ^	01AC 	start, ReadAN0
ReadAN0_L1 ^	01A3 	ReadAN0_L1
Rev_Debounce ^	0118 	ML_Btns_End
SMRevFlag	Flags,5	HomeServo, ML_Btns_End, CopyTempToPos, CopyPosToTemp, CopyPosToDest
		SS_Start_Loop
SS_Start_Loop ^	01B8 	SS_Start_Loop
STATUS	0003 	, start, Start_L1, LongFlash_L1, Delay_L1, MainLoop, ML_Btns_End, ML_CmdNormal
		Set_Dest_End, Copy7CToSig, SS_Start_Loop, ClampInt, ClampInt_1, Param7D_LE_Param79
		CopyToRam_L1, SaveParams_L1, DecTimer
SaveParams ^	0234 	ML_Btns_Save
SaveParams_L1 ^	023A 	SaveParams_L1
ServoMoveTime	012C 	Move_It_NIP, SS_Start_Loop
ServoOff	Flags,4	IRQ_2, start, StartServo
SetDestAsCur ^	01DE 	SS_Start_Loop
SetTrue ^	0213 	Param7D_LE_Param79
Set_Dest_End ^	0127 	MainLoop, ML_Btns_End, Rev_Debounce, Norm_Debounce
SigOutTime	0070 	IRQ_Servo1_1, Copy7CToSig, Copy7CToSig_1
SigOutTimeH	0071 	Copy7CToSig, Copy7CToSig_1
SlewChangeRate	0040 	Move_It_NIP, Move_It_Neg
StartServo ^	01B4 	Start_Err
Start_1 ^	00BF 	Start_L1
Start_Err ^	00C3 	BlinkError
Start_L1 ^	00AE 	Start_L1
SysFlags	0038 	IRQ_2, IRQ_Servo1_1, IRQ_Servo1_OL, start, Start_L1, Set_Dest_End
		Move_It_NIP, SS_Start_Loop, CopyToRam_L1, SaveParams_L1
SysLEDTrisBit	TRISA,4	, SystemBlink_on
SystemBlink_Blinking ^	0022 	
SystemBlink_end ^	0025 	
SystemBlink_on ^	0023 	
T1CON	0018 	start
RocketServo.asm   X-Ref Table                                            Page: 17
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev C/BP5 Version/

T1CON_Val	0001 	start
T1GCON	0019 	start
T2CON	001C 	start
T2CON_Value	004E 	start
TMR0CS	0005 	start
TMR1GE	0007 	start
TMR1H	0017 	SS_Start_Loop
TMR1L	0016 	SS_Start_Loop
TMR2IE	0001 	start
TMR2IF	0001 	
TRISA	008C 	, SystemBlink_on, SystemBlink_end, start
Timer1Hi	0029 	DecTimer1, DecTimer
Timer1Lo	0028 	Delay_1S, Delay_L1, DecTimer
Timer2Hi	002B 	Set_Dest_End, Move_It_NIP, SS_Start_Loop, DecTimer2, DecTimer
Timer2Lo	002A 	Set_Dest_End, Move_It_NIP, SS_Start_Loop, DecTimer
Timer3Hi	002D 	HomeServo, ML_Btns_End, ML_CmdNormal, DecTimer3, DecTimer
Timer3Lo	002C 	HomeServo, ML_Btns_End, ML_CmdNormal, DecTimer
Timer4Hi	002F 	MainLoop, SS_Start_Loop, DecTimer4, DecTimer
Timer4Lo	002E 	start, MainLoop, ML_Btns_Inc, ML_Btns_Dec, SS_Start_Loop, DecTimer
W	0000 	, SystemBlink_end, IRQ_Servo1_1, start, BVBad, Start_L1, LongFlash_L1, Delay_L1
		MainLoop, ML_Btns_End, ML_CmdNormal, Set_Dest_End, Move_It_NIP, Move_It_New, Move_It_Dest
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToDest, CopyPos2ToDest, CopyPos1ToTemp
		CopyPos2ToTemp, CopyTempToPos1, CopyTempToPos2, ReadAN0_L1, SetDestAsCur, ClampInt
		ClampInt_1, Param7D_LE_Param79, CopyToRam_L1, SaveParams_L1, DecTimer, EERead, EEWrite
WDTCON	0097 	start
WR	0001 	EEWrite, EEWriteLoop
WREN	0002 	EEWrite
Z	0002 	, start, Start_L1, LongFlash_L1, Delay_L1, MainLoop, ML_Btns_End, ML_CmdNormal
		Set_Dest_End, Copy7CToSig, SS_Start_Loop, ClampInt, ClampInt_1, Param7D_LE_Param79
		CopyToRam_L1, SaveParams_L1, DecTimer
kDefaultPosition1	1388 	EEWriteLoop
kDefaultPosition2	03E8 	EEWriteLoop
kInPosShutdown	0002 	EEWriteLoop
kMaxPulseWidth	1388 	ClampInt, ClampInt_tooHigh
kMidPulseWidth	0BB8 	MainLoop, SS_Start_Loop
kMinPulseWidth	03E8 	ClampInt_1, ClampInt_tooLow
kServoDwellTime	7D00 	IRQ_Servo1_1, IRQ_Servo1_OL
nvFirstParamByte	nvPosition1Lo	EEWriteLoop, CopyToRam, SaveParams
nvLastParamByte	nvSysFlags	EEWriteLoop
nvPosition1Hi	0001 	EEWriteLoop
nvPosition1Lo	0000 	EEWriteLoop, CopyToRam, SaveParams
nvPosition2Hi	0003 	EEWriteLoop
nvPosition2Lo	0002 	EEWriteLoop
nvSysFlags	0004 	EEWriteLoop
oldCode	0000 	ClearRam
start ^	005F 	
useRS232	0000 	EEWriteLoop
 

X-Ref Table (The UnCalled)
Delay100uS !	0265 	
Delay10uS !	0263 	
Delay40uS !	0267 	
EEReadW !	026C 	
EEWriteW !	0276 	
IRQ_Servo1 !	002F 	
ReadAN0_Rtn !	01B2 	
SS_CmdNormal !	01BB 	
SS_Move_It !	01BE 	
SetMiddlePosition !	01D5 	
SystemBlink_1 !	0018 	
TestT1_Zero !	0260 	
TestT2_Zero !	025D 	
TestT3_Zero !	025A 	
TestT4_Zero !	0257 	
 

Memory Usage Map ('X' = Used, '-' = Unused)
 
0000  : XXX-XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0280  : XXXXXXXXXXXXX--- ---------------- ---------------- ----------------
 
Program Memory Words Used:652
Program Memory Words Free:1396
 
UserID
8000  :XXXX
 
Config
8007  :XX
 
EEPROM
F000  : XXXXX----------- ---------------- ---------------- ----------------
 
Data EEPROM Bytes Used:5
Data EEPROM Bytes Free:251
