RocketServo.asm                                                       Page: 1
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00001 0000 	;====================================================================================================
00002 0000 	;
00003 0000 	;   Filename:	RocketServo.asm
00004 0000 	;   Date:	5/4/2023
00005 0000 	;   File Version:	1.1b3
00006 0000 	;
00007 0000 	;    Author:	David M. Flynn
00008 0000 	;    Company:	Oxford V.U.E., Inc.
00009 0000 	;    E-Mail:	dflynn@oxfordvue.com
00010 0000 	;    Web Site:	http://www.oxfordvue.com/
00011 0000 	;
00012 0000 	;====================================================================================================
00013 0000 	;    RC Servo Activator for high power rocketry uses PIC12F1822
00014 0000 	;
00015 0000 	;    History:
00016 0000 	; 1.1b3   8/6/2023	Added BP3Hold mode.
00017 0000 	; 1.1b2   5/4/2023	Fixed batt V blink, 10 or 11 blinks.
00018 0000 	; 1.1b1   12/28/2022	Added battery voltage sensing RA0 9.75C/V 3 for diode
00019 0000 	; 1.0b2   11/7/2022	Inverted CmdInputBit to active low
00020 0000 	; 1.0b1   8/31/2022    Copied from SM_Ctrl_RC_Servo.
00021 0000 	;
00022 0000 	;====================================================================================================
00023 0000 	; Options
00024 0000 0001 	HasBattV	EQU	1	;Set to 0 or 1
00025 0000 0000 	BP3Hold	EQU	0	;Hold at reverse value
00026 0000 	;====================================================================================================
00027 0000 	; To Do's
00028 0000 	;
00029 0000 	;====================================================================================================
00030 0000 	;====================================================================================================
00031 0000 	; What happens next:
00032 0000 	;
00033 0000 	;   The system LED blinks once per second
00034 0000 	;  Once at power-up:
00035 0000 	;   Blink battery voltage i.e. _ .........  .. _
00036 0000 	;   to do: Do not arm if <8.5V alkaline <7.5 NiMH
00037 0000 	;   Set position to the commanded position for 3 seconds.
00038 0000 	;
00039 0000 	;  Setup mode:
00040 0000 	;   If SW1 is pressed Increment the set value for the control condition.
00041 0000 	;   If SW2 is pressed Decrement the set value for the control condition.
00042 0000 	;
00043 0000 	;   If Control is High (active)
00044 0000 	;      move to set point 1 for 3 seconds
00045 0000 	;   else if Control is Low (Normal, Inactive)
00046 0000 	;      move to set point 2 for 3 seconds
00047 0000 	;
00048 0000 	;   CCP1 outputs a 900uS to 2100uS (1800..4200 counts) pulse every 16,000uS
00049 0000 	;
00050 0000 	;   Resolution is 0.5uS
00051 0000 	;
00052 0000 	;  if kInPosShutdown is set servo will power down after 3s
00053 0000 	;
00054 0000 	;====================================================================================================
00055 0000 	;
00056 0000 	;  Pin 1 VDD (+5V)		+5V
00057 0000 	;  Pin 2 RA5		CCP1
00058 0000 	;  Pin 3 RA4		System LED Active Low/SW2 Dec switch Active Low
00059 0000 	;  Pin 4 RA3/MCLR*/Vpp (Input only)	Command = Active Low
00060 0000 	;  Pin 5 RA2		LED 2 Active Low/SW1 Inc switch Active Low
00061 0000 	;  Pin 6 RA1/ICSPCLK		n/c
00062 0000 	;  Pin 7 RA0/ICSPDAT		AN0, Battery (volts-0.5)/21
00063 0000 	;  Pin 8 VSS (Ground)		Ground
00064 0000 	;
00065 0000 	;====================================================================================================
00066 0000 	;
00067 0000 	;
00068 0000 		list	p=12f1822,r=hex,w=1	; list directive to define processor
00069 0000 	;
00001 0000 		nolist
00002 0000 		nolist
00003 0000 	;==========================================================================
00004 0000 	; MPASM PIC12F1822 processor include
00005 0000 	;	
00006 0000 	; (c) Copyright 1999-2014 Microchip Technology, All rights reserved
00007 0000 	;==========================================================================
00008 0000 	;==========================================================================
01039 0000 		NOLIST
01040 0000 		NOLIST
00072 0000 		list
00073 0000 	;
00074 8007 EFA4 		__CONFIG _CONFIG1,_FOSC_INTOSC & _WDTE_OFF & _MCLRE_OFF & _IESO_OFF
00075 0000 	;
00076 0000 	;
00077 0000 	;
00078 0000 	; INTOSC oscillator: I/O function on CLKIN pin
00079 0000 	; WDT disabled
00080 0000 	; PWRT disabled
00081 0000 	; MCLR/VPP pin function is digital input
00082 0000 	; Program memory code protection is disabled
00083 0000 	; Data memory code protection is disabled
00084 0000 	; Brown-out Reset enabled
00085 0000 	; CLKOUT function is disabled. I/O or oscillator function on the CLKOUT pin
00086 0000 	; Internal/External Switchover mode is disabled
00087 0000 	; Fail-Safe Clock Monitor is enabled
00088 0000 	;
00089 8008 DEFF 		__CONFIG _CONFIG2,_WRT_OFF & _PLLEN_OFF & _LVP_OFF
00090 0000 	;
00091 0000 	; Write protection off
RocketServo.asm                                                       Page: 2
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00092 0000 	; 4x PLL disabled
00093 0000 	; Stack Overflow or Underflow will cause a Reset
00094 0000 	; Brown-out Reset Voltage (Vbor), low trip point selected.
00095 0000 	; Low-voltage programming Disabled ( allow MCLR to be digital in )
00096 0000 	;  *** must set apply Vdd before Vpp in ICD 3 settings ***
00097 0000 	;
00098 0000 	; '__CONFIG' directive is used to embed configuration data within .asm file.
00099 0000 	; The lables following the directive are located in the respective .inc file.
00100 0000 	; See respective data sheet for additional information on configuration word.
00101 0000 	;
00102 0000 		constant	oldCode=0
00103 0000 		constant	useRS232=0
00104 0000 	;
00105 0000 0003 	#Define	_C	STATUS,C
00106 0000 0003 	#Define	_Z	STATUS,Z
00107 0000 	;
00108 0000 	; 0.5uS res counter from 8MHz OSC
00109 0000 0009 	CCP1CON_Clr	EQU	b'00001001'	;Clear output on match
00110 0000 0008 	CCP1CON_Set	EQU	b'00001000'	;Set output on match
00111 0000 000A 	CCP1CON_Int	EQU	b'00001010'
00112 0000 	;
00113 0000 012C 	ActivationTime	EQU	d'300'	;3 seconds
00114 0000 07FF 	kOffsetCtrValue	EQU	d'2047'
00115 0000 0708 	kMinPulseWidth	EQU	d'1800'	;900uS
00116 0000 0BB8 	kMidPulseWidth	EQU	d'3000'	;1500uS
00117 0000 1068 	kMaxPulseWidth	EQU	d'4200'	;2100uS
00118 0000 		if BP3Hold
00122 0000 		else
00123 0000 0E10 	kDefaultPosition1	EQU	d'3600'	;1800
00124 0000 0898 	kDefaultPosition2	EQU	d'2200'	;1100
00125 0000 0000 	HoldOpen	EQU	0
00126 0000 		endif
00127 0000 7D00 	kServoDwellTime	EQU	d'32000'	;16mS
00128 0000 0002 	kInPosShutdown	EQU	b'00000010'	;b'00000010' enabled 0x00 disabled
00129 0000 	;
00130 0000 	;====================================================================================================
00133 0000 		nolist
00134 0000 	;
00135 0000 	;    Port A bits
00136 0000 00DF 	PortADDRBits	EQU	b'11011111'
00137 0000 010C 	#Define	LED2	LATA,2	;Output: 0=LED ON, Input: 0 = Switch Pressed
00138 0000 008C 	#Define	LED2TrisBit	TRISA,2
00139 0000 000C 	#Define	IncBtnBit	PORTA,2
00140 0000 000C 	#Define	CmdInputBit	PORTA,3
00141 0000 010C 	#Define	SystemLED	LATA,4	;Output: 0=LED ON, Input: 0 = Switch Pressed
00142 0000 008C 	#Define	SysLEDTrisBit	TRISA,4
00143 0000 000C 	#Define	DecBtnBit	PORTA,4
00144 0000 000C 	#Define	RA5_In	PORTA,5	;CCP1
00145 0000 	;
00146 0000 0000 	PortAValue	EQU	b'00000000'
00147 0000 	;
00148 0000 	;====================================================================================================
00149 0000 	;====================================================================================================
00150 0000 	;
00151 0000 	;Constants
00152 0000 00FF 	All_In	EQU	0xFF
00153 0000 0000 	All_Out	EQU	0x00
00154 0000 	;
00155 0000 0064 	LEDTIME	EQU	d'100'	;1.00 seconds
00156 0000 000A 	LEDErrorTime	EQU	d'10'
00157 0000 	;
00158 0000 0001 	T1CON_Val	EQU	b'00000001'	;PreScale=1,Fosc/4,Timer ON
00159 0000 	;T1CON_Val	EQU	b'00100001'	;PreScale=4,Fosc/4,Timer ON
00160 0000 0072 	OSCCON_Value	EQU	b'01110010'	;8MHz
00161 0000 	;OSCCON_Value	EQU	b'11110000'	;32MHz
00162 0000 004E 	T2CON_Value	EQU	b'01001110'	;T2 On, /16 pre, /10 post
00163 0000 	;T2CON_Value	EQU	b'01001111'	;T2 On, /64 pre, /10 post
00164 0000 007D 	PR2_Value	EQU	.125
00165 0000 	;
00166 0000 	;
00167 0000 0000 	CCP1CON_Value	EQU	0x00	;CCP1 off
00168 0000 	;
00169 0000 	;================================================================================================
00170 0000 	;***** VARIABLE DEFINITIONS
00171 0000 	; there are 128 bytes of ram, Bank0 0x20..0x7F, Bank1 0xA0..0xBF
00172 0000 	; there are 256 bytes of EEPROM starting at 0x00 the EEPROM is not mapped into memory but
00173 0000 	;  accessed through the EEADR and EEDATA registers
00174 0000 	;================================================================================================
00175 0000 	;  Bank0 Ram 020h-06Fh 80 Bytes
00176 0000 	;
00177 0000 		cblock	0x20
00178 0000 	;
00179 0000 0020 		ISR_Temp		;scratch mem
00180 0000 0021 		LED_Time
00181 0000 0022 		LED2_Time
00182 0000 0023 		LED_Ticks		;Timer tick count
00183 0000 0024 		LED2_Ticks
00184 0000 0025 		LED_Blinks		;nBlinks, 0xFF=system blink, 0=Off
00185 0000 	;
00186 0000 	;
00187 0000 0026 		EEAddrTemp		;EEProm address to read or write
00188 0000 0027 		EEDataTemp		;Data to be writen to EEProm
00189 0000 	;
00190 0000 	;
00191 0000 0028 		Timer1Lo		;1st 16 bit timer
00192 0000 0029 		Timer1Hi		; not used
00193 0000 002A 		Timer2Lo		;2nd 16 bit timer
00194 0000 002B 		Timer2Hi		; Servo active timer
00195 0000 002C 		Timer3Lo		;3rd 16 bit timer
RocketServo.asm                                                       Page: 3
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00196 0000 002D 		Timer3Hi		; Activation timer
00197 0000 002E 		Timer4Lo		;4th 16 bit timer
00198 0000 002F 		Timer4Hi		; debounce timer and power up delay timer
00199 0000 	;
00200 0000 0030 		Dest:2
00201 0000 0032 		CurPos:2
00202 0000 	;
00203 0000 0034 		Position1:2
00204 0000 0036 		Position2:2
00205 0000 0038 		SysFlags
00206 0000 	;
00207 0000 0039 		Debounce
00208 0000 	;
00209 0000 		endc
00210 0000 	;
00211 0000 0038 	#Define	PulseSent	SysFlags,0
00212 0000 0038 	#Define	InPosShutdown	SysFlags,1
00213 0000 0038 	#Define	InPosition	SysFlags,2
00214 0000 	;
00215 0000 0034 	#Define	FirstRAMParam	Position1
00216 0000 0038 	#Define	LastRAMParam	SysFlags
00217 0000 	;
00218 0000 	;================================================================================================
00219 0000 	;  Bank1 Ram 0A0h-0BFh 32 Bytes
00220 0000 	;
00221 0000 	;
00222 0000 	;=======================================================================================================
00223 0000 	;  Common Ram 70-7F same for all banks
00224 0000 	;      except for ISR_W_Temp these are used for paramiter passing and temp vars
00225 0000 	;=======================================================================================================
00226 0000 	;
00227 0000 		cblock	0x70
00228 0000 0070 		SigOutTime
00229 0000 0071 		SigOutTimeH
00230 0000 0072 		Flags
00231 0000 	;
00232 0000 0073 		Param73
00233 0000 0074 		Param74
00234 0000 	;
00235 0000 0075 		CalcdDwell
00236 0000 0076 		CalcdDwellH
00237 0000 0077 		Param77
00238 0000 0078 		Param78
00239 0000 0079 		Param79
00240 0000 007A 		Param7A
00241 0000 007B 		Param7B
00242 0000 007C 		Param7C
00243 0000 007D 		Param7D
00244 0000 007E 		Param7E
00245 0000 007F 		Param7F
00246 0000 		endc
00247 0000 	;
00248 0000 	; Flags bits
00249 0000 0072 	#Define	IncBtnFlag	Flags,0
00250 0000 0072 	#Define	DecBtnFlag	Flags,1
00251 0000 0072 	#Define	LED2Flag	Flags,2
00252 0000 0072 	#Define	DataChangedFlag	Flags,3
00253 0000 0072 	#Define	ServoOff	Flags,4
00254 0000 0072 	#Define	SMRevFlag	Flags,5
00255 0000 0072 	#Define	NewSWData	Flags,6
00256 0000 	;
00257 0000 012C 	ServoMoveTime	EQU	.300	;time servo is powered when CMD changes
00258 0000 	;
00259 0000 0002 	BtnChangeRate	EQU	0x02	;change by 1uS per 0.05 seconds
00260 0000 0040 	SlewChangeRate	EQU	0x40	;change by 8uS per 0.01 seconds
00261 0000 	;
00262 0000 	;=========================================================================================
00263 0000 	;Conditionals
00264 0000 0080 	HasISR	EQU	0x80	;used to enable interupts 0x80=true 0x00=false
00265 0000 	;
00266 0000 	;=========================================================================================
00267 0000 	;==============================================================================================
00268 0000 	; ID Locations
00269 0000 		__idlocs	0x11B1
00270 0000 	;
00271 0000 	;==============================================================================================
00272 0000 	; EEPROM locations (NV-RAM) 0x00..0x7F (offsets)
00273 0000 		org	0xF000
00274 F000 	;
00275 F000 0010 		de	LOW kDefaultPosition1	;nvPosition1Lo
00276 F001 000E 		de	HIGH kDefaultPosition1
00277 F002 0098 		de	LOW kDefaultPosition2
00278 F003 0008 		de	HIGH kDefaultPosition2
00279 F004 	;
00280 F004 0002 		de	kInPosShutdown	;nvSysFlags
00281 F005 	;
00282 F005 		cblock	0x00
00283 F005 0000 		nvPosition1Lo
00284 F005 0001 		nvPosition1Hi
00285 F005 0002 		nvPosition2Lo
00286 F005 0003 		nvPosition2Hi
00287 F005 	;
00288 F005 0004 		nvSysFlags
00289 F005 		endc
00290 F005 	;
00291 F005 0000 	#Define	nvFirstParamByte	nvPosition1Lo
00292 F005 0004 	#Define	nvLastParamByte	nvSysFlags
00293 F005 	;
00294 F005 	;
RocketServo.asm                                                       Page: 4
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00295 F005 	;==============================================================================================
00296 F005 	;============================================================================================
00297 F005 	;
00298 F005 	;
00299 F005 		ORG	0x000	; processor reset vector
00300 0000 0183 		CLRF	STATUS
00301 0001 018A 		CLRF	PCLATH
00302 0002 285F 	  	goto	start	; go to beginning of program
00303 0003 	;
00304 0003 	;===============================================================================================
00305 0003 	; Interupt Service Routine
00306 0003 	;
00307 0003 	; we loop through the interupt service routing every 0.01 seconds
00308 0003 	;
00309 0003 	;
00310 0003 		ORG	0x004	; interrupt vector location
00311 0004 0020 		movlb	0	; bank0
00312 0005 	;
00313 0005 1C91 		btfss	PIR1,TMR2IF
00314 0006 282F 		goto	IRQ_2
00315 0007 1091 		bcf	PIR1,TMR2IF	; reset interupt flag bit
00316 0008 	;
00317 0008 	;Decrement timers until they are zero
00318 0008 	;
00319 0008 0185 		CLRF	FSR0H
00320 0009 2234 		call	DecTimer1	;if timer 1 is not zero decrement
00321 000A 2232 		call	DecTimer2
00322 000B 2230 		call	DecTimer3
00323 000C 222E 		call	DecTimer4
00324 000D 	;
00325 000D 	;-----------------------------------------------------------------
00326 000D 	; blink LEDs
00327 000D 0021 		movlb                  1                      ;bank 1
00328 000E 160C 		BSF	SysLEDTrisBit	;LED off
00329 000F 150C 		BSF	LED2TrisBit	;LED2 off
00330 0010 	;
00331 0010 0020 		movlb	0	;bank 0
00332 0011 1072 		BCF	IncBtnFlag
00333 0012 1D0C 		BTFSS	IncBtnBit
00334 0013 1472 		BSF	IncBtnFlag
00335 0014 	;
00336 0014 10F2 		BCF	DecBtnFlag
00337 0015 1E0C 		BTFSS	DecBtnBit
00338 0016 14F2 		BSF	DecBtnFlag
00339 0017 	;
00340 0017 1772 		bsf	NewSWData	;New data every 0.01s
00341 0018 	;
00342 0018 0BA3 	SystemBlink_1	DECFSZ	LED_Ticks,F	;Time to blink?
00343 0019 320B 		bra	SystemBlink_end	; no
00344 001A 	;
00345 001A 0821 		MOVF	LED_Time,W
00346 001B 00A3 		movwf	LED_Ticks
00347 001C 	;
00348 001C 08A5 		movf	LED_Blinks,F	;nBlinks, 0xFF=system blink, 0=Off
00349 001D 		SKPNZ
00349 001D 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00350 001E 3206 		BRA	SystemBlink_end
00351 001F 0F25 		incfsz	LED_Blinks,W
00352 0020 3201 		BRA	SystemBlink_Blinking
00353 0021 3201 		BRA	SystemBlink_on
00354 0022 03A5 	SystemBlink_Blinking	decf	LED_Blinks,F
00355 0023 0021 	SystemBlink_on	movlb                  1                      ;bank 1
00356 0024 120C 		BCF	SysLEDTrisBit	;LED on
00357 0025 0020 	SystemBlink_end	MOVLB	0                      ;bank 0
00358 0026 	;
00359 0026 0BA4 		decfsz	LED2_Ticks,F
00360 0027 3206 		bra	LED2_End
00361 0028 	;
00362 0028 0822 		MOVF	LED2_Time,W
00363 0029 00A4 		movwf	LED2_Ticks
00364 002A 	;
00365 002A 1D72 		BTFSS	LED2Flag
00366 002B 3202 		bra                    LED2_End
00367 002C 0021 		movlb                  1                      ;bank 1
00368 002D 110C 		BCF	LED2TrisBit
00369 002E 	;
00370 002E 0020 	LED2_End	MOVLB	0
00371 002F 	;-----------------------------------------------------------------
00372 002F 	;
00373 002F 	IRQ_2:
00374 002F 	;==================================================================================
00375 002F 	;
00376 002F 	; Handle CCP1 Interupt Flag, Enter w/ bank 0 selected
00377 002F 	;
00378 002F 0020 	IRQ_Servo1	MOVLB	0	;bank 0
00379 0030 1D11 		BTFSS	PIR1,CCP1IF
00380 0031 285E 		GOTO	IRQ_Servo1_End
00381 0032 	;
00382 0032 1438 		BSF	PulseSent
00383 0033 1E72 		BTFSS	ServoOff	;Are we sending a pulse?
00384 0034 2838 		GOTO	IRQ_Servo1_1	; Yes
00385 0035 	;
00386 0035 	;Oops, how did we get here???
00387 0035 0025 		MOVLB	0x05                   ;Bank 5
00388 0036 0193 		CLRF	CCP1CON
00389 0037 285C 		GOTO	IRQ_Servo1_X
00390 0038 	;
00391 0038 0025 	IRQ_Servo1_1	MOVLB	0x05                   ;Bank 5
00392 0039 1813 		BTFSC	CCP1CON,CCP1M0	;Set output on match?
RocketServo.asm                                                       Page: 5
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00393 003A 2850 		GOTO	IRQ_Servo1_OL	; No
00394 003B 	; An output just went high
00395 003B 	;
00396 003B 0870 		MOVF	SigOutTime,W	;Put the pulse into the CCP reg.
00397 003C 0791 		ADDWF	CCPR1L,F
00398 003D 0871 		MOVF	SigOutTime+1,W
00399 003E 3D92 		ADDWFC	CCPR1H,F
00400 003F 0020 		movlb	0	;Bank 0
00401 0040 300A 		movlw	CCP1CON_Int
00402 0041 1CB8 		btfss	InPosShutdown
00403 0042 3009 		MOVLW	CCP1CON_Clr	;Clear output on match
00404 0043 1D38 		btfss	InPosition
00405 0044 3009 		MOVLW	CCP1CON_Clr	;Clear output on match
00406 0045 0025 		movlb	5	;Bank 5
00407 0046 0093 		MOVWF	CCP1CON	;CCP1 clr on match
00408 0047 	;Calculate dwell time
00409 0047 3000 		MOVLW	LOW kServoDwellTime
00410 0048 00F5 		MOVWF	CalcdDwell
00411 0049 307D 		MOVLW	HIGH kServoDwellTime
00412 004A 00F6 		MOVWF	CalcdDwellH
00413 004B 0870 		MOVF	SigOutTime,W
00414 004C 02F5 		SUBWF	CalcdDwell,F
00415 004D 0871 		MOVF	SigOutTime+1,W
00416 004E 3BF6 		SUBWFB	CalcdDwellH,F
00417 004F 285C 		GOTO	IRQ_Servo1_X
00418 0050 	;
00419 0050 	; output went low so this cycle is done
00420 0050 3000 	IRQ_Servo1_OL	MOVLW	LOW kServoDwellTime
00421 0051 0791 		ADDWF	CCPR1L,F
00422 0052 307D 		MOVLW	HIGH kServoDwellTime
00423 0053 3D92 		ADDWFC	CCPR1H,F
00424 0054 	;
00425 0054 0020 		movlb	0	;Bank 0
00426 0055 300A 		movlw	CCP1CON_Int
00427 0056 1CB8 		btfss	InPosShutdown
00428 0057 3008 		MOVLW	CCP1CON_Set	;Set output on match
00429 0058 1D38 		btfss	InPosition
00430 0059 3008 		MOVLW	CCP1CON_Set	;Set output on match
00431 005A 0025 		movlb	5	;Bank 5
00432 005B 0093 		MOVWF	CCP1CON	;Idle output low
00433 005C 	;
00434 005C 0020 	IRQ_Servo1_X	MOVLB	0x00                   ;Bank 0
00435 005D 1111 		BCF	PIR1,CCP1IF
00436 005E 	IRQ_Servo1_End:
00437 005E 	;--------------------------------------------------------------------
00438 005E 	;
00439 005E 0009 		retfie		; return from interrupt
00440 005F 	;
00441 005F 	;
00442 005F 	;==============================================================================================
00443 005F 	;**********************************************************************************************
00444 005F 	;==============================================================================================
00445 005F 	;
00446 005F 0021 	start	MOVLB	0x01	; select bank 1
00447 0060 1795 		bsf	OPTION_REG,NOT_WPUEN	; disable pullups on port B
00448 0061 1295 		bcf	OPTION_REG,TMR0CS	; TMR0 clock Fosc/4
00449 0062 1195 		bcf	OPTION_REG,PSA	; prescaler assigned to TMR0
00450 0063 1415 		bsf	OPTION_REG,PS0	;111 8mhz/4/256=7812.5hz=128uS/Ct=0.032768S/ISR
00451 0064 1495 		bsf	OPTION_REG,PS1	;101 8mhz/4/64=31250hz=32uS/Ct=0.008192S/ISR
00452 0065 1515 		bsf	OPTION_REG,PS2
00453 0066 	;
00454 0066 3072 		MOVLW	OSCCON_Value
00455 0067 0099 		MOVWF	OSCCON
00456 0068 3017 		movlw	b'00010111'	; WDT prescaler 1:65536 period is 2 sec (RESET value)
00457 0069 0097 		movwf	WDTCON
00458 006A 	;
00459 006A 0023 		MOVLB	0x03	; bank 3
00460 006B 	;
00461 006B 		if HasBattV
00462 006B 3001 		MOVLW	0x01
00463 006C 		else
00465 006C 		endif
00466 006C 	;
00467 006C 008C 		MOVWF	ANSELA	;AN0 only
00468 006D 	;
00469 006D 	; setup timer 1 for 0.5uS/count
00470 006D 	;
00471 006D 0020 		movlb	0	; bank 0
00472 006E 3001 		MOVLW	T1CON_Val
00473 006F 0098 		MOVWF	T1CON
00474 0070 1399 		bcf	T1GCON,TMR1GE
00475 0071 	;
00476 0071 	; clear memory to zero
00477 0071 21FF 		CALL	ClearRam
00478 0072 	;
00479 0072 	; Setup timer 2 for 0.01S/Interupt
00480 0072 304E 		MOVLW	T2CON_Value	;Setup T2 for 100/s
00481 0073 009C 		MOVWF	T2CON
00482 0074 307D 		MOVLW	PR2_Value
00483 0075 009B 		MOVWF	PR2
00484 0076 0021 		MOVLB	1	;Bank 1
00485 0077 1491 		BSF	PIE1,TMR2IE
00486 0078 0020 		movlb	0                      ;Bank 0
00487 0079 	;
00488 0079 	; setup ccp1
00489 0079 	;
00490 0079 1672 		BSF	ServoOff
00491 007A 0022 		movlb	2                      ;bank 2
00492 007B 141D 		BSF	APFCON,CCP1SEL	;RA5
RocketServo.asm                                                       Page: 6
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00493 007C 0025 		movlb	5                      ;bank 5
00494 007D 0193 		CLRF	CCP1CON
00495 007E 	;
00496 007E 0021 		MOVLB	0x01	;Bank 1
00497 007F 1511 		bsf	PIE1,CCP1IE
00498 0080 	;
00499 0080 	; setup data ports
00500 0080 0020 		movlb                  0                      ;bank 0
00501 0081 3000 		MOVLW	PortAValue
00502 0082 008C 		MOVWF	PORTA	;Init PORTA
00503 0083 0021 		movlb                  1                      ;bank 1
00504 0084 30DF 		MOVLW	PortADDRBits
00505 0085 008C 		MOVWF	TRISA
00506 0086 	;
00507 0086 0020 		MOVLB	0	;bank 0
00508 0087 0064 		CLRWDT
00509 0088 	;
00510 0088 3064 		MOVLW	LEDTIME
00511 0089 00A1 		MOVWF	LED_Time
00512 008A 3001 		movlw	0x01	;continuos ON
00513 008B 00A2 		movwf	LED2_Time
00514 008C 	;
00515 008C 0064 		CLRWDT
00516 008D 220F 		CALL	CopyToRam
00517 008E 0064 		CLRWDT
00518 008F 	;
00519 008F 	;
00520 008F 170B 		bsf	INTCON,PEIE	; enable periferal interupts
00521 0090 	;	bsf	INTCON,T0IE	; enable TMR0 interupt
00522 0090 178B 		bsf	INTCON,GIE	; enable interupts
00523 0091 	;
00524 0091 0020 		MOVLB	0x00	;bank 0
00525 0092 3004 		movlw	0x04
00526 0093 00AE 		movwf	Timer4Lo	;power up delay
00527 0094 	;
00528 0094 	;=========================================================================================
00529 0094 	;=========================================================================================
00530 0094 	;  Main Loop
00531 0094 	;
00532 0094 		if HasBattV
00533 0094 2196 		CALL	ReadAN0_ColdStart
00534 0095 20AF 		CALL	LongFlash
00535 0096 	;
00536 0096 2188 		CALL	ReadAN0
00537 0097 2188 		CALL	ReadAN0
00538 0098 	; devide by 8
00539 0098 36FD 		lsrf	Param7D,F
00540 0099 0CFC 		rrf	Param7C,F
00541 009A 36FD 		lsrf	Param7D,F
00542 009B 0CFC 		rrf	Param7C,F
00543 009C 36FD 		lsrf	Param7D,F
00544 009D 0CFC 		rrf	Param7C,F
00545 009E 	;
00546 009E 3032 		movlw	.50	; 1/2 second
00547 009F 00A1 		movwf	LED_Time
00548 00A0 087C 		movf	Param7C,W
00549 00A1 00A5 		movwf	LED_Blinks
00550 00A2 	;
00551 00A2 0064 	Start_L1	CLRWDT
00552 00A3 0825 		movf	LED_Blinks,W
00553 00A4 		SKPZ
00553 00A4 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00554 00A5 33FC 		BRA	Start_L1
00555 00A6 20B6 		CALL	Delay_1S
00556 00A7 	;
00557 00A7 20AF 		CALL	LongFlash
00558 00A8 	;
00559 00A8 		endif
00560 00A8 	; normal system blinks
00561 00A8 3064 		MOVLW	LEDTIME
00562 00A9 00A1 		MOVWF	LED_Time
00563 00AA 30FF 		movlw	0xFF
00564 00AB 00A5 		movwf	LED_Blinks
00565 00AC 	;
00566 00AC 219E 		CALL	StartServo
00567 00AD 20BD 		CALL	HomeServo
00568 00AE 3216 		BRA	MainLoop
00569 00AF 	;
00570 00AF 	;==============================================
00571 00AF 	; One second ON one second OFF
00572 00AF 3064 	LongFlash	movlw	.100
00573 00B0 00A5 		movwf	LED_Blinks
00574 00B1 3001 		movlw	0x01	;constant ON
00575 00B2 00A1 		movwf	LED_Time
00576 00B3 0825 	LongFlash_L1	movf	LED_Blinks,W
00577 00B4 		SKPZ
00577 00B4 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00578 00B5 33FD 		BRA	LongFlash_L1
00579 00B6 	;
00580 00B6 3064 	Delay_1S	movlw	.100
00581 00B7 00A8 		movwf	Timer1Lo
00582 00B8 0828 	Delay_L1	movf	Timer1Lo,W
00583 00B9 		SKPZ
00583 00B9 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00584 00BA 33FD 		bra	Delay_L1
00585 00BB 0064 		CLRWDT
00586 00BC 0008 		return
00587 00BD 	;
00588 00BD 	;==============================================
RocketServo.asm                                                       Page: 7
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00589 00BD 0020 	HomeServo	movlb	0	;Bank0
00590 00BE 12F2 		bcf	SMRevFlag
00591 00BF 1172 		bcf	LED2Flag
00592 00C0 302C 		movlw	Low ActivationTime
00593 00C1 00AC 		movwf	Timer3Lo
00594 00C2 3001 		movlw	High ActivationTime
00595 00C3 00AD 		movwf	Timer3Hi
00596 00C4 0008 		return
00597 00C5 	;
00598 00C5 	;=========================================================================================
00599 00C5 	;
00600 00C5 0064 	MainLoop	CLRWDT
00601 00C6 0020 		MOVLB	0x00                   ;Bank 0
00602 00C7 	;
00603 00C7 	; Handle Inc/Dec buttons
00604 00C7 082E 		movf	Timer4Lo,W
00605 00C8 042F 		iorwf	Timer4Hi,W
00606 00C9 		SKPZ		;Timer4 == 0?
00606 00C9 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00607 00CA 3225 		bra	ML_Btns_End	; No
00608 00CB 1C72 		btfss	IncBtnFlag	;Inc button is down?
00609 00CC 3213 		bra	ML_Btns_Dec	; No
00610 00CD 	;
00611 00CD 1CF2 		btfss	DecBtnFlag	;Dec button is down?
00612 00CE 3206 		bra	ML_Btns_Inc	; No
00613 00CF 	; Handle both buttons, move to center
00614 00CF 30B8 		movlw	low kMidPulseWidth
00615 00D0 00B0 		movwf	Dest
00616 00D1 300B 		movlw	high kMidPulseWidth
00617 00D2 00B1 		movwf	Dest+1
00618 00D3 11F2 		bcf	DataChangedFlag
00619 00D4 323C 		bra	Set_Dest_End
00620 00D5 	;
00621 00D5 	; Handle INC button
00622 00D5 2164 	ML_Btns_Inc	call	CopyPosToTemp
00623 00D6 3002 		movlw	BtnChangeRate
00624 00D7 07FC 		addwf	Param7C,F
00625 00D8 3000 		movlw	0x00
00626 00D9 3DFD 		addwfc	Param7D,F
00627 00DA 21CF 		call	ClampInt
00628 00DB 2161 		call	CopyTempToPos
00629 00DC 15F2 		bsf	DataChangedFlag
00630 00DD 	;
00631 00DD 3005 		movlw	0x05	; 0.05 seconds
00632 00DE 00AE 		movwf	Timer4Lo
00633 00DF 3210 		bra	ML_Btns_End
00634 00E0 	;
00635 00E0 1CF2 	ML_Btns_Dec	btfss	DecBtnFlag	;Dec button is down?
00636 00E1 320B 		bra	ML_Btns_Save	; No
00637 00E2 	;
00638 00E2 	; Handle DEC button
00639 00E2 2164 		call	CopyPosToTemp
00640 00E3 3002 		movlw	BtnChangeRate
00641 00E4 02FC 		subwf	Param7C,F
00642 00E5 3000 		movlw	0x00
00643 00E6 3BFD 		subwfb	Param7D,F
00644 00E7 21CF 		call	ClampInt
00645 00E8 2161 		call	CopyTempToPos
00646 00E9 15F2 		bsf	DataChangedFlag
00647 00EA 	;
00648 00EA 3005 		movlw	0x05	; 0.05 seconds
00649 00EB 00AE 		movwf	Timer4Lo
00650 00EC 3203 		bra	ML_Btns_End
00651 00ED 		bra	ML_Btns_End
00652 00ED 19F2 	ML_Btns_Save	btfsc	DataChangedFlag
00653 00EE 221E 		call	SaveParams
00654 00EF 11F2 		bcf	DataChangedFlag
00655 00F0 	ML_Btns_End:
00656 00F0 	;
00657 00F0 	;-------------------------
00658 00F0 	; Set Dest
00659 00F0 	;
00660 00F0 1F72 		btfss	NewSWData	;10mS interval passed?
00661 00F1 321F 		bra	Set_Dest_End	; No
00662 00F2 1372 		bcf	NewSWData
00663 00F3 	;
00664 00F3 198C 		btfsc	CmdInputBit	;Contorl signal active?
00665 00F4 320E 		bra	ML_CmdNormal	; No
00666 00F5 	; debounce, don't change until we've seen the input 5 times
00667 00F5 3005 		movlw	0x05
00668 00F6 0239 		subwf	Debounce,W
00669 00F7 		SKPZ		;5 times?
00669 00F7 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00670 00F8 3208 		bra	Rev_Debounce	; No
00671 00F9 	;
00672 00F9 0020 		movlb	0	;Bank0
00673 00FA 16F2 		bsf	SMRevFlag
00674 00FB 1572 		bsf	LED2Flag
00675 00FC 302C 		movlw	Low ActivationTime
00676 00FD 00AC 		movwf	Timer3Lo
00677 00FE 3001 		movlw	High ActivationTime
00678 00FF 00AD 		movwf	Timer3Hi
00679 0100 320F 		bra	Move_It
00680 0101 	;
00681 0101 0AB9 	Rev_Debounce	incf	Debounce,F
00682 0102 320E 		bra	Set_Dest_End
00683 0103 	;
00684 0103 08B9 	ML_CmdNormal	movf	Debounce,F
00685 0104 		SKPZ
RocketServo.asm                                                       Page: 8
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00685 0104 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00686 0105 3208 		bra	Norm_Debounce
00687 0106 	;
00688 0106 0020 		movlb	0	;Bank 0
00689 0107 082C 		movf	Timer3Lo,W
00690 0108 042D 		iorwf	Timer3Hi,W
00691 0109 		SKPZ		;Activation time done?
00691 0109 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00692 010A 3205 		bra	Move_It	; No
00693 010B 		if HoldOpen=0
00694 010B 12F2 		bcf	SMRevFlag
00695 010C 		endif
00696 010C 1172 		bcf	LED2Flag
00697 010D 3202 		bra	Move_It
00698 010E 	;
00699 010E 03B9 	Norm_Debounce	decf	Debounce,F
00700 010F 3201 		bra	Set_Dest_End
00701 0110 	;
00702 0110 2167 	Move_It	call	CopyPosToDest
00703 0111 	;
00704 0111 	Set_Dest_End:
00705 0111 	;
00706 0111 	;---------------------
00707 0111 	; Move CurPos toward Dest
00708 0111 0020 		movlb	0	;Bank 0
00709 0112 1C38 		btfss	PulseSent
00710 0113 323B 		bra	Move_End
00711 0114 1038 		bcf	PulseSent
00712 0115 	;
00713 0115 0830 		movf	Dest,W
00714 0116 0232 		subwf	CurPos,W
00715 0117 00F8 		movwf	Param78
00716 0118 0831 		movf	Dest+1,W
00717 0119 3B33 		subwfb	CurPos+1,W
00718 011A 04F8 		iorwf	Param78,F
00719 011B 		SKPZ		;Dest == CurPos?
00719 011B 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00720 011C 3205 		bra	Move_It_NIP
00721 011D 082A 		movf	Timer2Lo,W
00722 011E 042B 		iorwf	Timer2Hi,W
00723 011F 		SKPNZ
00723 011F 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00724 0120 1538 		bsf	InPosition
00725 0121 3228 		bra	Move_It_Now	; Yes
00726 0122 	;
00727 0122 302C 	Move_It_NIP	movlw	Low ServoMoveTime
00728 0123 00AA 		movwf	Timer2Lo
00729 0124 3001 		movlw	High ServoMoveTime
00730 0125 00AB 		movwf	Timer2Hi
00731 0126 1138 		bcf	InPosition
00732 0127 	;
00733 0127 0830 		movf	Dest,W
00734 0128 00F8 		movwf	Param78
00735 0129 0831 		movf	Dest+1,W
00736 012A 00F9 		movwf	Param79
00737 012B 	;
00738 012B 0832 		movf	CurPos,W
00739 012C 00FC 		movwf	Param7C
00740 012D 0833 		movf	CurPos+1,W
00741 012E 00FD 		movwf	Param7D
00742 012F 	;
00743 012F 21F0 		call	Param7D_LE_Param79
00744 0130 1C77 		btfss	Param77,0	;CurPos<=Dest?
00745 0131 320C 		bra	Move_It_Neg	; No, CurPos>Dest
00746 0132 	;CurPos<Dest, so move CurPos positive
00747 0132 3040 		movlw	SlewChangeRate
00748 0133 07FC 		addwf	Param7C,F
00749 0134 3000 		movlw	0x00
00750 0135 3DFD 		addwfc	Param7D,F
00751 0136 21F0 		call	Param7D_LE_Param79
00752 0137 1C77 		btfss	Param77,0	;CurPos<=Dest Still?
00753 0138 320D 		bra	Move_It_Dest	; No, CurPos>Dest
00754 0139 				; Yes, CurPos+=SlewChangeRate
00755 0139 	;
00756 0139 	; make the calculated position the current position
00757 0139 087C 	Move_It_New	movf	Param7C,W
00758 013A 00B2 		movwf	CurPos
00759 013B 087D 		movf	Param7D,W
00760 013C 00B3 		movwf	CurPos+1
00761 013D 320C 		bra	Move_It_Now
00762 013E 	;
00763 013E 	Move_It_Neg
00764 013E 3040 		movlw	SlewChangeRate
00765 013F 02FC 		subwf	Param7C,F
00766 0140 3000 		movlw	0x00
00767 0141 3BFD 		subwfb	Param7D,F
00768 0142 21F0 		call	Param7D_LE_Param79
00769 0143 1877 		btfsc	Param77,0	;CurPos<=Dest now?
00770 0144 3201 		bra	Move_It_Dest	; Yes, CurPos<=Dest
00771 0145 33F3 		bra	Move_It_New
00772 0146 	;
00773 0146 	; make the current position the destination
00774 0146 0830 	Move_It_Dest	movf	Dest,W
00775 0147 00B2 		movwf	CurPos
00776 0148 0831 		movf	Dest+1,W
00777 0149 00B3 		movwf	CurPos+1
00778 014A 	;
00779 014A 	Move_It_Now:
00780 014A 0832 		movf	CurPos,W
RocketServo.asm                                                       Page: 9
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00781 014B 00FC 		movwf	Param7C
00782 014C 0833 		movf	CurPos+1,W
00783 014D 00FD 		movwf	Param7D
00784 014E 2150 		CALL	Copy7CToSig
00785 014F 	Move_End:
00786 014F 	;
00787 014F 28C5 		goto	MainLoop
00788 0150 	;
00789 0150 	;========================================================================================
00790 0150 	; Param7D:Param7C >> SigOutTimeH:SigOutTime
00791 0150 	; Entry: Param7D:Param7C
00792 0150 	;
00793 0150 	; Don't disable interrupts if you don't need to...
00794 0150 	; If Param7D:Param7C == SigOutTimeH:SigOutTime then return
00795 0150 087C 	Copy7CToSig	MOVF	Param7C,W
00796 0151 0270 		SUBWF	SigOutTime,W
00797 0152 		SKPZ
00797 0152 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00798 0153 2958 		GOTO	Copy7CToSig_1
00799 0154 087D 		MOVF	Param7D,W
00800 0155 0271 		SUBWF	SigOutTimeH,W
00801 0156 		SKPNZ
00801 0156 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00802 0157 0008 		Return
00803 0158 	;
00804 0158 	;SigOutTimeH:SigOutTime = Param7D:Param7C
00805 0158 138B 	Copy7CToSig_1	bcf	INTCON,GIE
00806 0159 1B8B 		btfsc	INTCON,GIE
00807 015A 33FD 		bra	Copy7CToSig_1
00808 015B 087C 		MOVF	Param7C,W
00809 015C 00F0 		MOVWF	SigOutTime
00810 015D 087D 		MOVF	Param7D,W
00811 015E 00F1 		MOVWF	SigOutTimeH
00812 015F 178B 		bsf	INTCON,GIE
00813 0160 	;
00814 0160 0008 		RETURN
00815 0161 	;
00816 0161 	;=========================================================================
00817 0161 	;
00818 0161 1EF2 	CopyTempToPos	btfss	SMRevFlag
00819 0162 321B 		bra	CopyTempToPos1
00820 0163 321F 		bra	CopyTempToPos2
00821 0164 	;
00822 0164 1EF2 	CopyPosToTemp	btfss	SMRevFlag
00823 0165 320E 		bra	CopyPos1ToTemp
00824 0166 3212 		bra	CopyPos2ToTemp
00825 0167 	;
00826 0167 1EF2 	CopyPosToDest	btfss	SMRevFlag
00827 0168 3201 		bra	CopyPos1ToDest
00828 0169 3205 		bra	CopyPos2ToDest
00829 016A 	;
00830 016A 	;====================================
00831 016A 	;
00832 016A 0835 	CopyPos1ToDest	movf	Position1+1,W
00833 016B 00B1 		movwf	Dest+1
00834 016C 0834 		movf	Position1,W
00835 016D 00B0 		movwf	Dest
00836 016E 0008 		return
00837 016F 	;
00838 016F 	;=====================================
00839 016F 	;
00840 016F 0837 	CopyPos2ToDest	movf	Position2+1,W
00841 0170 00B1 		movwf	Dest+1
00842 0171 0836 		movf	Position2,W
00843 0172 00B0 		movwf	Dest
00844 0173 0008 		return
00845 0174 	;
00846 0174 	;====================================
00847 0174 	;
00848 0174 0835 	CopyPos1ToTemp	movf	Position1+1,W
00849 0175 00FD 		movwf	Param7D
00850 0176 0834 		movf	Position1,W
00851 0177 00FC 		movwf	Param7C
00852 0178 0008 		return
00853 0179 	;
00854 0179 	;=====================================
00855 0179 	;
00856 0179 0837 	CopyPos2ToTemp	movf	Position2+1,W
00857 017A 00FD 		movwf	Param7D
00858 017B 0836 		movf	Position2,W
00859 017C 00FC 		movwf	Param7C
00860 017D 0008 		return
00861 017E 	;
00862 017E 	;=====================================
00863 017E 	;
00864 017E 087D 	CopyTempToPos1	movf	Param7D,W
00865 017F 00B5 		movwf	Position1+1
00866 0180 087C 		movf	Param7C,W
00867 0181 00B4 		movwf	Position1
00868 0182 0008 		return
00869 0183 	;
00870 0183 087D 	CopyTempToPos2	movf	Param7D,W
00871 0184 00B7 		movwf	Position2+1
00872 0185 087C 		movf	Param7C,W
00873 0186 00B6 		movwf	Position2
00874 0187 0008 		return
00875 0188 	;
00876 0188 	;=========================================================================================
00877 0188 	;=========================================================================================
RocketServo.asm                                                       Page: 10
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00878 0188 	; Setup or Read AN0
00879 0188 	; Exit: 10bit analog in 7D:7C
00880 0188 	;
00881 0188 01FC 	ReadAN0	CLRF	Param7C
00882 0189 01FD 		CLRF	Param7D
00883 018A 0021 		MOVLB	1	;bank 1
00884 018B 1C1D 		BTFSS	ADCON0,ADON	;Is the Analog input ON?
00885 018C 2996 		GOTO	ReadAN0_ColdStart	; No, go start it
00886 018D 189D 	ReadAN0_L1	BTFSC	ADCON0,NOT_DONE	;Conversion done?
00887 018E 33FE 		BRA	ReadAN0_L1	; No
00888 018F 081C 		MOVF	ADRESH,W
00889 0190 00FD 		MOVWF	Param7D
00890 0191 081B 		MOVF	ADRESL,W
00891 0192 00FC 		MOVWF	Param7C
00892 0193 149D 		BSF	ADCON0,ADGO	;Start next conversion.
00893 0194 0020 		MOVLB	0	;bank 0
00894 0195 0008 		RETURN
00895 0196 	;
00896 0196 0021 	ReadAN0_ColdStart	MOVLB	1	;bank 1
00897 0197 30A0 		MOVLW	0xA0	;Right Just fosc/32
00898 0198 009E 		MOVWF	ADCON1
00899 0199 3001 		MOVLW	b'00000001'	;Select AN0
00900 019A 009D 		MOVWF	ADCON0
00901 019B 149D 		BSF	ADCON0,GO
00902 019C 0020 	ReadAN0_Rtn	MOVLB	0	;bank 0
00903 019D 0008 		Return
00904 019E 	;
00905 019E 	;=========================================================================================
00906 019E 	;=========================================================================================
00907 019E 	; Set CCP1 to go high is 0x100 clocks
00908 019E 	;
00909 019E 0020 	StartServo	MOVLB	0	;bank 0
00910 019F 1E72 		BTFSS	ServoOff
00911 01A0 0008 		RETURN
00912 01A1 1272 		BCF	ServoOff
00913 01A2 	;
00914 01A2 08AE 	SS_Start_Loop	movf	Timer4Lo,F
00915 01A3 		SKPZ
00915 01A3 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00916 01A4 33FD 		bra	SS_Start_Loop
00917 01A5 	;
00918 01A5 	; Initialize to normal position
00919 01A5 0020 	SS_CmdNormal	movlb	0	;Bank 0
00920 01A6 12F2 		bcf	SMRevFlag
00921 01A7 1172 		bcf	LED2Flag
00922 01A8 	;
00923 01A8 2167 	SS_Move_It	call	CopyPosToDest
00924 01A9 21C8 		call	SetDestAsCur
00925 01AA 2150 		CALL	Copy7CToSig
00926 01AB 	;
00927 01AB 3000 		MOVLW	0x00	;start in 0x100 clocks
00928 01AC 0096 		MOVWF	TMR1L
00929 01AD 30FF 		MOVLW	0xFF
00930 01AE 0097 		MOVWF	TMR1H
00931 01AF 	;
00932 01AF 0025 		MOVLB	0x05                   ;Bank 5
00933 01B0 0192 		CLRF	CCPR1H
00934 01B1 0191 		CLRF	CCPR1L
00935 01B2 3008 		MOVLW	CCP1CON_Set
00936 01B3 0093 		MOVWF	CCP1CON	;go high on match
00937 01B4 0020 		MOVLB	0x00	;Bank 0
00938 01B5 302C 		movlw	low .300	;Do nothing for 3 seconds
00939 01B6 00AE 		movwf	Timer4Lo
00940 01B7 3001 		movlw	high .300
00941 01B8 00AF 		movwf	Timer4Hi
00942 01B9 302C 		movlw	Low ServoMoveTime	;At power up move to commanded position
00943 01BA 00AA 		movwf	Timer2Lo
00944 01BB 3001 		movlw	High ServoMoveTime
00945 01BC 00AB 		movwf	Timer2Hi
00946 01BD 1138 		bcf	InPosition
00947 01BE 0008 		RETURN
00948 01BF 	;
00949 01BF 	;=========================================================================================
00950 01BF 	;
00951 01BF 30B8 	SetMiddlePosition	MOVLW	LOW kMidPulseWidth
00952 01C0 00FC 		MOVWF	Param7C
00953 01C1 00B0 		movwf	Dest
00954 01C2 00B2 		movwf	CurPos
00955 01C3 300B 		MOVLW	HIGH kMidPulseWidth
00956 01C4 00FD 		MOVWF	Param7D
00957 01C5 00B1 		movwf	Dest+1
00958 01C6 00B3 		movwf	CurPos+1
00959 01C7 0008 		Return
00960 01C8 	;
00961 01C8 	;=========================================================================================
00962 01C8 	;
00963 01C8 0830 	SetDestAsCur	movf	Dest,W
00964 01C9 00FC 		MOVWF	Param7C
00965 01CA 00B2 		movwf	CurPos
00966 01CB 0831 		movf	Dest+1,W
00967 01CC 00FD 		MOVWF	Param7D
00968 01CD 00B3 		movwf	CurPos+1
00969 01CE 0008 		Return
00970 01CF 	;
00971 01CF 	;=========================================================================================
00972 01CF 	; ClampInt(Param7D:Param7C,kMinPulseWidth,kMaxPulseWidth)
00973 01CF 	;
00974 01CF 	; Entry: Param7D:Param7C
00975 01CF 	; Exit: Param7D:Param7C=ClampInt(Param7D:Param7C,kMinPulseWidth,kMaxPulseWidth)
RocketServo.asm                                                       Page: 11
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00976 01CF 	;
00977 01CF 3010 	ClampInt	MOVLW	high kMaxPulseWidth
00978 01D0 027D 		SUBWF	Param7D,W	;7D-kMaxPulseWidth
00979 01D1 		SKPNB		;7D<Max?
00979 01D1 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
00980 01D2 29DC 		GOTO	ClampInt_1	; Yes
00981 01D3 		SKPZ		;7D=Max?
00981 01D3 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00982 01D4 29EB 		GOTO	ClampInt_tooHigh	; No, its greater.
00983 01D5 3068 		MOVLW	low kMaxPulseWidth	; Yes, MSB was equal check LSB
00984 01D6 027C 		SUBWF	Param7C,W	;7C-kMaxPulseWidth
00985 01D7 		SKPNZ		;=kMaxPulseWidth
00985 01D7 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00986 01D8 0008 		RETURN		;Yes
00987 01D9 		SKPB		;7C<Max?
00987 01D9 1803      M		BTFSC	STATUS,C		BTFSC	STATUS,C
00988 01DA 29EB 		GOTO	ClampInt_tooHigh	; No
00989 01DB 0008 		RETURN		; Yes
00990 01DC 	;
00991 01DC 3007 	ClampInt_1	MOVLW	high kMinPulseWidth
00992 01DD 027D 		SUBWF	Param7D,W	;7D-kMinPulseWidth
00993 01DE 		SKPNB		;7D<Min?
00993 01DE 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
00994 01DF 29E6 		GOTO	ClampInt_tooLow	; Yes
00995 01E0 		SKPZ		;=Min?
00995 01E0 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00996 01E1 0008 		RETURN		; No, 7D>kMinPulseWidth
00997 01E2 3008 		MOVLW	low kMinPulseWidth	; Yes, MSB is a match
00998 01E3 027C 		SUBWF	Param7C,W	;7C-kMinPulseWidth
00999 01E4 		SKPB		;7C>=Min?
00999 01E4 1803      M		BTFSC	STATUS,C		BTFSC	STATUS,C
01000 01E5 0008 		RETURN		; Yes
01001 01E6 	;
01002 01E6 3008 	ClampInt_tooLow	MOVLW	low kMinPulseWidth
01003 01E7 00FC 		MOVWF	Param7C
01004 01E8 3007 		MOVLW	high kMinPulseWidth
01005 01E9 00FD 		MOVWF	Param7D
01006 01EA 0008 		RETURN
01007 01EB 	;
01008 01EB 3068 	ClampInt_tooHigh	MOVLW	low kMaxPulseWidth
01009 01EC 00FC 		MOVWF	Param7C
01010 01ED 3010 		MOVLW	high kMaxPulseWidth
01011 01EE 00FD 		MOVWF	Param7D
01012 01EF 0008 		RETURN
01013 01F0 	;
01014 01F0 	;=====================================================================================
01015 01F0 	; Less or Equal
01016 01F0 	;
01017 01F0 	; Entry: Param7D:Param7C, Param79:Param78
01018 01F0 	; Exit: Param77:0=Param7D:Param7C<=Param79:Param78
01019 01F0 	;
01020 01F0 01F7 	Param7D_LE_Param79	CLRF	Param77	;default to >
01021 01F1 0879 		MOVF	Param79,W
01022 01F2 027D 		SUBWF	Param7D,W	;Param7D-Param79
01023 01F3 		SKPNB		;Param7D<Param79?
01023 01F3 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
01024 01F4 29FD 		GOTO	SetTrue	; Yes
01025 01F5 		SKPZ		;Param7D>Param79?
01025 01F5 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
01026 01F6 0008 		RETURN		; Yes
01027 01F7 0878 		MOVF	Param78,W	; No, MSB is a match
01028 01F8 027C 		SUBWF	Param7C,W	;Param7C-Param78
01029 01F9 		SKPNB		;Param7C<Param78?
01029 01F9 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
01030 01FA 29FD 		GOTO	SetTrue	; Yes
01031 01FB 		SKPZ		;LSBs then same?
01031 01FB 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
01032 01FC 0008 		RETURN		; No
01033 01FD 	;
01034 01FD 1477 	SetTrue	BSF	Param77,0
01035 01FE 0008 		RETURN
01036 01FF 	;
01037 01FF 		if oldCode
01136 01FF 		endif
01137 01FF 	;=============================================================================================
01138 01FF 	;==============================================================================================
01139 01FF 	;
01140 01FF 		include	F1822_Common.inc
00001 01FF 	;=========================================================================================
00002 01FF 	; Commonly used routines PIC16F1822 version
00003 01FF 	;
00004 01FF 	;    Filename:      F1822 Common.inc
00005 01FF 	;    Date:          9/4/2014
00006 01FF 	;    File Version:  1.0.1
00007 01FF 	;
00008 01FF 	;    Author:        David M. Flynn
00009 01FF 	;    Company:       Oxford V.U.E., Inc.
00010 01FF 	;    E-Mail:        dflynn@oxfordvue.com
00011 01FF 	;    Web Site:      http://www.oxfordvue.com/
00012 01FF 	;
00013 01FF 	;=========================================================================================
00014 01FF 	;    History:
00015 01FF 	;
00016 01FF 	; 1.0.1 9/4/2014	Updated from F1847 Common.inc
00017 01FF 	; 1.0   11/16/2013	Updated from F648A Common.inc
00018 01FF 	;
00019 01FF 	;=========================================================================================
00020 01FF 	; Routines:
00021 01FF 	;
RocketServo.asm                                                       Page: 12
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00022 01FF 	; ClearRam	(2+0) Clears all RAM, call once before initializing variables, FSR0
00023 01FF 	; CopyToRam	(1+0) copy param memory (EEPROM) to ram, call once, FSR0
00024 01FF 	; SaveParams	(1+0) copy ram to param memory (EEPROM), FSR0
00025 01FF 	; TX_TheByte	(0+0) Send one byte to UART
00026 01FF 	; RX_TheByte	(0+0) Receive one byte from UART
00027 01FF 	;
00028 01FF 	; DecTimer4	(0+0) Decrement routine for 16 bit timers, FSR0
00029 01FF 	; DecTimer3
00030 01FF 	; DecTimer2
00031 01FF 	; DecTimer1
00032 01FF 	;
00033 01FF 	; TestT4_Zero	Test for 16 bit timers = zero
00034 01FF 	; TestT3_Zero	If Timer is zero return Z flag,1 else Z=0
00035 01FF 	; TestT2_Zero
00036 01FF 	; TestT1_Zero
00037 01FF 	;
00038 01FF 	; Delay10uS	(0+0)Delay uS    1 cycle = 1uS, 8Mhz clock version
00039 01FF 	; Delay100uS
00040 01FF 	; Delay40uS
00041 01FF 	; DelayWuS
00042 01FF 	;
00043 01FF 	; EEReadW	(0+0) Read EEPROM address in W
00044 01FF 	; EERead	(0+0) Read EEPROM address in EEAddrTemp
00045 01FF 	; EEWriteW	(0+0) Write EEPROM address in W, Data in EEDataTemp
00046 01FF 	; EEWrite	(0+0) Write EEPROM address in EEAdrTemp, Data in EEDataTemp, FSR0
00047 01FF 	;
00048 01FF 	; StoreSerIn	Put the byte in W into the serial input buffer, FSR0
00049 01FF 	; GetSerIn	Get a byte from the serial input buffer, FSR0
00050 01FF 	; GetSerOutBytes	Get the number of bytes in the serial ouput buffer
00051 01FF 	; StoreSerOut	Put the byte in W into the serial output buffer, FSR0
00052 01FF 	; POP_SerOut	Remove the last char stored in the output buffer
00053 01FF 	; GetSerOut	Get a byte from the serial Output buffer, FSR0
00054 01FF 	;
00055 01FF 	;=========================================================================================
00056 01FF 	; Clears all RAM
00057 01FF 	; Entry: none
00058 01FF 	; Exit: none
00059 01FF 	; RAM used: All
00060 01FF 	; Calls:(2+0) ClearRam_L2
00061 01FF 	;
00062 01FF 0020 	ClearRam	MOVLB	0x00
00063 0200 305F 		MOVLW	0x5F	;Clear 20h-7Eh, 95 bytes
00064 0201 00FF 		MOVWF	Param7F
00065 0202 3020 		MOVLW	0x20
00066 0203 0084 		MOVWF	FSR0
00067 0204 0185 		CLRF	FSR0H
00068 0205 220A 		CALL	ClearRam_L2
00069 0206 	;
00070 0206 3020 		MOVLW	0x20	;Clear A0h-BFh, 32 bytes
00071 0207 00FF 		MOVWF	Param7F
00072 0208 30A0 		MOVLW	0xA0
00073 0209 0084 		MOVWF	FSR0
00074 020A 	;
00075 020A 0180 	ClearRam_L2	CLRF	INDF0
00076 020B 0A84 		INCF	FSR0,F
00077 020C 0BFF 		DECFSZ	Param7F,F
00078 020D 2A0A 		GOTO	ClearRam_L2
00079 020E 0008 		RETURN
00080 020F 	;
00081 020F 	;==========================================================================
00082 020F 	; copy param memory to ram
00083 020F 	;
00084 020F 	CopyToRam:
00085 020F 0020  a		MOVLB	EEAddrTemp	;banksel
00084 0210 		BankSel	EEAddrTemp
00086 0210 3000 		MOVLW	nvFirstParamByte
00087 0211 00A6 		MOVWF	EEAddrTemp
00088 0212 3034 		MOVLW	FirstRAMParam
00089 0213 0084 		MOVWF	FSR0
00090 0214 0185 		CLRF	FSR0H
00091 0215 2257 	CopyToRam_L1	CALL	EERead
00092 0216 0080 		MOVWF	INDF0
00093 0217 3038 		MOVLW	LastRAMParam
00094 0218 0204 		SUBWF	FSR0,W
00095 0219 		SKPNZ
00095 0219 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00096 021A 0008 		RETURN
00097 021B 0A84 		INCF	FSR0,F
00098 021C 0AA6 		INCF	EEAddrTemp,F
00099 021D 2A15 		GOTO	CopyToRam_L1
00100 021E 	;
00101 021E 	;===========================================================================
00102 021E 	; copy ram to param memory
00103 021E 	;
00104 021E 	SaveParams:
00105 021E 0020  a		MOVLB	EEAddrTemp	;banksel
00104 021F 		BankSel	EEAddrTemp
00106 021F 3000 		MOVLW	nvFirstParamByte
00107 0220 00A6 		MOVWF	EEAddrTemp
00108 0221 3034 		MOVLW	FirstRAMParam
00109 0222 0084 		MOVWF	FSR0
00110 0223 0185 		CLRF	FSR0H
00111 0224 0800 	SaveParams_L1	MOVF	INDF0,W
00112 0225 00A7 		MOVWF	EEDataTemp
00113 0226 2261 		CALL	EEWrite
00114 0227 3038 		MOVLW	LastRAMParam	;last byte
00115 0228 0204 		SUBWF	FSR0,W
00116 0229 		SKPNZ
00116 0229 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
RocketServo.asm                                                       Page: 13
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00117 022A 0008 		RETURN
00118 022B 0A84 		INCF	FSR0,F
00119 022C 0AA6 		INCF	EEAddrTemp,F
00120 022D 2A24 		GOTO	SaveParams_L1
00121 022E 	;
00122 022E 	;=====================================================================================================
00123 022E 	;=========================================================================================================
00124 022E 	; Decrement routine for 16 bit timers
00125 022E 	;
00126 022E 302F 	DecTimer4	movlw	Timer4Hi
00127 022F 2A35 		goto	DecTimer
00128 0230 302D 	DecTimer3	movlw	Timer3Hi
00129 0231 2A35 		goto	DecTimer
00130 0232 302B 	DecTimer2	movlw	Timer2Hi
00131 0233 2A35 		goto	DecTimer
00132 0234 3029 	DecTimer1	movlw	Timer1Hi
00133 0235 	;DecTimer
00134 0235 	; entry: FSR=Timer(n)Hi
00135 0235 0084 	DecTimer	MOVWF	FSR0L
00136 0236 0185 		CLRF	FSR0H	;Timers must be in bank 0
00137 0237 0013 		moviw	FSR0--	;TimerNHi
00138 0238 0400 		IORWF	INDF0,W	;TimerNLo
00139 0239 		SKPNZ
00139 0239 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00140 023A 0008 		RETURN
00141 023B 3001 		MOVLW	0x01
00142 023C 0280 		SUBWF	INDF0,F	;TimerNLo
00143 023D 0A84 		INCF	FSR0L,F
00144 023E 3000 		MOVLW	0x00
00145 023F 3B80 		SUBWFB	INDF0,F	;TimerNHi
00146 0240 0008 		RETURN
00147 0241 	;
00148 0241 	;==============================================================================================
00149 0241 	; Test for 16 bit timers = zero
00150 0241 	;If Timer is zero return Z flag,1 else Z=0
00151 0241 	;
00152 0241 082E 	TestT4_Zero	movf	Timer4Lo,W
00153 0242 042F 		iorwf	Timer4Hi,W
00154 0243 0008 		return
00155 0244 	;
00156 0244 082C 	TestT3_Zero	movf	Timer3Lo,W
00157 0245 042D 		iorwf	Timer3Hi,W
00158 0246 0008 		return
00159 0247 	;
00160 0247 082A 	TestT2_Zero	movf	Timer2Lo,W
00161 0248 042B 		iorwf	Timer2Hi,W
00162 0249 0008 		return
00163 024A 	;
00164 024A 0828 	TestT1_Zero	movf	Timer1Lo,W
00165 024B 0429 		iorwf	Timer1Hi,W
00166 024C 0008 		return
00167 024D 	;
00168 024D 	;======================================================================================
00169 024D 	;Delay uS    1 cycle = 1uS, 8Mhz clock version
00170 024D 	; RAM used: Param77
00171 024D 	; Calls:(0) none
00172 024D 3005 	Delay10uS	MOVLW	0x05	;(2*3+5)/2=10
00173 024E 2A52 		GOTO	DelayWuS
00174 024F 3041 	Delay100uS	MOVLW	d'65'	;(28*3+5)/2=100
00175 0250 2A52 		GOTO	DelayWuS
00176 0251 3019 	Delay40uS	MOVLW	d'25'	;(11*3+5)=40
00177 0252 00F7 	DelayWuS	MOVWF	Param77
00178 0253 0BF7 	DelayWuS_Loop	DECFSZ	Param77,F
00179 0254 2A53 		GOTO	DelayWuS_Loop
00180 0255 0008 		RETURN
00181 0256 	;
00182 0256 	;==============================================================================================
00183 0256 	; Read EEPROM
00184 0256 	; entry: EEPROM address to read in W
00185 0256 	;        Bank 0 selected
00186 0256 	; exit: W=EEDATA, Bank 0 selected
00187 0256 	;
00188 0256 00A6 	EEReadW	movwf	EEAddrTemp
00189 0257 	;
00190 0257 	;==============================================================================================
00191 0257 	; Read EEPROM
00192 0257 	; entry: EEPROM address to read in EEAddrTemp
00193 0257 	;        Bank 0 selected
00194 0257 	; exit: W=EEDATA, Bank 0 selected
00195 0257 	;
00196 0257 0826 	EERead	MOVF	EEAddrTemp,W	;Data Memory
00197 0258 0023  a		MOVLB	EEADRL	;banksel
00196 0259 		BANKSEL	EEADRL
00198 0259 0091 		MOVWF	EEADRL	;Address to read
00199 025A 	;
00200 025A 1315 		BCF	EECON1,CFGS	;Deselect Config space
00201 025B 1395 		BCF	EECON1,EEPGD	;Point to DATA memory
00202 025C 1415 		BSF	EECON1,RD	;EE Read
00203 025D 0813 		MOVF	EEDATL,W	;W = EEDATL
00204 025E 0020 		MOVLB	0x00	;Bank 0
00205 025F 0008 		return
00206 0260 	;
00207 0260 	;==============================================================================================
00208 0260 	; Write EEPROM
00209 0260 	; entry: EEPROM address to write in W
00210 0260 	;        EEPROM data to write in EEDataTemp
00211 0260 	;        Bank 0 selected
00212 0260 	; exit: Bank 0 selected
00213 0260 	;
RocketServo.asm                                                       Page: 14
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00214 0260 00A6 	EEWriteW	movwf	EEAddrTemp
00215 0261 	;
00216 0261 	;==============================================================================================
00217 0261 	; Write EEPROM
00218 0261 	; entry: EEPROM address to write in EEAdrTemp
00219 0261 	;        EEPROM data to write in EEDataTemp
00220 0261 	;        Bank 0 selected
00221 0261 	; exit: Bank 0 selected
00222 0261 	;
00223 0261 0826 	EEWrite	MOVF	EEAddrTemp,W
00224 0262 0023  a		MOVLB	EEADRL	;banksel
00223 0263 		BANKSEL	EEADRL
00225 0263 0091 		MOVWF	EEADRL	;Data Memory Address to write
00226 0264 0020  a		MOVLB	EEDataTemp	;banksel
00225 0265 		BankSel	EEDataTemp
00227 0265 0827 		MOVF	EEDataTemp,W
00228 0266 0023  a		MOVLB	EEDATL	;banksel
00227 0267 		BANKSEL	EEDATL
00229 0267 0093 		MOVWF	EEDATL	;Data Memory Value to write
00230 0268 1315 		BCF	EECON1,CFGS	;Deselect Configuration space
00231 0269 1395 		BCF	EECON1,EEPGD	;Point to DATA memory
00232 026A 138B 		BCF	INTCON,GIE	;Disable INTs.
00233 026B 1515 		BSF	EECON1,WREN	;Enable writes
00234 026C 3055 		MOVLW	0x55
00235 026D 0096 		MOVWF	EECON2	;Write 55h
00236 026E 30AA 		MOVLW	0xAA
00237 026F 0096 		MOVWF	EECON2	;Write AAh
00238 0270 1495 		BSF	EECON1,WR	;Set WR bit to begin write
00239 0271 178B 		BSF	INTCON,GIE	;Enable Interrupts
00240 0272 1115 		BCF	EECON1,WREN	;Disable writes
00241 0273 1895 	EEWriteLoop	BTFSC	EECON1,WR	;Wait for write to complete
00242 0274 2A73 		GOTO	EEWriteLoop
00243 0275 0020 		MOVLB	0x00	;Bank 0
00244 0276 0008 		return
00245 0277 	;
00246 0277 	;=========================================================================================================
00247 0277 		IF useRS232
00396 0277 		ENDIF
00397 0277 	;
00398 0277 	;
00399 0277 	;
01141 0277 	;
01142 0277 	;=========================================================================================
01143 0277 	;=========================================================================================
01144 0277 	;
01145 0277 	;
01146 0277 	;
01147 0277 	;
01148 0277 		END

X-Ref Table
ActivationTime	012C 	HomeServo, ML_Btns_End
ADCON0	009D 	ReadAN0, ReadAN0_L1, ReadAN0_ColdStart
ADCON1	009E 	ReadAN0_ColdStart
ADGO	0001 	ReadAN0_L1
ADON	0000 	ReadAN0
ADRESH	009C 	ReadAN0_L1
ADRESL	009B 	ReadAN0_L1
ANSELA	018C 	start
APFCON	011D 	start
BtnChangeRate	0002 	ML_Btns_Inc, ML_Btns_Dec
C	0000 	ClampInt, ClampInt_1, Param7D_LE_Param79
CalcdDwell	0075 	IRQ_Servo1_1
CalcdDwellH	0076 	IRQ_Servo1_1
CCP1CON	0293 	IRQ_2, IRQ_Servo1_1, IRQ_Servo1_OL, start, SS_Start_Loop
CCP1CON_Clr	0009 	IRQ_Servo1_1
CCP1CON_Int	000A 	IRQ_Servo1_1, IRQ_Servo1_OL
CCP1CON_Set	0008 	IRQ_Servo1_OL, SS_Start_Loop
CCP1IE	0002 	start
CCP1IF	0002 	IRQ_2, IRQ_Servo1_X
CCP1M0	0000 	IRQ_Servo1_1
CCP1SEL	0000 	start
CCPR1H	0292 	IRQ_Servo1_1, IRQ_Servo1_OL, SS_Start_Loop
CCPR1L	0291 	IRQ_Servo1_1, IRQ_Servo1_OL, SS_Start_Loop
CFGS	0006 	EERead, EEWrite
ClampInt ^	01CF 	ML_Btns_Inc, ML_Btns_Dec
ClampInt_1 ^	01DC 	ClampInt
ClampInt_tooHigh ^	01EB 	ClampInt
ClampInt_tooLow ^	01E6 	ClampInt_1
ClearRam ^	01FF 	start
ClearRam_L2 ^	020A 	ClearRam, ClearRam_L2
CmdInputBit	PORTA,3	ML_Btns_End
Copy7CToSig ^	0150 	Move_It_Now, SS_Start_Loop
Copy7CToSig_1 ^	0158 	Copy7CToSig, Copy7CToSig_1
CopyPos1ToDest ^	016A 	CopyPosToDest
CopyPos1ToTemp ^	0174 	CopyPosToTemp
CopyPos2ToDest ^	016F 	CopyPosToDest
CopyPos2ToTemp ^	0179 	CopyPosToTemp
CopyPosToDest ^	0167 	Move_It, SS_Start_Loop
CopyPosToTemp ^	0164 	ML_Btns_Inc, ML_Btns_Dec
CopyTempToPos ^	0161 	ML_Btns_Inc, ML_Btns_Dec
CopyTempToPos1 ^	017E 	CopyTempToPos
CopyTempToPos2 ^	0183 	CopyTempToPos
CopyToRam ^	020F 	start
CopyToRam_L1 ^	0215 	CopyToRam_L1
CurPos	0032 	Set_Dest_End, Move_It_NIP, Move_It_New, Move_It_Dest, Move_It_Now, SS_Start_Loop
		SetDestAsCur
DataChangedFlag	Flags,3	MainLoop, ML_Btns_Inc, ML_Btns_Dec, ML_Btns_Save
Debounce	0039 	ML_Btns_End, Rev_Debounce, ML_CmdNormal, Norm_Debounce
RocketServo.asm   X-Ref Table                                            Page: 15
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

DecBtnBit	PORTA,4	
DecBtnFlag	Flags,1	, MainLoop, ML_Btns_Dec
DecTimer ^	0235 	DecTimer4, DecTimer3, DecTimer2
DecTimer1 ^	0234 	
DecTimer2 ^	0232 	
DecTimer3 ^	0230 	
DecTimer4 ^	022E 	
Delay_1S ^	00B6 	Start_L1
Delay_L1 ^	00B8 	Delay_L1
DelayWuS ^	0252 	DecTimer
DelayWuS_Loop ^	0253 	DelayWuS_Loop
Dest	0030 	MainLoop, Set_Dest_End, Move_It_NIP, Move_It_Dest, CopyPos1ToDest, CopyPos2ToDest
		SS_Start_Loop, SetDestAsCur
EEAddrTemp	0026 	CopyToRam, CopyToRam_L1, SaveParams, SaveParams_L1, DelayWuS_Loop
		EERead, EEWrite
EEADRL	0191 	EERead, EEWrite
EECON1	0195 	EERead, EEWrite, EEWriteLoop
EECON2	0196 	EEWrite
EEDataTemp	0027 	SaveParams_L1, EEWrite
EEDATL	0193 	EERead, EEWrite
EEPGD	0007 	EERead, EEWrite
EERead ^	0257 	CopyToRam_L1
EEWrite ^	0261 	SaveParams_L1
EEWriteLoop ^	0273 	EEWriteLoop
F	0001 	, SystemBlink_Blinking, SystemBlink_end, IRQ_Servo1_1, IRQ_Servo1_OL, start
		ML_Btns_Inc, ML_Btns_Dec, Rev_Debounce, ML_CmdNormal, Norm_Debounce, Set_Dest_End
		Move_It_NIP, Move_It_Neg, SS_Start_Loop, ClearRam_L2, CopyToRam_L1, SaveParams_L1
		DecTimer, DelayWuS_Loop
FirstRAMParam	Position1	CopyToRam, SaveParams
Flags	0072 	, SystemBlink_end, IRQ_2, start, HomeServo, MainLoop, ML_Btns_Inc, ML_Btns_Dec
		ML_Btns_Save, ML_Btns_End, ML_CmdNormal, CopyTempToPos, CopyPosToTemp, CopyPosToDest
		StartServo, SS_Start_Loop
FSR0	0004 	ClearRam, ClearRam_L2, CopyToRam, CopyToRam_L1, SaveParams, SaveParams_L1
FSR0H	0005 	, ClearRam, CopyToRam, SaveParams, DecTimer
FSR0L	0004 	DecTimer
GIE	0007 	start, Copy7CToSig_1, EEWrite
GO	0001 	ReadAN0_ColdStart
HasBattV	0001 	start
HoldOpen	0000 	ML_CmdNormal
HomeServo ^	00BD 	Start_L1
IncBtnBit	PORTA,2	
IncBtnFlag	Flags,0	, MainLoop
INDF0	0000 	ClearRam_L2, CopyToRam_L1, SaveParams_L1, DecTimer
InPosition	SysFlags,2	IRQ_Servo1_1, IRQ_Servo1_OL, Set_Dest_End, Move_It_NIP, SS_Start_Loop
InPosShutdown	SysFlags,1	IRQ_Servo1_1, IRQ_Servo1_OL
INTCON	000B 	start, Copy7CToSig_1, EEWrite
IRQ_2 ^	002F 	
IRQ_Servo1_1 ^	0038 	IRQ_2
IRQ_Servo1_End ^	005E 	IRQ_2
IRQ_Servo1_OL ^	0050 	IRQ_Servo1_1
IRQ_Servo1_X ^	005C 	IRQ_2, IRQ_Servo1_1
kDefaultPosition1	0E10 	EEWriteLoop
kDefaultPosition2	0898 	EEWriteLoop
kInPosShutdown	0002 	EEWriteLoop
kMaxPulseWidth	1068 	ClampInt, ClampInt_tooHigh
kMidPulseWidth	0BB8 	MainLoop, SS_Start_Loop
kMinPulseWidth	0708 	ClampInt_1, ClampInt_tooLow
kServoDwellTime	7D00 	IRQ_Servo1_1, IRQ_Servo1_OL
LastRAMParam	SysFlags	CopyToRam_L1, SaveParams_L1
LED_Blinks	0025 	, SystemBlink_Blinking, start, Start_L1, LongFlash, LongFlash_L1
LED_Ticks	0023 	
LED_Time	0021 	, start, Start_L1, LongFlash
LED2_End ^	002E 	SystemBlink_end
LED2_Ticks	0024 	SystemBlink_end
LED2_Time	0022 	SystemBlink_end, start
LED2Flag	Flags,2	SystemBlink_end, HomeServo, ML_Btns_End, ML_CmdNormal, SS_Start_Loop
LED2TrisBit	TRISA,2	, SystemBlink_end
LEDTIME	0064 	start, Start_L1
LongFlash ^	00AF 	start, Start_L1
LongFlash_L1 ^	00B3 	LongFlash_L1
MainLoop ^	00C5 	Start_L1, Move_End
ML_Btns_Dec ^	00E0 	MainLoop
ML_Btns_End ^	00F0 	MainLoop, ML_Btns_Inc, ML_Btns_Dec
ML_Btns_Inc ^	00D5 	MainLoop
ML_Btns_Save ^	00ED 	ML_Btns_Dec
ML_CmdNormal ^	0103 	ML_Btns_End
Move_End ^	014F 	Set_Dest_End
Move_It ^	0110 	ML_Btns_End, ML_CmdNormal
Move_It_Dest ^	0146 	Move_It_NIP, Move_It_Neg
Move_It_Neg ^	013E 	Move_It_NIP
Move_It_New ^	0139 	Move_It_Neg
Move_It_NIP ^	0122 	Set_Dest_End
Move_It_Now ^	014A 	Set_Dest_End, Move_It_New
NewSWData	Flags,6	, ML_Btns_End
Norm_Debounce ^	010E 	ML_CmdNormal
NOT_DONE	0001 	ReadAN0_L1
NOT_WPUEN	0007 	start
nvFirstParamByte	nvPosition1Lo	EEWriteLoop, CopyToRam, SaveParams
nvLastParamByte	nvSysFlags	EEWriteLoop
nvPosition1Hi	0001 	EEWriteLoop
nvPosition1Lo	0000 	EEWriteLoop, CopyToRam, SaveParams
nvPosition2Hi	0003 	EEWriteLoop
nvPosition2Lo	0002 	EEWriteLoop
nvSysFlags	0004 	EEWriteLoop
oldCode	0000 	ClearRam
OPTION_REG	0095 	start
OSCCON	0099 	start
OSCCON_Value	0072 	start
Param77	0077 	Move_It_NIP, Move_It_Neg, Param7D_LE_Param79, SetTrue, DelayWuS, DelayWuS_Loop
RocketServo.asm   X-Ref Table                                            Page: 16
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

Param78	0078 	Set_Dest_End, Move_It_NIP, Param7D_LE_Param79
Param79	0079 	Move_It_NIP, Param7D_LE_Param79
Param7C	007C 	start, ML_Btns_Inc, ML_Btns_Dec, Move_It_NIP, Move_It_New, Move_It_Neg
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToTemp, CopyPos2ToTemp, CopyTempToPos1
		CopyTempToPos2, ReadAN0, ReadAN0_L1, SS_Start_Loop, SetDestAsCur, ClampInt, ClampInt_1
		ClampInt_tooLow, ClampInt_tooHigh, Param7D_LE_Param79
Param7D	007D 	start, ML_Btns_Inc, ML_Btns_Dec, Move_It_NIP, Move_It_New, Move_It_Neg
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToTemp, CopyPos2ToTemp, CopyTempToPos1
		CopyTempToPos2, ReadAN0, ReadAN0_L1, SS_Start_Loop, SetDestAsCur, ClampInt, ClampInt_1
		ClampInt_tooLow, ClampInt_tooHigh, Param7D_LE_Param79
Param7D_LE_Param79 ^	01F0 	Move_It_NIP, Move_It_Neg
Param7F	007F 	ClearRam, ClearRam_L2
PCLATH	000A 	
PEIE	0006 	start
PIE1	0091 	start
PIR1	0011 	, IRQ_2, IRQ_Servo1_X
PORTA	000C 	, start, ML_Btns_End
PortADDRBits	00DF 	start
PortAValue	0000 	start
Position1	0034 	CopyPos1ToDest, CopyPos1ToTemp, CopyTempToPos1, CopyToRam, SaveParams
Position2	0036 	CopyPos2ToDest, CopyPos2ToTemp, CopyTempToPos2
PR2	001B 	start
PR2_Value	007D 	start
PS0	0000 	start
PS1	0001 	start
PS2	0002 	start
PSA	0003 	start
PulseSent	SysFlags,0	IRQ_2, Set_Dest_End
RD	0000 	EERead
ReadAN0 ^	0188 	start
ReadAN0_ColdStart ^	0196 	start, ReadAN0
ReadAN0_L1 ^	018D 	ReadAN0_L1
Rev_Debounce ^	0101 	ML_Btns_End
SaveParams ^	021E 	ML_Btns_Save
SaveParams_L1 ^	0224 	SaveParams_L1
ServoMoveTime	012C 	Move_It_NIP, SS_Start_Loop
ServoOff	Flags,4	IRQ_2, start, StartServo
Set_Dest_End ^	0111 	MainLoop, ML_Btns_End, Rev_Debounce, Norm_Debounce
SetDestAsCur ^	01C8 	SS_Start_Loop
SetTrue ^	01FD 	Param7D_LE_Param79
SigOutTime	0070 	IRQ_Servo1_1, Copy7CToSig, Copy7CToSig_1
SigOutTimeH	0071 	Copy7CToSig, Copy7CToSig_1
SlewChangeRate	0040 	Move_It_NIP, Move_It_Neg
SMRevFlag	Flags,5	HomeServo, ML_Btns_End, ML_CmdNormal, CopyTempToPos, CopyPosToTemp
		CopyPosToDest, SS_Start_Loop
SS_Start_Loop ^	01A2 	SS_Start_Loop
start ^	005F 	
Start_L1 ^	00A2 	Start_L1
StartServo ^	019E 	Start_L1
STATUS	0003 	, Start_L1, LongFlash_L1, Delay_L1, MainLoop, ML_Btns_End, ML_CmdNormal
		Set_Dest_End, Copy7CToSig, SS_Start_Loop, ClampInt, ClampInt_1, Param7D_LE_Param79
		CopyToRam_L1, SaveParams_L1, DecTimer
SysFlags	0038 	IRQ_2, IRQ_Servo1_1, IRQ_Servo1_OL, Set_Dest_End, Move_It_NIP, SS_Start_Loop
		CopyToRam_L1, SaveParams_L1
SysLEDTrisBit	TRISA,4	, SystemBlink_on
SystemBlink_Blinking ^	0022 	
SystemBlink_end ^	0025 	
SystemBlink_on ^	0023 	
T1CON	0018 	start
T1CON_Val	0001 	start
T1GCON	0019 	start
T2CON	001C 	start
T2CON_Value	004E 	start
Timer1Hi	0029 	DecTimer1, DecTimer
Timer1Lo	0028 	Delay_1S, Delay_L1, DecTimer
Timer2Hi	002B 	Set_Dest_End, Move_It_NIP, SS_Start_Loop, DecTimer2, DecTimer
Timer2Lo	002A 	Set_Dest_End, Move_It_NIP, SS_Start_Loop, DecTimer
Timer3Hi	002D 	HomeServo, ML_Btns_End, ML_CmdNormal, DecTimer3, DecTimer
Timer3Lo	002C 	HomeServo, ML_Btns_End, ML_CmdNormal, DecTimer
Timer4Hi	002F 	MainLoop, SS_Start_Loop, DecTimer4, DecTimer
Timer4Lo	002E 	start, MainLoop, ML_Btns_Inc, ML_Btns_Dec, SS_Start_Loop, DecTimer
TMR0CS	0005 	start
TMR1GE	0007 	start
TMR1H	0017 	SS_Start_Loop
TMR1L	0016 	SS_Start_Loop
TMR2IE	0001 	start
TMR2IF	0001 	
TRISA	008C 	, SystemBlink_on, SystemBlink_end, start
useRS232	0000 	EEWriteLoop
W	0000 	, SystemBlink_end, IRQ_Servo1_1, start, Start_L1, LongFlash_L1, Delay_L1
		MainLoop, ML_Btns_End, ML_CmdNormal, Set_Dest_End, Move_It_NIP, Move_It_New, Move_It_Dest
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToDest, CopyPos2ToDest, CopyPos1ToTemp
		CopyPos2ToTemp, CopyTempToPos1, CopyTempToPos2, ReadAN0_L1, SetDestAsCur, ClampInt
		ClampInt_1, Param7D_LE_Param79, CopyToRam_L1, SaveParams_L1, DecTimer, EERead, EEWrite
WDTCON	0097 	start
WR	0001 	EEWrite, EEWriteLoop
WREN	0002 	EEWrite
Z	0002 	, Start_L1, LongFlash_L1, Delay_L1, MainLoop, ML_Btns_End, ML_CmdNormal, Set_Dest_End
		Copy7CToSig, SS_Start_Loop, ClampInt, ClampInt_1, Param7D_LE_Param79, CopyToRam_L1
		SaveParams_L1, DecTimer
 

X-Ref Table (The UnCalled)
Delay100uS !	024F 	
Delay10uS !	024D 	
Delay40uS !	0251 	
EEReadW !	0256 	
EEWriteW !	0260 	
IRQ_Servo1 !	002F 	
RocketServo.asm   X-Ref Table                                            Page: 17
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

ReadAN0_Rtn !	019C 	
SetMiddlePosition !	01BF 	
SS_CmdNormal !	01A5 	
SS_Move_It !	01A8 	
SystemBlink_1 !	0018 	
TestT1_Zero !	024A 	
TestT2_Zero !	0247 	
TestT3_Zero !	0244 	
TestT4_Zero !	0241 	
 

Memory Usage Map ('X' = Used, '-' = Unused)
 
0000  : XXX-XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXX---------
 
Program Memory Words Used:630
Program Memory Words Free:1418
 
UserID
8000  :XXXX
 
Config
8007  :XX
 
EEPROM
F000  : XXXXX----------- ---------------- ---------------- ----------------
 
Data EEPROM Bytes Used:5
Data EEPROM Bytes Free:251
