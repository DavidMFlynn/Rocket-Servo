RocketServo.asm                                                       Page: 1
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00001 0000 	;====================================================================================================
00002 0000 	;
00003 0000 	;   Filename:	RocketServo.asm
00004 0000 	;   Date:	5/4/2023
00005 0000 	;   File Version:	1.1b3
00006 0000 	;
00007 0000 	;    Author:	David M. Flynn
00008 0000 	;    Company:	Oxford V.U.E., Inc.
00009 0000 	;    E-Mail:	dflynn@oxfordvue.com
00010 0000 	;    Web Site:	http://www.oxfordvue.com/
00011 0000 	;
00012 0000 	;====================================================================================================
00013 0000 	;    RC Servo Activator for high power rocketry uses PIC12F1822
00014 0000 	;
00015 0000 	;    History:
00016 0000 	; 1.1b3   8/6/2023	Added BP3Hold mode.
00017 0000 	; 1.1b2   5/4/2023	Fixed batt V blink, 10 or 11 blinks.
00018 0000 	; 1.1b1   12/28/2022	Added battery voltage sensing RA0 9.75C/V 3 for diode
00019 0000 	; 1.0b2   11/7/2022	Inverted CmdInputBit to active low
00020 0000 	; 1.0b1   8/31/2022    Copied from SM_Ctrl_RC_Servo.
00021 0000 	;
00022 0000 	;====================================================================================================
00023 0000 	; Options
00024 0000 0001 	HasBattV	EQU	1	;Set to 0 or 1
00025 0000 0001 	BP3Hold	EQU	1	;Hold at reverse value
00026 0000 	;====================================================================================================
00027 0000 	; To Do's
00028 0000 	;
00029 0000 	;====================================================================================================
00030 0000 	;====================================================================================================
00031 0000 	; What happens next:
00032 0000 	;
00033 0000 	;   The system LED blinks once per second
00034 0000 	;  Once at power-up:
00035 0000 	;   Blink battery voltage i.e. _ .........  .. _
00036 0000 	;   to do: Do not arm if <8.5V alkaline <7.5 NiMH
00037 0000 	;   Set position to the commanded position for 3 seconds.
00038 0000 	;
00039 0000 	;  Setup mode:
00040 0000 	;   If SW1 is pressed Increment the set value for the control condition.
00041 0000 	;   If SW2 is pressed Decrement the set value for the control condition.
00042 0000 	;
00043 0000 	;   If Control is High (active)
00044 0000 	;      move to set point 1 for 3 seconds
00045 0000 	;   else if Control is Low (Normal, Inactive)
00046 0000 	;      move to set point 2 for 3 seconds
00047 0000 	;
00048 0000 	;   CCP1 outputs a 900uS to 2100uS (1800..4200 counts) pulse every 16,000uS
00049 0000 	;
00050 0000 	;   Resolution is 0.5uS
00051 0000 	;
00052 0000 	;  if kInPosShutdown is set servo will power down after 3s
00053 0000 	;
00054 0000 	;====================================================================================================
00055 0000 	;
00056 0000 	;  Pin 1 VDD (+5V)		+5V
00057 0000 	;  Pin 2 RA5		CCP1
00058 0000 	;  Pin 3 RA4		System LED Active Low/SW2 Dec switch Active Low
00059 0000 	;  Pin 4 RA3/MCLR*/Vpp (Input only)	Command = Active Low
00060 0000 	;  Pin 5 RA2		LED 2 Active Low/SW1 Inc switch Active Low
00061 0000 	;  Pin 6 RA1/ICSPCLK		n/c
00062 0000 	;  Pin 7 RA0/ICSPDAT		AN0, Battery (volts-0.5)/21
00063 0000 	;  Pin 8 VSS (Ground)		Ground
00064 0000 	;
00065 0000 	;====================================================================================================
00066 0000 	;
00067 0000 	;
00068 0000 		list	p=12f1822,r=hex,w=1	; list directive to define processor
00069 0000 	;
00001 0000 		nolist
00002 0000 		nolist
00003 0000 	;==========================================================================
00004 0000 	; MPASM PIC12F1822 processor include
00005 0000 	;	
00006 0000 	; (c) Copyright 1999-2014 Microchip Technology, All rights reserved
00007 0000 	;==========================================================================
00008 0000 	;==========================================================================
01039 0000 		NOLIST
01040 0000 		NOLIST
00072 0000 		list
00073 0000 	;
00074 8007 EFA4 		__CONFIG _CONFIG1,_FOSC_INTOSC & _WDTE_OFF & _MCLRE_OFF & _IESO_OFF
00075 0000 	;
00076 0000 	;
00077 0000 	;
00078 0000 	; INTOSC oscillator: I/O function on CLKIN pin
00079 0000 	; WDT disabled
00080 0000 	; PWRT disabled
00081 0000 	; MCLR/VPP pin function is digital input
00082 0000 	; Program memory code protection is disabled
00083 0000 	; Data memory code protection is disabled
00084 0000 	; Brown-out Reset enabled
00085 0000 	; CLKOUT function is disabled. I/O or oscillator function on the CLKOUT pin
00086 0000 	; Internal/External Switchover mode is disabled
00087 0000 	; Fail-Safe Clock Monitor is enabled
00088 0000 	;
00089 8008 DEFF 		__CONFIG _CONFIG2,_WRT_OFF & _PLLEN_OFF & _LVP_OFF
00090 0000 	;
00091 0000 	; Write protection off
RocketServo.asm                                                       Page: 2
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00092 0000 	; 4x PLL disabled
00093 0000 	; Stack Overflow or Underflow will cause a Reset
00094 0000 	; Brown-out Reset Voltage (Vbor), low trip point selected.
00095 0000 	; Low-voltage programming Disabled ( allow MCLR to be digital in )
00096 0000 	;  *** must set apply Vdd before Vpp in ICD 3 settings ***
00097 0000 	;
00098 0000 	; '__CONFIG' directive is used to embed configuration data within .asm file.
00099 0000 	; The lables following the directive are located in the respective .inc file.
00100 0000 	; See respective data sheet for additional information on configuration word.
00101 0000 	;
00102 0000 		constant	oldCode=0
00103 0000 		constant	useRS232=0
00104 0000 	;
00105 0000 0003 	#Define	_C	STATUS,C
00106 0000 0003 	#Define	_Z	STATUS,Z
00107 0000 	;
00108 0000 	; 0.5uS res counter from 8MHz OSC
00109 0000 0009 	CCP1CON_Clr	EQU	b'00001001'	;Clear output on match
00110 0000 0008 	CCP1CON_Set	EQU	b'00001000'	;Set output on match
00111 0000 000A 	CCP1CON_Int	EQU	b'00001010'
00112 0000 	;
00113 0000 012C 	ActivationTime	EQU	d'300'	;3 seconds
00114 0000 07FF 	kOffsetCtrValue	EQU	d'2047'
00115 0000 0708 	kMinPulseWidth	EQU	d'1800'	;900uS
00116 0000 0BB8 	kMidPulseWidth	EQU	d'3000'	;1500uS
00117 0000 1068 	kMaxPulseWidth	EQU	d'4200'	;2100uS
00118 0000 		if BP3Hold
00119 0000 07D0 	kDefaultPosition1	EQU	d'2000'	;1000uS Locked
00120 0000 100E 	kDefaultPosition2	EQU	d'4110'	;2055uS Open
00121 0000 0001 	HoldOpen	EQU	1
00122 0000 		else
00126 0000 		endif
00127 0000 7D00 	kServoDwellTime	EQU	d'32000'	;16mS
00128 0000 0002 	kInPosShutdown	EQU	b'00000010'	;b'00000010' enabled 0x00 disabled
00129 0000 	;
00130 0000 	;====================================================================================================
00133 0000 		nolist
00134 0000 	;
00135 0000 	;    Port A bits
00136 0000 00DF 	PortADDRBits	EQU	b'11011111'
00137 0000 010C 	#Define	LED2	LATA,2	;Output: 0=LED ON, Input: 0 = Switch Pressed
00138 0000 008C 	#Define	LED2TrisBit	TRISA,2
00139 0000 000C 	#Define	IncBtnBit	PORTA,2
00140 0000 000C 	#Define	CmdInputBit	PORTA,3
00141 0000 010C 	#Define	SystemLED	LATA,4	;Output: 0=LED ON, Input: 0 = Switch Pressed
00142 0000 008C 	#Define	SysLEDTrisBit	TRISA,4
00143 0000 000C 	#Define	DecBtnBit	PORTA,4
00144 0000 000C 	#Define	RA5_In	PORTA,5	;CCP1
00145 0000 	;
00146 0000 0000 	PortAValue	EQU	b'00000000'
00147 0000 	;
00148 0000 	;====================================================================================================
00149 0000 	;====================================================================================================
00150 0000 	;
00151 0000 	;Constants
00152 0000 00FF 	All_In	EQU	0xFF
00153 0000 0000 	All_Out	EQU	0x00
00154 0000 	;
00155 0000 0064 	LEDTIME	EQU	d'100'	;1.00 seconds
00156 0000 000A 	LEDErrorTime	EQU	d'10'
00157 0000 	;
00158 0000 0001 	T1CON_Val	EQU	b'00000001'	;PreScale=1,Fosc/4,Timer ON
00159 0000 	;T1CON_Val	EQU	b'00100001'	;PreScale=4,Fosc/4,Timer ON
00160 0000 0072 	OSCCON_Value	EQU	b'01110010'	;8MHz
00161 0000 	;OSCCON_Value	EQU	b'11110000'	;32MHz
00162 0000 004E 	T2CON_Value	EQU	b'01001110'	;T2 On, /16 pre, /10 post
00163 0000 	;T2CON_Value	EQU	b'01001111'	;T2 On, /64 pre, /10 post
00164 0000 007D 	PR2_Value	EQU	.125
00165 0000 	;
00166 0000 	;
00167 0000 0000 	CCP1CON_Value	EQU	0x00	;CCP1 off
00168 0000 	;
00169 0000 	;================================================================================================
00170 0000 	;***** VARIABLE DEFINITIONS
00171 0000 	; there are 128 bytes of ram, Bank0 0x20..0x7F, Bank1 0xA0..0xBF
00172 0000 	; there are 256 bytes of EEPROM starting at 0x00 the EEPROM is not mapped into memory but
00173 0000 	;  accessed through the EEADR and EEDATA registers
00174 0000 	;================================================================================================
00175 0000 	;  Bank0 Ram 020h-06Fh 80 Bytes
00176 0000 	;
00177 0000 		cblock	0x20
00178 0000 	;
00179 0000 0020 		ISR_Temp		;scratch mem
00180 0000 0021 		LED_Time
00181 0000 0022 		LED2_Time
00182 0000 0023 		LED_Ticks		;Timer tick count
00183 0000 0024 		LED2_Ticks
00184 0000 0025 		LED_Blinks		;nBlinks, 0xFF=system blink, 0=Off
00185 0000 	;
00186 0000 	;
00187 0000 0026 		EEAddrTemp		;EEProm address to read or write
00188 0000 0027 		EEDataTemp		;Data to be writen to EEProm
00189 0000 	;
00190 0000 	;
00191 0000 0028 		Timer1Lo		;1st 16 bit timer
00192 0000 0029 		Timer1Hi		; not used
00193 0000 002A 		Timer2Lo		;2nd 16 bit timer
00194 0000 002B 		Timer2Hi		; Servo active timer
00195 0000 002C 		Timer3Lo		;3rd 16 bit timer
RocketServo.asm                                                       Page: 3
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00196 0000 002D 		Timer3Hi		; Activation timer
00197 0000 002E 		Timer4Lo		;4th 16 bit timer
00198 0000 002F 		Timer4Hi		; debounce timer and power up delay timer
00199 0000 	;
00200 0000 0030 		Dest:2
00201 0000 0032 		CurPos:2
00202 0000 	;
00203 0000 0034 		Position1:2
00204 0000 0036 		Position2:2
00205 0000 0038 		SysFlags
00206 0000 	;
00207 0000 0039 		Debounce
00208 0000 	;
00209 0000 		endc
00210 0000 	;
00211 0000 0038 	#Define	PulseSent	SysFlags,0
00212 0000 0038 	#Define	InPosShutdown	SysFlags,1
00213 0000 0038 	#Define	InPosition	SysFlags,2
00214 0000 	;
00215 0000 0034 	#Define	FirstRAMParam	Position1
00216 0000 0038 	#Define	LastRAMParam	SysFlags
00217 0000 	;
00218 0000 	;================================================================================================
00219 0000 	;  Bank1 Ram 0A0h-0BFh 32 Bytes
00220 0000 	;
00221 0000 	;
00222 0000 	;=======================================================================================================
00223 0000 	;  Common Ram 70-7F same for all banks
00224 0000 	;      except for ISR_W_Temp these are used for paramiter passing and temp vars
00225 0000 	;=======================================================================================================
00226 0000 	;
00227 0000 		cblock	0x70
00228 0000 0070 		SigOutTime
00229 0000 0071 		SigOutTimeH
00230 0000 0072 		Flags
00231 0000 	;
00232 0000 0073 		Param73
00233 0000 0074 		Param74
00234 0000 	;
00235 0000 0075 		CalcdDwell
00236 0000 0076 		CalcdDwellH
00237 0000 0077 		Param77
00238 0000 0078 		Param78
00239 0000 0079 		Param79
00240 0000 007A 		Param7A
00241 0000 007B 		Param7B
00242 0000 007C 		Param7C
00243 0000 007D 		Param7D
00244 0000 007E 		Param7E
00245 0000 007F 		Param7F
00246 0000 		endc
00247 0000 	;
00248 0000 	; Flags bits
00249 0000 0072 	#Define	IncBtnFlag	Flags,0
00250 0000 0072 	#Define	DecBtnFlag	Flags,1
00251 0000 0072 	#Define	LED2Flag	Flags,2
00252 0000 0072 	#Define	DataChangedFlag	Flags,3
00253 0000 0072 	#Define	ServoOff	Flags,4
00254 0000 0072 	#Define	SMRevFlag	Flags,5
00255 0000 0072 	#Define	NewSWData	Flags,6
00256 0000 	;
00257 0000 012C 	ServoMoveTime	EQU	.300	;time servo is powered when CMD changes
00258 0000 	;
00259 0000 	;=========================================================================================
00260 0000 	;Conditionals
00261 0000 0080 	HasISR	EQU	0x80	;used to enable interupts 0x80=true 0x00=false
00262 0000 	;
00263 0000 	;=========================================================================================
00264 0000 	;==============================================================================================
00265 0000 	; ID Locations
00266 0000 		__idlocs	0x11B1
00267 0000 	;
00268 0000 	;==============================================================================================
00269 0000 	; EEPROM locations (NV-RAM) 0x00..0x7F (offsets)
00270 0000 		org	0xF000
00271 F000 	;
00272 F000 00D0 		de	LOW kDefaultPosition1	;nvPosition1Lo
00273 F001 0007 		de	HIGH kDefaultPosition1
00274 F002 000E 		de	LOW kDefaultPosition2
00275 F003 0010 		de	HIGH kDefaultPosition2
00276 F004 	;
00277 F004 0002 		de	kInPosShutdown	;nvSysFlags
00278 F005 	;
00279 F005 		cblock	0x00
00280 F005 0000 		nvPosition1Lo
00281 F005 0001 		nvPosition1Hi
00282 F005 0002 		nvPosition2Lo
00283 F005 0003 		nvPosition2Hi
00284 F005 	;
00285 F005 0004 		nvSysFlags
00286 F005 		endc
00287 F005 	;
00288 F005 0000 	#Define	nvFirstParamByte	nvPosition1Lo
00289 F005 0004 	#Define	nvLastParamByte	nvSysFlags
00290 F005 	;
00291 F005 	;
00292 F005 	;==============================================================================================
00293 F005 	;============================================================================================
00294 F005 	;
RocketServo.asm                                                       Page: 4
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00295 F005 	;
00296 F005 		ORG	0x000	; processor reset vector
00297 0000 0183 		CLRF	STATUS
00298 0001 018A 		CLRF	PCLATH
00299 0002 285F 	  	goto	start	; go to beginning of program
00300 0003 	;
00301 0003 	;===============================================================================================
00302 0003 	; Interupt Service Routine
00303 0003 	;
00304 0003 	; we loop through the interupt service routing every 0.01 seconds
00305 0003 	;
00306 0003 	;
00307 0003 		ORG	0x004	; interrupt vector location
00308 0004 0020 		movlb	0	; bank0
00309 0005 	;
00310 0005 1C91 		btfss	PIR1,TMR2IF
00311 0006 282F 		goto	IRQ_2
00312 0007 1091 		bcf	PIR1,TMR2IF	; reset interupt flag bit
00313 0008 	;
00314 0008 	;Decrement timers until they are zero
00315 0008 	;
00316 0008 0185 		CLRF	FSR0H
00317 0009 2233 		call	DecTimer1	;if timer 1 is not zero decrement
00318 000A 2231 		call	DecTimer2
00319 000B 222F 		call	DecTimer3
00320 000C 222D 		call	DecTimer4
00321 000D 	;
00322 000D 	;-----------------------------------------------------------------
00323 000D 	; blink LEDs
00324 000D 0021 		movlb                  1                      ;bank 1
00325 000E 160C 		BSF	SysLEDTrisBit	;LED off
00326 000F 150C 		BSF	LED2TrisBit	;LED2 off
00327 0010 	;
00328 0010 0020 		movlb	0	;bank 0
00329 0011 1072 		BCF	IncBtnFlag
00330 0012 1D0C 		BTFSS	IncBtnBit
00331 0013 1472 		BSF	IncBtnFlag
00332 0014 	;
00333 0014 10F2 		BCF	DecBtnFlag
00334 0015 1E0C 		BTFSS	DecBtnBit
00335 0016 14F2 		BSF	DecBtnFlag
00336 0017 	;
00337 0017 1772 		bsf	NewSWData	;New data every 0.01s
00338 0018 	;
00339 0018 0BA3 	SystemBlink_1	DECFSZ	LED_Ticks,F	;Time to blink?
00340 0019 320B 		bra	SystemBlink_end	; no
00341 001A 	;
00342 001A 0821 		MOVF	LED_Time,W
00343 001B 00A3 		movwf	LED_Ticks
00344 001C 	;
00345 001C 08A5 		movf	LED_Blinks,F	;nBlinks, 0xFF=system blink, 0=Off
00346 001D 		SKPNZ
00346 001D 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00347 001E 3206 		BRA	SystemBlink_end
00348 001F 0F25 		incfsz	LED_Blinks,W
00349 0020 3201 		BRA	SystemBlink_Blinking
00350 0021 3201 		BRA	SystemBlink_on
00351 0022 03A5 	SystemBlink_Blinking	decf	LED_Blinks,F
00352 0023 0021 	SystemBlink_on	movlb                  1                      ;bank 1
00353 0024 120C 		BCF	SysLEDTrisBit	;LED on
00354 0025 0020 	SystemBlink_end	MOVLB	0                      ;bank 0
00355 0026 	;
00356 0026 0BA4 		decfsz	LED2_Ticks,F
00357 0027 3206 		bra	LED2_End
00358 0028 	;
00359 0028 0822 		MOVF	LED2_Time,W
00360 0029 00A4 		movwf	LED2_Ticks
00361 002A 	;
00362 002A 1D72 		BTFSS	LED2Flag
00363 002B 3202 		bra                    LED2_End
00364 002C 0021 		movlb                  1                      ;bank 1
00365 002D 110C 		BCF	LED2TrisBit
00366 002E 	;
00367 002E 0020 	LED2_End	MOVLB	0
00368 002F 	;-----------------------------------------------------------------
00369 002F 	;
00370 002F 	IRQ_2:
00371 002F 	;==================================================================================
00372 002F 	;
00373 002F 	; Handle CCP1 Interupt Flag, Enter w/ bank 0 selected
00374 002F 	;
00375 002F 0020 	IRQ_Servo1	MOVLB	0	;bank 0
00376 0030 1D11 		BTFSS	PIR1,CCP1IF
00377 0031 285E 		GOTO	IRQ_Servo1_End
00378 0032 	;
00379 0032 1438 		BSF	PulseSent
00380 0033 1E72 		BTFSS	ServoOff	;Are we sending a pulse?
00381 0034 2838 		GOTO	IRQ_Servo1_1	; Yes
00382 0035 	;
00383 0035 	;Oops, how did we get here???
00384 0035 0025 		MOVLB	0x05                   ;Bank 5
00385 0036 0193 		CLRF	CCP1CON
00386 0037 285C 		GOTO	IRQ_Servo1_X
00387 0038 	;
00388 0038 0025 	IRQ_Servo1_1	MOVLB	0x05                   ;Bank 5
00389 0039 1813 		BTFSC	CCP1CON,CCP1M0	;Set output on match?
00390 003A 2850 		GOTO	IRQ_Servo1_OL	; No
00391 003B 	; An output just went high
00392 003B 	;
RocketServo.asm                                                       Page: 5
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00393 003B 0870 		MOVF	SigOutTime,W	;Put the pulse into the CCP reg.
00394 003C 0791 		ADDWF	CCPR1L,F
00395 003D 0871 		MOVF	SigOutTime+1,W
00396 003E 3D92 		ADDWFC	CCPR1H,F
00397 003F 0020 		movlb	0	;Bank 0
00398 0040 300A 		movlw	CCP1CON_Int
00399 0041 1CB8 		btfss	InPosShutdown
00400 0042 3009 		MOVLW	CCP1CON_Clr	;Clear output on match
00401 0043 1D38 		btfss	InPosition
00402 0044 3009 		MOVLW	CCP1CON_Clr	;Clear output on match
00403 0045 0025 		movlb	5	;Bank 5
00404 0046 0093 		MOVWF	CCP1CON	;CCP1 clr on match
00405 0047 	;Calculate dwell time
00406 0047 3000 		MOVLW	LOW kServoDwellTime
00407 0048 00F5 		MOVWF	CalcdDwell
00408 0049 307D 		MOVLW	HIGH kServoDwellTime
00409 004A 00F6 		MOVWF	CalcdDwellH
00410 004B 0870 		MOVF	SigOutTime,W
00411 004C 02F5 		SUBWF	CalcdDwell,F
00412 004D 0871 		MOVF	SigOutTime+1,W
00413 004E 3BF6 		SUBWFB	CalcdDwellH,F
00414 004F 285C 		GOTO	IRQ_Servo1_X
00415 0050 	;
00416 0050 	; output went low so this cycle is done
00417 0050 3000 	IRQ_Servo1_OL	MOVLW	LOW kServoDwellTime
00418 0051 0791 		ADDWF	CCPR1L,F
00419 0052 307D 		MOVLW	HIGH kServoDwellTime
00420 0053 3D92 		ADDWFC	CCPR1H,F
00421 0054 	;
00422 0054 0020 		movlb	0	;Bank 0
00423 0055 300A 		movlw	CCP1CON_Int
00424 0056 1CB8 		btfss	InPosShutdown
00425 0057 3008 		MOVLW	CCP1CON_Set	;Set output on match
00426 0058 1D38 		btfss	InPosition
00427 0059 3008 		MOVLW	CCP1CON_Set	;Set output on match
00428 005A 0025 		movlb	5	;Bank 5
00429 005B 0093 		MOVWF	CCP1CON	;Idle output low
00430 005C 	;
00431 005C 0020 	IRQ_Servo1_X	MOVLB	0x00                   ;Bank 0
00432 005D 1111 		BCF	PIR1,CCP1IF
00433 005E 	IRQ_Servo1_End:
00434 005E 	;--------------------------------------------------------------------
00435 005E 	;
00436 005E 0009 		retfie		; return from interrupt
00437 005F 	;
00438 005F 	;
00439 005F 	;==============================================================================================
00440 005F 	;**********************************************************************************************
00441 005F 	;==============================================================================================
00442 005F 	;
00443 005F 0021 	start	MOVLB	0x01	; select bank 1
00444 0060 1795 		bsf	OPTION_REG,NOT_WPUEN	; disable pullups on port B
00445 0061 1295 		bcf	OPTION_REG,TMR0CS	; TMR0 clock Fosc/4
00446 0062 1195 		bcf	OPTION_REG,PSA	; prescaler assigned to TMR0
00447 0063 1415 		bsf	OPTION_REG,PS0	;111 8mhz/4/256=7812.5hz=128uS/Ct=0.032768S/ISR
00448 0064 1495 		bsf	OPTION_REG,PS1	;101 8mhz/4/64=31250hz=32uS/Ct=0.008192S/ISR
00449 0065 1515 		bsf	OPTION_REG,PS2
00450 0066 	;
00451 0066 3072 		MOVLW	OSCCON_Value
00452 0067 0099 		MOVWF	OSCCON
00453 0068 3017 		movlw	b'00010111'	; WDT prescaler 1:65536 period is 2 sec (RESET value)
00454 0069 0097 		movwf	WDTCON
00455 006A 	;
00456 006A 0023 		MOVLB	0x03	; bank 3
00457 006B 	;
00458 006B 		if HasBattV
00459 006B 3001 		MOVLW	0x01
00460 006C 		else
00462 006C 		endif
00463 006C 	;
00464 006C 008C 		MOVWF	ANSELA	;AN0 only
00465 006D 	;
00466 006D 	; setup timer 1 for 0.5uS/count
00467 006D 	;
00468 006D 0020 		movlb	0	; bank 0
00469 006E 3001 		MOVLW	T1CON_Val
00470 006F 0098 		MOVWF	T1CON
00471 0070 1399 		bcf	T1GCON,TMR1GE
00472 0071 	;
00473 0071 	; clear memory to zero
00474 0071 21FE 		CALL	ClearRam
00475 0072 	;
00476 0072 	; Setup timer 2 for 0.01S/Interupt
00477 0072 304E 		MOVLW	T2CON_Value	;Setup T2 for 100/s
00478 0073 009C 		MOVWF	T2CON
00479 0074 307D 		MOVLW	PR2_Value
00480 0075 009B 		MOVWF	PR2
00481 0076 0021 		MOVLB	1	;Bank 1
00482 0077 1491 		BSF	PIE1,TMR2IE
00483 0078 0020 		movlb	0                      ;Bank 0
00484 0079 	;
00485 0079 	; setup ccp1
00486 0079 	;
00487 0079 1672 		BSF	ServoOff
00488 007A 0022 		movlb	2                      ;bank 2
00489 007B 141D 		BSF	APFCON,CCP1SEL	;RA5
00490 007C 0025 		movlb	5                      ;bank 5
00491 007D 0193 		CLRF	CCP1CON
00492 007E 	;
RocketServo.asm                                                       Page: 6
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00493 007E 0021 		MOVLB	0x01	;Bank 1
00494 007F 1511 		bsf	PIE1,CCP1IE
00495 0080 	;
00496 0080 	; setup data ports
00497 0080 0020 		movlb                  0                      ;bank 0
00498 0081 3000 		MOVLW	PortAValue
00499 0082 008C 		MOVWF	PORTA	;Init PORTA
00500 0083 0021 		movlb                  1                      ;bank 1
00501 0084 30DF 		MOVLW	PortADDRBits
00502 0085 008C 		MOVWF	TRISA
00503 0086 	;
00504 0086 0020 		MOVLB	0	;bank 0
00505 0087 0064 		CLRWDT
00506 0088 	;
00507 0088 3064 		MOVLW	LEDTIME
00508 0089 00A1 		MOVWF	LED_Time
00509 008A 3001 		movlw	0x01	;continuos ON
00510 008B 00A2 		movwf	LED2_Time
00511 008C 	;
00512 008C 0064 		CLRWDT
00513 008D 220E 		CALL	CopyToRam
00514 008E 0064 		CLRWDT
00515 008F 	;
00516 008F 	;
00517 008F 170B 		bsf	INTCON,PEIE	; enable periferal interupts
00518 0090 	;	bsf	INTCON,T0IE	; enable TMR0 interupt
00519 0090 178B 		bsf	INTCON,GIE	; enable interupts
00520 0091 	;
00521 0091 0020 		MOVLB	0x00	;bank 0
00522 0092 3004 		movlw	0x04
00523 0093 00AE 		movwf	Timer4Lo	;power up delay
00524 0094 	;
00525 0094 	;=========================================================================================
00526 0094 	;=========================================================================================
00527 0094 	;  Main Loop
00528 0094 	;
00529 0094 		if HasBattV
00530 0094 2195 		CALL	ReadAN0_ColdStart
00531 0095 20AF 		CALL	LongFlash
00532 0096 	;
00533 0096 2187 		CALL	ReadAN0
00534 0097 2187 		CALL	ReadAN0
00535 0098 	; devide by 8
00536 0098 36FD 		lsrf	Param7D,F
00537 0099 0CFC 		rrf	Param7C,F
00538 009A 36FD 		lsrf	Param7D,F
00539 009B 0CFC 		rrf	Param7C,F
00540 009C 36FD 		lsrf	Param7D,F
00541 009D 0CFC 		rrf	Param7C,F
00542 009E 	;
00543 009E 3032 		movlw	.50	; 1/2 second
00544 009F 00A1 		movwf	LED_Time
00545 00A0 087C 		movf	Param7C,W
00546 00A1 00A5 		movwf	LED_Blinks
00547 00A2 	;
00548 00A2 0064 	Start_L1	CLRWDT
00549 00A3 0825 		movf	LED_Blinks,W
00550 00A4 		SKPZ
00550 00A4 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00551 00A5 33FC 		BRA	Start_L1
00552 00A6 20B6 		CALL	Delay_1S
00553 00A7 	;
00554 00A7 20AF 		CALL	LongFlash
00555 00A8 	;
00556 00A8 		endif
00557 00A8 	; normal system blinks
00558 00A8 3064 		MOVLW	LEDTIME
00559 00A9 00A1 		MOVWF	LED_Time
00560 00AA 30FF 		movlw	0xFF
00561 00AB 00A5 		movwf	LED_Blinks
00562 00AC 	;
00563 00AC 219D 		CALL	StartServo
00564 00AD 20BD 		CALL	HomeServo
00565 00AE 3216 		BRA	MainLoop
00566 00AF 	;
00567 00AF 	;==============================================
00568 00AF 	; One second ON one second OFF
00569 00AF 3064 	LongFlash	movlw	.100
00570 00B0 00A5 		movwf	LED_Blinks
00571 00B1 3001 		movlw	0x01	;constant ON
00572 00B2 00A1 		movwf	LED_Time
00573 00B3 0825 	LongFlash_L1	movf	LED_Blinks,W
00574 00B4 		SKPZ
00574 00B4 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00575 00B5 33FD 		BRA	LongFlash_L1
00576 00B6 	;
00577 00B6 3064 	Delay_1S	movlw	.100
00578 00B7 00A8 		movwf	Timer1Lo
00579 00B8 0828 	Delay_L1	movf	Timer1Lo,W
00580 00B9 		SKPZ
00580 00B9 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00581 00BA 33FD 		bra	Delay_L1
00582 00BB 0064 		CLRWDT
00583 00BC 0008 		return
00584 00BD 	;
00585 00BD 	;==============================================
00586 00BD 0020 	HomeServo	movlb	0	;Bank0
00587 00BE 12F2 		bcf	SMRevFlag
00588 00BF 1172 		bcf	LED2Flag
RocketServo.asm                                                       Page: 7
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00589 00C0 302C 		movlw	Low ActivationTime
00590 00C1 00AC 		movwf	Timer3Lo
00591 00C2 3001 		movlw	High ActivationTime
00592 00C3 00AD 		movwf	Timer3Hi
00593 00C4 0008 		return
00594 00C5 	;
00595 00C5 	;=========================================================================================
00596 00C5 	;
00597 00C5 0002 	BtnChangeRate	EQU	0x02	;change by 1uS per 0.05 seconds
00598 00C5 0010 	SlewChangeRate	EQU	0x10	;change by 8uS per 0.01 seconds
00599 00C5 	;
00600 00C5 0064 	MainLoop	CLRWDT
00601 00C6 0020 		MOVLB	0x00                   ;Bank 0
00602 00C7 	;
00603 00C7 	; Handle Inc/Dec buttons
00604 00C7 082E 		movf	Timer4Lo,W
00605 00C8 042F 		iorwf	Timer4Hi,W
00606 00C9 		SKPZ		;Timer4 == 0?
00606 00C9 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00607 00CA 3225 		bra	ML_Btns_End	; No
00608 00CB 1C72 		btfss	IncBtnFlag	;Inc button is down?
00609 00CC 3213 		bra	ML_Btns_Dec	; No
00610 00CD 	;
00611 00CD 1CF2 		btfss	DecBtnFlag	;Dec button is down?
00612 00CE 3206 		bra	ML_Btns_Inc	; No
00613 00CF 	; Handle both buttons, move to center
00614 00CF 30B8 		movlw	low kMidPulseWidth
00615 00D0 00B0 		movwf	Dest
00616 00D1 300B 		movlw	high kMidPulseWidth
00617 00D2 00B1 		movwf	Dest+1
00618 00D3 11F2 		bcf	DataChangedFlag
00619 00D4 323B 		bra	Set_Dest_End
00620 00D5 	;
00621 00D5 	; Handle INC button
00622 00D5 2163 	ML_Btns_Inc	call	CopyPosToTemp
00623 00D6 3002 		movlw	BtnChangeRate
00624 00D7 07FC 		addwf	Param7C,F
00625 00D8 3000 		movlw	0x00
00626 00D9 3DFD 		addwfc	Param7D,F
00627 00DA 21CE 		call	ClampInt
00628 00DB 2160 		call	CopyTempToPos
00629 00DC 15F2 		bsf	DataChangedFlag
00630 00DD 	;
00631 00DD 3005 		movlw	0x05	; 0.05 seconds
00632 00DE 00AE 		movwf	Timer4Lo
00633 00DF 3210 		bra	ML_Btns_End
00634 00E0 	;
00635 00E0 1CF2 	ML_Btns_Dec	btfss	DecBtnFlag	;Dec button is down?
00636 00E1 320B 		bra	ML_Btns_Save	; No
00637 00E2 	;
00638 00E2 	; Handle DEC button
00639 00E2 2163 		call	CopyPosToTemp
00640 00E3 3002 		movlw	BtnChangeRate
00641 00E4 02FC 		subwf	Param7C,F
00642 00E5 3000 		movlw	0x00
00643 00E6 3BFD 		subwfb	Param7D,F
00644 00E7 21CE 		call	ClampInt
00645 00E8 2160 		call	CopyTempToPos
00646 00E9 15F2 		bsf	DataChangedFlag
00647 00EA 	;
00648 00EA 3005 		movlw	0x05	; 0.05 seconds
00649 00EB 00AE 		movwf	Timer4Lo
00650 00EC 3203 		bra	ML_Btns_End
00651 00ED 		bra	ML_Btns_End
00652 00ED 19F2 	ML_Btns_Save	btfsc	DataChangedFlag
00653 00EE 221D 		call	SaveParams
00654 00EF 11F2 		bcf	DataChangedFlag
00655 00F0 	ML_Btns_End:
00656 00F0 	;
00657 00F0 	;-------------------------
00658 00F0 	; Set Dest
00659 00F0 	;
00660 00F0 1F72 		btfss	NewSWData	;10mS interval passed?
00661 00F1 321E 		bra	Set_Dest_End	; No
00662 00F2 1372 		bcf	NewSWData
00663 00F3 	;
00664 00F3 198C 		btfsc	CmdInputBit	;Contorl signal active?
00665 00F4 320E 		bra	ML_CmdNormal	; No
00666 00F5 	; debounce, don't change until we've seen the input 5 times
00667 00F5 3005 		movlw	0x05
00668 00F6 0239 		subwf	Debounce,W
00669 00F7 		SKPZ		;5 times?
00669 00F7 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00670 00F8 3208 		bra	Rev_Debounce	; No
00671 00F9 	;
00672 00F9 0020 		movlb	0	;Bank0
00673 00FA 16F2 		bsf	SMRevFlag
00674 00FB 1572 		bsf	LED2Flag
00675 00FC 302C 		movlw	Low ActivationTime
00676 00FD 00AC 		movwf	Timer3Lo
00677 00FE 3001 		movlw	High ActivationTime
00678 00FF 00AD 		movwf	Timer3Hi
00679 0100 320E 		bra	Move_It
00680 0101 	;
00681 0101 0AB9 	Rev_Debounce	incf	Debounce,F
00682 0102 320D 		bra	Set_Dest_End
00683 0103 	;
00684 0103 08B9 	ML_CmdNormal	movf	Debounce,F
00685 0104 		SKPZ
RocketServo.asm                                                       Page: 8
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00685 0104 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00686 0105 3207 		bra	Norm_Debounce
00687 0106 	;
00688 0106 0020 		movlb	0	;Bank 0
00689 0107 082C 		movf	Timer3Lo,W
00690 0108 042D 		iorwf	Timer3Hi,W
00691 0109 		SKPZ		;Activation time done?
00691 0109 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00692 010A 3204 		bra	Move_It	; No
00693 010B 		if HoldOpen=0
00695 010B 		endif
00696 010B 1172 		bcf	LED2Flag
00697 010C 3202 		bra	Move_It
00698 010D 	;
00699 010D 03B9 	Norm_Debounce	decf	Debounce,F
00700 010E 3201 		bra	Set_Dest_End
00701 010F 	;
00702 010F 2166 	Move_It	call	CopyPosToDest
00703 0110 	;
00704 0110 	Set_Dest_End:
00705 0110 	;
00706 0110 	;---------------------
00707 0110 	; Move CurPos toward Dest
00708 0110 0020 		movlb	0	;Bank 0
00709 0111 1C38 		btfss	PulseSent
00710 0112 323B 		bra	Move_End
00711 0113 1038 		bcf	PulseSent
00712 0114 	;
00713 0114 0830 		movf	Dest,W
00714 0115 0232 		subwf	CurPos,W
00715 0116 00F8 		movwf	Param78
00716 0117 0831 		movf	Dest+1,W
00717 0118 3B33 		subwfb	CurPos+1,W
00718 0119 04F8 		iorwf	Param78,F
00719 011A 		SKPZ		;Dest == CurPos?
00719 011A 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00720 011B 3205 		bra	Move_It_NIP
00721 011C 082A 		movf	Timer2Lo,W
00722 011D 042B 		iorwf	Timer2Hi,W
00723 011E 		SKPNZ
00723 011E 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00724 011F 1538 		bsf	InPosition
00725 0120 3228 		bra	Move_It_Now	; Yes
00726 0121 	;
00727 0121 302C 	Move_It_NIP	movlw	Low ServoMoveTime
00728 0122 00AA 		movwf	Timer2Lo
00729 0123 3001 		movlw	High ServoMoveTime
00730 0124 00AB 		movwf	Timer2Hi
00731 0125 1138 		bcf	InPosition
00732 0126 	;
00733 0126 0830 		movf	Dest,W
00734 0127 00F8 		movwf	Param78
00735 0128 0831 		movf	Dest+1,W
00736 0129 00F9 		movwf	Param79
00737 012A 	;
00738 012A 0832 		movf	CurPos,W
00739 012B 00FC 		movwf	Param7C
00740 012C 0833 		movf	CurPos+1,W
00741 012D 00FD 		movwf	Param7D
00742 012E 	;
00743 012E 21EF 		call	Param7D_LE_Param79
00744 012F 1C77 		btfss	Param77,0	;CurPos<=Dest?
00745 0130 320C 		bra	Move_It_Neg	; No, CurPos>Dest
00746 0131 	;CurPos<Dest, so move CurPos positive
00747 0131 3010 		movlw	SlewChangeRate
00748 0132 07FC 		addwf	Param7C,F
00749 0133 3000 		movlw	0x00
00750 0134 3DFD 		addwfc	Param7D,F
00751 0135 21EF 		call	Param7D_LE_Param79
00752 0136 1C77 		btfss	Param77,0	;CurPos<=Dest Still?
00753 0137 320D 		bra	Move_It_Dest	; No, CurPos>Dest
00754 0138 				; Yes, CurPos+=SlewChangeRate
00755 0138 	;
00756 0138 	; make the calculated position the current position
00757 0138 087C 	Move_It_New	movf	Param7C,W
00758 0139 00B2 		movwf	CurPos
00759 013A 087D 		movf	Param7D,W
00760 013B 00B3 		movwf	CurPos+1
00761 013C 320C 		bra	Move_It_Now
00762 013D 	;
00763 013D 	Move_It_Neg
00764 013D 3010 		movlw	SlewChangeRate
00765 013E 02FC 		subwf	Param7C,F
00766 013F 3000 		movlw	0x00
00767 0140 3BFD 		subwfb	Param7D,F
00768 0141 21EF 		call	Param7D_LE_Param79
00769 0142 1877 		btfsc	Param77,0	;CurPos<=Dest now?
00770 0143 3201 		bra	Move_It_Dest	; Yes, CurPos<=Dest
00771 0144 33F3 		bra	Move_It_New
00772 0145 	;
00773 0145 	; make the current position the destination
00774 0145 0830 	Move_It_Dest	movf	Dest,W
00775 0146 00B2 		movwf	CurPos
00776 0147 0831 		movf	Dest+1,W
00777 0148 00B3 		movwf	CurPos+1
00778 0149 	;
00779 0149 	Move_It_Now:
00780 0149 0832 		movf	CurPos,W
00781 014A 00FC 		movwf	Param7C
RocketServo.asm                                                       Page: 9
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00782 014B 0833 		movf	CurPos+1,W
00783 014C 00FD 		movwf	Param7D
00784 014D 214F 		CALL	Copy7CToSig
00785 014E 	Move_End:
00786 014E 	;
00787 014E 28C5 		goto	MainLoop
00788 014F 	;
00789 014F 	;========================================================================================
00790 014F 	; Param7D:Param7C >> SigOutTimeH:SigOutTime
00791 014F 	; Entry: Param7D:Param7C
00792 014F 	;
00793 014F 	; Don't disable interrupts if you don't need to...
00794 014F 	; If Param7D:Param7C == SigOutTimeH:SigOutTime then return
00795 014F 087C 	Copy7CToSig	MOVF	Param7C,W
00796 0150 0270 		SUBWF	SigOutTime,W
00797 0151 		SKPZ
00797 0151 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00798 0152 2957 		GOTO	Copy7CToSig_1
00799 0153 087D 		MOVF	Param7D,W
00800 0154 0271 		SUBWF	SigOutTimeH,W
00801 0155 		SKPNZ
00801 0155 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00802 0156 0008 		Return
00803 0157 	;
00804 0157 	;SigOutTimeH:SigOutTime = Param7D:Param7C
00805 0157 138B 	Copy7CToSig_1	bcf	INTCON,GIE
00806 0158 1B8B 		btfsc	INTCON,GIE
00807 0159 33FD 		bra	Copy7CToSig_1
00808 015A 087C 		MOVF	Param7C,W
00809 015B 00F0 		MOVWF	SigOutTime
00810 015C 087D 		MOVF	Param7D,W
00811 015D 00F1 		MOVWF	SigOutTimeH
00812 015E 178B 		bsf	INTCON,GIE
00813 015F 	;
00814 015F 0008 		RETURN
00815 0160 	;
00816 0160 	;=========================================================================
00817 0160 	;
00818 0160 1EF2 	CopyTempToPos	btfss	SMRevFlag
00819 0161 321B 		bra	CopyTempToPos1
00820 0162 321F 		bra	CopyTempToPos2
00821 0163 	;
00822 0163 1EF2 	CopyPosToTemp	btfss	SMRevFlag
00823 0164 320E 		bra	CopyPos1ToTemp
00824 0165 3212 		bra	CopyPos2ToTemp
00825 0166 	;
00826 0166 1EF2 	CopyPosToDest	btfss	SMRevFlag
00827 0167 3201 		bra	CopyPos1ToDest
00828 0168 3205 		bra	CopyPos2ToDest
00829 0169 	;
00830 0169 	;====================================
00831 0169 	;
00832 0169 0835 	CopyPos1ToDest	movf	Position1+1,W
00833 016A 00B1 		movwf	Dest+1
00834 016B 0834 		movf	Position1,W
00835 016C 00B0 		movwf	Dest
00836 016D 0008 		return
00837 016E 	;
00838 016E 	;=====================================
00839 016E 	;
00840 016E 0837 	CopyPos2ToDest	movf	Position2+1,W
00841 016F 00B1 		movwf	Dest+1
00842 0170 0836 		movf	Position2,W
00843 0171 00B0 		movwf	Dest
00844 0172 0008 		return
00845 0173 	;
00846 0173 	;====================================
00847 0173 	;
00848 0173 0835 	CopyPos1ToTemp	movf	Position1+1,W
00849 0174 00FD 		movwf	Param7D
00850 0175 0834 		movf	Position1,W
00851 0176 00FC 		movwf	Param7C
00852 0177 0008 		return
00853 0178 	;
00854 0178 	;=====================================
00855 0178 	;
00856 0178 0837 	CopyPos2ToTemp	movf	Position2+1,W
00857 0179 00FD 		movwf	Param7D
00858 017A 0836 		movf	Position2,W
00859 017B 00FC 		movwf	Param7C
00860 017C 0008 		return
00861 017D 	;
00862 017D 	;=====================================
00863 017D 	;
00864 017D 087D 	CopyTempToPos1	movf	Param7D,W
00865 017E 00B5 		movwf	Position1+1
00866 017F 087C 		movf	Param7C,W
00867 0180 00B4 		movwf	Position1
00868 0181 0008 		return
00869 0182 	;
00870 0182 087D 	CopyTempToPos2	movf	Param7D,W
00871 0183 00B7 		movwf	Position2+1
00872 0184 087C 		movf	Param7C,W
00873 0185 00B6 		movwf	Position2
00874 0186 0008 		return
00875 0187 	;
00876 0187 	;=========================================================================================
00877 0187 	;=========================================================================================
00878 0187 	; Setup or Read AN0
RocketServo.asm                                                       Page: 10
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00879 0187 	; Exit: 10bit analog in 7D:7C
00880 0187 	;
00881 0187 01FC 	ReadAN0	CLRF	Param7C
00882 0188 01FD 		CLRF	Param7D
00883 0189 0021 		MOVLB	1	;bank 1
00884 018A 1C1D 		BTFSS	ADCON0,ADON	;Is the Analog input ON?
00885 018B 2995 		GOTO	ReadAN0_ColdStart	; No, go start it
00886 018C 189D 	ReadAN0_L1	BTFSC	ADCON0,NOT_DONE	;Conversion done?
00887 018D 33FE 		BRA	ReadAN0_L1	; No
00888 018E 081C 		MOVF	ADRESH,W
00889 018F 00FD 		MOVWF	Param7D
00890 0190 081B 		MOVF	ADRESL,W
00891 0191 00FC 		MOVWF	Param7C
00892 0192 149D 		BSF	ADCON0,ADGO	;Start next conversion.
00893 0193 0020 		MOVLB	0	;bank 0
00894 0194 0008 		RETURN
00895 0195 	;
00896 0195 0021 	ReadAN0_ColdStart	MOVLB	1	;bank 1
00897 0196 30A0 		MOVLW	0xA0	;Right Just fosc/32
00898 0197 009E 		MOVWF	ADCON1
00899 0198 3001 		MOVLW	b'00000001'	;Select AN0
00900 0199 009D 		MOVWF	ADCON0
00901 019A 149D 		BSF	ADCON0,GO
00902 019B 0020 	ReadAN0_Rtn	MOVLB	0	;bank 0
00903 019C 0008 		Return
00904 019D 	;
00905 019D 	;=========================================================================================
00906 019D 	;=========================================================================================
00907 019D 	; Set CCP1 to go high is 0x100 clocks
00908 019D 	;
00909 019D 0020 	StartServo	MOVLB	0	;bank 0
00910 019E 1E72 		BTFSS	ServoOff
00911 019F 0008 		RETURN
00912 01A0 1272 		BCF	ServoOff
00913 01A1 	;
00914 01A1 08AE 	SS_Start_Loop	movf	Timer4Lo,F
00915 01A2 		SKPZ
00915 01A2 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00916 01A3 33FD 		bra	SS_Start_Loop
00917 01A4 	;
00918 01A4 	; Initialize to normal position
00919 01A4 0020 	SS_CmdNormal	movlb	0	;Bank 0
00920 01A5 12F2 		bcf	SMRevFlag
00921 01A6 1172 		bcf	LED2Flag
00922 01A7 	;
00923 01A7 2166 	SS_Move_It	call	CopyPosToDest
00924 01A8 21C7 		call	SetDestAsCur
00925 01A9 214F 		CALL	Copy7CToSig
00926 01AA 	;
00927 01AA 3000 		MOVLW	0x00	;start in 0x100 clocks
00928 01AB 0096 		MOVWF	TMR1L
00929 01AC 30FF 		MOVLW	0xFF
00930 01AD 0097 		MOVWF	TMR1H
00931 01AE 	;
00932 01AE 0025 		MOVLB	0x05                   ;Bank 5
00933 01AF 0192 		CLRF	CCPR1H
00934 01B0 0191 		CLRF	CCPR1L
00935 01B1 3008 		MOVLW	CCP1CON_Set
00936 01B2 0093 		MOVWF	CCP1CON	;go high on match
00937 01B3 0020 		MOVLB	0x00	;Bank 0
00938 01B4 302C 		movlw	low .300	;Do nothing for 3 seconds
00939 01B5 00AE 		movwf	Timer4Lo
00940 01B6 3001 		movlw	high .300
00941 01B7 00AF 		movwf	Timer4Hi
00942 01B8 302C 		movlw	Low ServoMoveTime	;At power up move to commanded position
00943 01B9 00AA 		movwf	Timer2Lo
00944 01BA 3001 		movlw	High ServoMoveTime
00945 01BB 00AB 		movwf	Timer2Hi
00946 01BC 1138 		bcf	InPosition
00947 01BD 0008 		RETURN
00948 01BE 	;
00949 01BE 	;=========================================================================================
00950 01BE 	;
00951 01BE 30B8 	SetMiddlePosition	MOVLW	LOW kMidPulseWidth
00952 01BF 00FC 		MOVWF	Param7C
00953 01C0 00B0 		movwf	Dest
00954 01C1 00B2 		movwf	CurPos
00955 01C2 300B 		MOVLW	HIGH kMidPulseWidth
00956 01C3 00FD 		MOVWF	Param7D
00957 01C4 00B1 		movwf	Dest+1
00958 01C5 00B3 		movwf	CurPos+1
00959 01C6 0008 		Return
00960 01C7 	;
00961 01C7 	;=========================================================================================
00962 01C7 	;
00963 01C7 0830 	SetDestAsCur	movf	Dest,W
00964 01C8 00FC 		MOVWF	Param7C
00965 01C9 00B2 		movwf	CurPos
00966 01CA 0831 		movf	Dest+1,W
00967 01CB 00FD 		MOVWF	Param7D
00968 01CC 00B3 		movwf	CurPos+1
00969 01CD 0008 		Return
00970 01CE 	;
00971 01CE 	;=========================================================================================
00972 01CE 	; ClampInt(Param7D:Param7C,kMinPulseWidth,kMaxPulseWidth)
00973 01CE 	;
00974 01CE 	; Entry: Param7D:Param7C
00975 01CE 	; Exit: Param7D:Param7C=ClampInt(Param7D:Param7C,kMinPulseWidth,kMaxPulseWidth)
00976 01CE 	;
RocketServo.asm                                                       Page: 11
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00977 01CE 3010 	ClampInt	MOVLW	high kMaxPulseWidth
00978 01CF 027D 		SUBWF	Param7D,W	;7D-kMaxPulseWidth
00979 01D0 		SKPNB		;7D<Max?
00979 01D0 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
00980 01D1 29DB 		GOTO	ClampInt_1	; Yes
00981 01D2 		SKPZ		;7D=Max?
00981 01D2 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00982 01D3 29EA 		GOTO	ClampInt_tooHigh	; No, its greater.
00983 01D4 3068 		MOVLW	low kMaxPulseWidth	; Yes, MSB was equal check LSB
00984 01D5 027C 		SUBWF	Param7C,W	;7C-kMaxPulseWidth
00985 01D6 		SKPNZ		;=kMaxPulseWidth
00985 01D6 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00986 01D7 0008 		RETURN		;Yes
00987 01D8 		SKPB		;7C<Max?
00987 01D8 1803      M		BTFSC	STATUS,C		BTFSC	STATUS,C
00988 01D9 29EA 		GOTO	ClampInt_tooHigh	; No
00989 01DA 0008 		RETURN		; Yes
00990 01DB 	;
00991 01DB 3007 	ClampInt_1	MOVLW	high kMinPulseWidth
00992 01DC 027D 		SUBWF	Param7D,W	;7D-kMinPulseWidth
00993 01DD 		SKPNB		;7D<Min?
00993 01DD 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
00994 01DE 29E5 		GOTO	ClampInt_tooLow	; Yes
00995 01DF 		SKPZ		;=Min?
00995 01DF 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
00996 01E0 0008 		RETURN		; No, 7D>kMinPulseWidth
00997 01E1 3008 		MOVLW	low kMinPulseWidth	; Yes, MSB is a match
00998 01E2 027C 		SUBWF	Param7C,W	;7C-kMinPulseWidth
00999 01E3 		SKPB		;7C>=Min?
00999 01E3 1803      M		BTFSC	STATUS,C		BTFSC	STATUS,C
01000 01E4 0008 		RETURN		; Yes
01001 01E5 	;
01002 01E5 3008 	ClampInt_tooLow	MOVLW	low kMinPulseWidth
01003 01E6 00FC 		MOVWF	Param7C
01004 01E7 3007 		MOVLW	high kMinPulseWidth
01005 01E8 00FD 		MOVWF	Param7D
01006 01E9 0008 		RETURN
01007 01EA 	;
01008 01EA 3068 	ClampInt_tooHigh	MOVLW	low kMaxPulseWidth
01009 01EB 00FC 		MOVWF	Param7C
01010 01EC 3010 		MOVLW	high kMaxPulseWidth
01011 01ED 00FD 		MOVWF	Param7D
01012 01EE 0008 		RETURN
01013 01EF 	;
01014 01EF 	;=====================================================================================
01015 01EF 	; Less or Equal
01016 01EF 	;
01017 01EF 	; Entry: Param7D:Param7C, Param79:Param78
01018 01EF 	; Exit: Param77:0=Param7D:Param7C<=Param79:Param78
01019 01EF 	;
01020 01EF 01F7 	Param7D_LE_Param79	CLRF	Param77	;default to >
01021 01F0 0879 		MOVF	Param79,W
01022 01F1 027D 		SUBWF	Param7D,W	;Param7D-Param79
01023 01F2 		SKPNB		;Param7D<Param79?
01023 01F2 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
01024 01F3 29FC 		GOTO	SetTrue	; Yes
01025 01F4 		SKPZ		;Param7D>Param79?
01025 01F4 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
01026 01F5 0008 		RETURN		; Yes
01027 01F6 0878 		MOVF	Param78,W	; No, MSB is a match
01028 01F7 027C 		SUBWF	Param7C,W	;Param7C-Param78
01029 01F8 		SKPNB		;Param7C<Param78?
01029 01F8 1C03      M		BTFSS	STATUS,C		BTFSS	STATUS,C
01030 01F9 29FC 		GOTO	SetTrue	; Yes
01031 01FA 		SKPZ		;LSBs then same?
01031 01FA 1D03      M		BTFSS	STATUS,Z		BTFSS	STATUS,Z
01032 01FB 0008 		RETURN		; No
01033 01FC 	;
01034 01FC 1477 	SetTrue	BSF	Param77,0
01035 01FD 0008 		RETURN
01036 01FE 	;
01037 01FE 		if oldCode
01136 01FE 		endif
01137 01FE 	;=============================================================================================
01138 01FE 	;==============================================================================================
01139 01FE 	;
01140 01FE 		include	F1822_Common.inc
00001 01FE 	;=========================================================================================
00002 01FE 	; Commonly used routines PIC16F1822 version
00003 01FE 	;
00004 01FE 	;    Filename:      F1822 Common.inc
00005 01FE 	;    Date:          9/4/2014
00006 01FE 	;    File Version:  1.0.1
00007 01FE 	;
00008 01FE 	;    Author:        David M. Flynn
00009 01FE 	;    Company:       Oxford V.U.E., Inc.
00010 01FE 	;    E-Mail:        dflynn@oxfordvue.com
00011 01FE 	;    Web Site:      http://www.oxfordvue.com/
00012 01FE 	;
00013 01FE 	;=========================================================================================
00014 01FE 	;    History:
00015 01FE 	;
00016 01FE 	; 1.0.1 9/4/2014	Updated from F1847 Common.inc
00017 01FE 	; 1.0   11/16/2013	Updated from F648A Common.inc
00018 01FE 	;
00019 01FE 	;=========================================================================================
00020 01FE 	; Routines:
00021 01FE 	;
00022 01FE 	; ClearRam	(2+0) Clears all RAM, call once before initializing variables, FSR0
RocketServo.asm                                                       Page: 12
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00023 01FE 	; CopyToRam	(1+0) copy param memory (EEPROM) to ram, call once, FSR0
00024 01FE 	; SaveParams	(1+0) copy ram to param memory (EEPROM), FSR0
00025 01FE 	; TX_TheByte	(0+0) Send one byte to UART
00026 01FE 	; RX_TheByte	(0+0) Receive one byte from UART
00027 01FE 	;
00028 01FE 	; DecTimer4	(0+0) Decrement routine for 16 bit timers, FSR0
00029 01FE 	; DecTimer3
00030 01FE 	; DecTimer2
00031 01FE 	; DecTimer1
00032 01FE 	;
00033 01FE 	; TestT4_Zero	Test for 16 bit timers = zero
00034 01FE 	; TestT3_Zero	If Timer is zero return Z flag,1 else Z=0
00035 01FE 	; TestT2_Zero
00036 01FE 	; TestT1_Zero
00037 01FE 	;
00038 01FE 	; Delay10uS	(0+0)Delay uS    1 cycle = 1uS, 8Mhz clock version
00039 01FE 	; Delay100uS
00040 01FE 	; Delay40uS
00041 01FE 	; DelayWuS
00042 01FE 	;
00043 01FE 	; EEReadW	(0+0) Read EEPROM address in W
00044 01FE 	; EERead	(0+0) Read EEPROM address in EEAddrTemp
00045 01FE 	; EEWriteW	(0+0) Write EEPROM address in W, Data in EEDataTemp
00046 01FE 	; EEWrite	(0+0) Write EEPROM address in EEAdrTemp, Data in EEDataTemp, FSR0
00047 01FE 	;
00048 01FE 	; StoreSerIn	Put the byte in W into the serial input buffer, FSR0
00049 01FE 	; GetSerIn	Get a byte from the serial input buffer, FSR0
00050 01FE 	; GetSerOutBytes	Get the number of bytes in the serial ouput buffer
00051 01FE 	; StoreSerOut	Put the byte in W into the serial output buffer, FSR0
00052 01FE 	; POP_SerOut	Remove the last char stored in the output buffer
00053 01FE 	; GetSerOut	Get a byte from the serial Output buffer, FSR0
00054 01FE 	;
00055 01FE 	;=========================================================================================
00056 01FE 	; Clears all RAM
00057 01FE 	; Entry: none
00058 01FE 	; Exit: none
00059 01FE 	; RAM used: All
00060 01FE 	; Calls:(2+0) ClearRam_L2
00061 01FE 	;
00062 01FE 0020 	ClearRam	MOVLB	0x00
00063 01FF 305F 		MOVLW	0x5F	;Clear 20h-7Eh, 95 bytes
00064 0200 00FF 		MOVWF	Param7F
00065 0201 3020 		MOVLW	0x20
00066 0202 0084 		MOVWF	FSR0
00067 0203 0185 		CLRF	FSR0H
00068 0204 2209 		CALL	ClearRam_L2
00069 0205 	;
00070 0205 3020 		MOVLW	0x20	;Clear A0h-BFh, 32 bytes
00071 0206 00FF 		MOVWF	Param7F
00072 0207 30A0 		MOVLW	0xA0
00073 0208 0084 		MOVWF	FSR0
00074 0209 	;
00075 0209 0180 	ClearRam_L2	CLRF	INDF0
00076 020A 0A84 		INCF	FSR0,F
00077 020B 0BFF 		DECFSZ	Param7F,F
00078 020C 2A09 		GOTO	ClearRam_L2
00079 020D 0008 		RETURN
00080 020E 	;
00081 020E 	;==========================================================================
00082 020E 	; copy param memory to ram
00083 020E 	;
00084 020E 	CopyToRam:
00085 020E 0020  a		MOVLB	EEAddrTemp	;banksel
00084 020F 		BankSel	EEAddrTemp
00086 020F 3000 		MOVLW	nvFirstParamByte
00087 0210 00A6 		MOVWF	EEAddrTemp
00088 0211 3034 		MOVLW	FirstRAMParam
00089 0212 0084 		MOVWF	FSR0
00090 0213 0185 		CLRF	FSR0H
00091 0214 2256 	CopyToRam_L1	CALL	EERead
00092 0215 0080 		MOVWF	INDF0
00093 0216 3038 		MOVLW	LastRAMParam
00094 0217 0204 		SUBWF	FSR0,W
00095 0218 		SKPNZ
00095 0218 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00096 0219 0008 		RETURN
00097 021A 0A84 		INCF	FSR0,F
00098 021B 0AA6 		INCF	EEAddrTemp,F
00099 021C 2A14 		GOTO	CopyToRam_L1
00100 021D 	;
00101 021D 	;===========================================================================
00102 021D 	; copy ram to param memory
00103 021D 	;
00104 021D 	SaveParams:
00105 021D 0020  a		MOVLB	EEAddrTemp	;banksel
00104 021E 		BankSel	EEAddrTemp
00106 021E 3000 		MOVLW	nvFirstParamByte
00107 021F 00A6 		MOVWF	EEAddrTemp
00108 0220 3034 		MOVLW	FirstRAMParam
00109 0221 0084 		MOVWF	FSR0
00110 0222 0185 		CLRF	FSR0H
00111 0223 0800 	SaveParams_L1	MOVF	INDF0,W
00112 0224 00A7 		MOVWF	EEDataTemp
00113 0225 2260 		CALL	EEWrite
00114 0226 3038 		MOVLW	LastRAMParam	;last byte
00115 0227 0204 		SUBWF	FSR0,W
00116 0228 		SKPNZ
00116 0228 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00117 0229 0008 		RETURN
RocketServo.asm                                                       Page: 13
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00118 022A 0A84 		INCF	FSR0,F
00119 022B 0AA6 		INCF	EEAddrTemp,F
00120 022C 2A23 		GOTO	SaveParams_L1
00121 022D 	;
00122 022D 	;=====================================================================================================
00123 022D 	;=========================================================================================================
00124 022D 	; Decrement routine for 16 bit timers
00125 022D 	;
00126 022D 302F 	DecTimer4	movlw	Timer4Hi
00127 022E 2A34 		goto	DecTimer
00128 022F 302D 	DecTimer3	movlw	Timer3Hi
00129 0230 2A34 		goto	DecTimer
00130 0231 302B 	DecTimer2	movlw	Timer2Hi
00131 0232 2A34 		goto	DecTimer
00132 0233 3029 	DecTimer1	movlw	Timer1Hi
00133 0234 	;DecTimer
00134 0234 	; entry: FSR=Timer(n)Hi
00135 0234 0084 	DecTimer	MOVWF	FSR0L
00136 0235 0185 		CLRF	FSR0H	;Timers must be in bank 0
00137 0236 0013 		moviw	FSR0--	;TimerNHi
00138 0237 0400 		IORWF	INDF0,W	;TimerNLo
00139 0238 		SKPNZ
00139 0238 1903      M		BTFSC	STATUS,Z		BTFSC	STATUS,Z
00140 0239 0008 		RETURN
00141 023A 3001 		MOVLW	0x01
00142 023B 0280 		SUBWF	INDF0,F	;TimerNLo
00143 023C 0A84 		INCF	FSR0L,F
00144 023D 3000 		MOVLW	0x00
00145 023E 3B80 		SUBWFB	INDF0,F	;TimerNHi
00146 023F 0008 		RETURN
00147 0240 	;
00148 0240 	;==============================================================================================
00149 0240 	; Test for 16 bit timers = zero
00150 0240 	;If Timer is zero return Z flag,1 else Z=0
00151 0240 	;
00152 0240 082E 	TestT4_Zero	movf	Timer4Lo,W
00153 0241 042F 		iorwf	Timer4Hi,W
00154 0242 0008 		return
00155 0243 	;
00156 0243 082C 	TestT3_Zero	movf	Timer3Lo,W
00157 0244 042D 		iorwf	Timer3Hi,W
00158 0245 0008 		return
00159 0246 	;
00160 0246 082A 	TestT2_Zero	movf	Timer2Lo,W
00161 0247 042B 		iorwf	Timer2Hi,W
00162 0248 0008 		return
00163 0249 	;
00164 0249 0828 	TestT1_Zero	movf	Timer1Lo,W
00165 024A 0429 		iorwf	Timer1Hi,W
00166 024B 0008 		return
00167 024C 	;
00168 024C 	;======================================================================================
00169 024C 	;Delay uS    1 cycle = 1uS, 8Mhz clock version
00170 024C 	; RAM used: Param77
00171 024C 	; Calls:(0) none
00172 024C 3005 	Delay10uS	MOVLW	0x05	;(2*3+5)/2=10
00173 024D 2A51 		GOTO	DelayWuS
00174 024E 3041 	Delay100uS	MOVLW	d'65'	;(28*3+5)/2=100
00175 024F 2A51 		GOTO	DelayWuS
00176 0250 3019 	Delay40uS	MOVLW	d'25'	;(11*3+5)=40
00177 0251 00F7 	DelayWuS	MOVWF	Param77
00178 0252 0BF7 	DelayWuS_Loop	DECFSZ	Param77,F
00179 0253 2A52 		GOTO	DelayWuS_Loop
00180 0254 0008 		RETURN
00181 0255 	;
00182 0255 	;==============================================================================================
00183 0255 	; Read EEPROM
00184 0255 	; entry: EEPROM address to read in W
00185 0255 	;        Bank 0 selected
00186 0255 	; exit: W=EEDATA, Bank 0 selected
00187 0255 	;
00188 0255 00A6 	EEReadW	movwf	EEAddrTemp
00189 0256 	;
00190 0256 	;==============================================================================================
00191 0256 	; Read EEPROM
00192 0256 	; entry: EEPROM address to read in EEAddrTemp
00193 0256 	;        Bank 0 selected
00194 0256 	; exit: W=EEDATA, Bank 0 selected
00195 0256 	;
00196 0256 0826 	EERead	MOVF	EEAddrTemp,W	;Data Memory
00197 0257 0023  a		MOVLB	EEADRL	;banksel
00196 0258 		BANKSEL	EEADRL
00198 0258 0091 		MOVWF	EEADRL	;Address to read
00199 0259 	;
00200 0259 1315 		BCF	EECON1,CFGS	;Deselect Config space
00201 025A 1395 		BCF	EECON1,EEPGD	;Point to DATA memory
00202 025B 1415 		BSF	EECON1,RD	;EE Read
00203 025C 0813 		MOVF	EEDATL,W	;W = EEDATL
00204 025D 0020 		MOVLB	0x00	;Bank 0
00205 025E 0008 		return
00206 025F 	;
00207 025F 	;==============================================================================================
00208 025F 	; Write EEPROM
00209 025F 	; entry: EEPROM address to write in W
00210 025F 	;        EEPROM data to write in EEDataTemp
00211 025F 	;        Bank 0 selected
00212 025F 	; exit: Bank 0 selected
00213 025F 	;
00214 025F 00A6 	EEWriteW	movwf	EEAddrTemp
RocketServo.asm                                                       Page: 14
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

00215 0260 	;
00216 0260 	;==============================================================================================
00217 0260 	; Write EEPROM
00218 0260 	; entry: EEPROM address to write in EEAdrTemp
00219 0260 	;        EEPROM data to write in EEDataTemp
00220 0260 	;        Bank 0 selected
00221 0260 	; exit: Bank 0 selected
00222 0260 	;
00223 0260 0826 	EEWrite	MOVF	EEAddrTemp,W
00224 0261 0023  a		MOVLB	EEADRL	;banksel
00223 0262 		BANKSEL	EEADRL
00225 0262 0091 		MOVWF	EEADRL	;Data Memory Address to write
00226 0263 0020  a		MOVLB	EEDataTemp	;banksel
00225 0264 		BankSel	EEDataTemp
00227 0264 0827 		MOVF	EEDataTemp,W
00228 0265 0023  a		MOVLB	EEDATL	;banksel
00227 0266 		BANKSEL	EEDATL
00229 0266 0093 		MOVWF	EEDATL	;Data Memory Value to write
00230 0267 1315 		BCF	EECON1,CFGS	;Deselect Configuration space
00231 0268 1395 		BCF	EECON1,EEPGD	;Point to DATA memory
00232 0269 138B 		BCF	INTCON,GIE	;Disable INTs.
00233 026A 1515 		BSF	EECON1,WREN	;Enable writes
00234 026B 3055 		MOVLW	0x55
00235 026C 0096 		MOVWF	EECON2	;Write 55h
00236 026D 30AA 		MOVLW	0xAA
00237 026E 0096 		MOVWF	EECON2	;Write AAh
00238 026F 1495 		BSF	EECON1,WR	;Set WR bit to begin write
00239 0270 178B 		BSF	INTCON,GIE	;Enable Interrupts
00240 0271 1115 		BCF	EECON1,WREN	;Disable writes
00241 0272 1895 	EEWriteLoop	BTFSC	EECON1,WR	;Wait for write to complete
00242 0273 2A72 		GOTO	EEWriteLoop
00243 0274 0020 		MOVLB	0x00	;Bank 0
00244 0275 0008 		return
00245 0276 	;
00246 0276 	;=========================================================================================================
00247 0276 		IF useRS232
00396 0276 		ENDIF
00397 0276 	;
00398 0276 	;
00399 0276 	;
01141 0276 	;
01142 0276 	;=========================================================================================
01143 0276 	;=========================================================================================
01144 0276 	;
01145 0276 	;
01146 0276 	;
01147 0276 	;
01148 0276 		END

X-Ref Table
ActivationTime	012C 	HomeServo, ML_Btns_End
ADCON0	009D 	ReadAN0, ReadAN0_L1, ReadAN0_ColdStart
ADCON1	009E 	ReadAN0_ColdStart
ADGO	0001 	ReadAN0_L1
ADON	0000 	ReadAN0
ADRESH	009C 	ReadAN0_L1
ADRESL	009B 	ReadAN0_L1
ANSELA	018C 	start
APFCON	011D 	start
BtnChangeRate	0002 	ML_Btns_Inc, ML_Btns_Dec
C	0000 	ClampInt, ClampInt_1, Param7D_LE_Param79
CalcdDwell	0075 	IRQ_Servo1_1
CalcdDwellH	0076 	IRQ_Servo1_1
CCP1CON	0293 	IRQ_2, IRQ_Servo1_1, IRQ_Servo1_OL, start, SS_Start_Loop
CCP1CON_Clr	0009 	IRQ_Servo1_1
CCP1CON_Int	000A 	IRQ_Servo1_1, IRQ_Servo1_OL
CCP1CON_Set	0008 	IRQ_Servo1_OL, SS_Start_Loop
CCP1IE	0002 	start
CCP1IF	0002 	IRQ_2, IRQ_Servo1_X
CCP1M0	0000 	IRQ_Servo1_1
CCP1SEL	0000 	start
CCPR1H	0292 	IRQ_Servo1_1, IRQ_Servo1_OL, SS_Start_Loop
CCPR1L	0291 	IRQ_Servo1_1, IRQ_Servo1_OL, SS_Start_Loop
CFGS	0006 	EERead, EEWrite
ClampInt ^	01CE 	ML_Btns_Inc, ML_Btns_Dec
ClampInt_1 ^	01DB 	ClampInt
ClampInt_tooHigh ^	01EA 	ClampInt
ClampInt_tooLow ^	01E5 	ClampInt_1
ClearRam ^	01FE 	start
ClearRam_L2 ^	0209 	ClearRam, ClearRam_L2
CmdInputBit	PORTA,3	ML_Btns_End
Copy7CToSig ^	014F 	Move_It_Now, SS_Start_Loop
Copy7CToSig_1 ^	0157 	Copy7CToSig, Copy7CToSig_1
CopyPos1ToDest ^	0169 	CopyPosToDest
CopyPos1ToTemp ^	0173 	CopyPosToTemp
CopyPos2ToDest ^	016E 	CopyPosToDest
CopyPos2ToTemp ^	0178 	CopyPosToTemp
CopyPosToDest ^	0166 	Move_It, SS_Start_Loop
CopyPosToTemp ^	0163 	ML_Btns_Inc, ML_Btns_Dec
CopyTempToPos ^	0160 	ML_Btns_Inc, ML_Btns_Dec
CopyTempToPos1 ^	017D 	CopyTempToPos
CopyTempToPos2 ^	0182 	CopyTempToPos
CopyToRam ^	020E 	start
CopyToRam_L1 ^	0214 	CopyToRam_L1
CurPos	0032 	Set_Dest_End, Move_It_NIP, Move_It_New, Move_It_Dest, Move_It_Now, SS_Start_Loop
		SetDestAsCur
DataChangedFlag	Flags,3	MainLoop, ML_Btns_Inc, ML_Btns_Dec, ML_Btns_Save
Debounce	0039 	ML_Btns_End, Rev_Debounce, ML_CmdNormal, Norm_Debounce
DecBtnBit	PORTA,4	
RocketServo.asm   X-Ref Table                                            Page: 15
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

DecBtnFlag	Flags,1	, MainLoop, ML_Btns_Dec
DecTimer ^	0234 	DecTimer4, DecTimer3, DecTimer2
DecTimer1 ^	0233 	
DecTimer2 ^	0231 	
DecTimer3 ^	022F 	
DecTimer4 ^	022D 	
Delay_1S ^	00B6 	Start_L1
Delay_L1 ^	00B8 	Delay_L1
DelayWuS ^	0251 	DecTimer
DelayWuS_Loop ^	0252 	DelayWuS_Loop
Dest	0030 	MainLoop, Set_Dest_End, Move_It_NIP, Move_It_Dest, CopyPos1ToDest, CopyPos2ToDest
		SS_Start_Loop, SetDestAsCur
EEAddrTemp	0026 	CopyToRam, CopyToRam_L1, SaveParams, SaveParams_L1, DelayWuS_Loop
		EERead, EEWrite
EEADRL	0191 	EERead, EEWrite
EECON1	0195 	EERead, EEWrite, EEWriteLoop
EECON2	0196 	EEWrite
EEDataTemp	0027 	SaveParams_L1, EEWrite
EEDATL	0193 	EERead, EEWrite
EEPGD	0007 	EERead, EEWrite
EERead ^	0256 	CopyToRam_L1
EEWrite ^	0260 	SaveParams_L1
EEWriteLoop ^	0272 	EEWriteLoop
F	0001 	, SystemBlink_Blinking, SystemBlink_end, IRQ_Servo1_1, IRQ_Servo1_OL, start
		ML_Btns_Inc, ML_Btns_Dec, Rev_Debounce, ML_CmdNormal, Norm_Debounce, Set_Dest_End
		Move_It_NIP, Move_It_Neg, SS_Start_Loop, ClearRam_L2, CopyToRam_L1, SaveParams_L1
		DecTimer, DelayWuS_Loop
FirstRAMParam	Position1	CopyToRam, SaveParams
Flags	0072 	, SystemBlink_end, IRQ_2, start, HomeServo, MainLoop, ML_Btns_Inc, ML_Btns_Dec
		ML_Btns_Save, ML_Btns_End, ML_CmdNormal, CopyTempToPos, CopyPosToTemp, CopyPosToDest
		StartServo, SS_Start_Loop
FSR0	0004 	ClearRam, ClearRam_L2, CopyToRam, CopyToRam_L1, SaveParams, SaveParams_L1
FSR0H	0005 	, ClearRam, CopyToRam, SaveParams, DecTimer
FSR0L	0004 	DecTimer
GIE	0007 	start, Copy7CToSig_1, EEWrite
GO	0001 	ReadAN0_ColdStart
HasBattV	0001 	start
HoldOpen	0001 	ML_CmdNormal
HomeServo ^	00BD 	Start_L1
IncBtnBit	PORTA,2	
IncBtnFlag	Flags,0	, MainLoop
INDF0	0000 	ClearRam_L2, CopyToRam_L1, SaveParams_L1, DecTimer
InPosition	SysFlags,2	IRQ_Servo1_1, IRQ_Servo1_OL, Set_Dest_End, Move_It_NIP, SS_Start_Loop
InPosShutdown	SysFlags,1	IRQ_Servo1_1, IRQ_Servo1_OL
INTCON	000B 	start, Copy7CToSig_1, EEWrite
IRQ_2 ^	002F 	
IRQ_Servo1_1 ^	0038 	IRQ_2
IRQ_Servo1_End ^	005E 	IRQ_2
IRQ_Servo1_OL ^	0050 	IRQ_Servo1_1
IRQ_Servo1_X ^	005C 	IRQ_2, IRQ_Servo1_1
kDefaultPosition1	07D0 	EEWriteLoop
kDefaultPosition2	100E 	EEWriteLoop
kInPosShutdown	0002 	EEWriteLoop
kMaxPulseWidth	1068 	ClampInt, ClampInt_tooHigh
kMidPulseWidth	0BB8 	MainLoop, SS_Start_Loop
kMinPulseWidth	0708 	ClampInt_1, ClampInt_tooLow
kServoDwellTime	7D00 	IRQ_Servo1_1, IRQ_Servo1_OL
LastRAMParam	SysFlags	CopyToRam_L1, SaveParams_L1
LED_Blinks	0025 	, SystemBlink_Blinking, start, Start_L1, LongFlash, LongFlash_L1
LED_Ticks	0023 	
LED_Time	0021 	, start, Start_L1, LongFlash
LED2_End ^	002E 	SystemBlink_end
LED2_Ticks	0024 	SystemBlink_end
LED2_Time	0022 	SystemBlink_end, start
LED2Flag	Flags,2	SystemBlink_end, HomeServo, ML_Btns_End, ML_CmdNormal, SS_Start_Loop
LED2TrisBit	TRISA,2	, SystemBlink_end
LEDTIME	0064 	start, Start_L1
LongFlash ^	00AF 	start, Start_L1
LongFlash_L1 ^	00B3 	LongFlash_L1
MainLoop ^	00C5 	Start_L1, Move_End
ML_Btns_Dec ^	00E0 	MainLoop
ML_Btns_End ^	00F0 	MainLoop, ML_Btns_Inc, ML_Btns_Dec
ML_Btns_Inc ^	00D5 	MainLoop
ML_Btns_Save ^	00ED 	ML_Btns_Dec
ML_CmdNormal ^	0103 	ML_Btns_End
Move_End ^	014E 	Set_Dest_End
Move_It ^	010F 	ML_Btns_End, ML_CmdNormal
Move_It_Dest ^	0145 	Move_It_NIP, Move_It_Neg
Move_It_Neg ^	013D 	Move_It_NIP
Move_It_New ^	0138 	Move_It_Neg
Move_It_NIP ^	0121 	Set_Dest_End
Move_It_Now ^	0149 	Set_Dest_End, Move_It_New
NewSWData	Flags,6	, ML_Btns_End
Norm_Debounce ^	010D 	ML_CmdNormal
NOT_DONE	0001 	ReadAN0_L1
NOT_WPUEN	0007 	start
nvFirstParamByte	nvPosition1Lo	EEWriteLoop, CopyToRam, SaveParams
nvLastParamByte	nvSysFlags	EEWriteLoop
nvPosition1Hi	0001 	EEWriteLoop
nvPosition1Lo	0000 	EEWriteLoop, CopyToRam, SaveParams
nvPosition2Hi	0003 	EEWriteLoop
nvPosition2Lo	0002 	EEWriteLoop
nvSysFlags	0004 	EEWriteLoop
oldCode	0000 	ClearRam
OPTION_REG	0095 	start
OSCCON	0099 	start
OSCCON_Value	0072 	start
Param77	0077 	Move_It_NIP, Move_It_Neg, Param7D_LE_Param79, SetTrue, DelayWuS, DelayWuS_Loop
Param78	0078 	Set_Dest_End, Move_It_NIP, Param7D_LE_Param79
RocketServo.asm   X-Ref Table                                            Page: 16
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

Param79	0079 	Move_It_NIP, Param7D_LE_Param79
Param7C	007C 	start, ML_Btns_Inc, ML_Btns_Dec, Move_It_NIP, Move_It_New, Move_It_Neg
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToTemp, CopyPos2ToTemp, CopyTempToPos1
		CopyTempToPos2, ReadAN0, ReadAN0_L1, SS_Start_Loop, SetDestAsCur, ClampInt, ClampInt_1
		ClampInt_tooLow, ClampInt_tooHigh, Param7D_LE_Param79
Param7D	007D 	start, ML_Btns_Inc, ML_Btns_Dec, Move_It_NIP, Move_It_New, Move_It_Neg
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToTemp, CopyPos2ToTemp, CopyTempToPos1
		CopyTempToPos2, ReadAN0, ReadAN0_L1, SS_Start_Loop, SetDestAsCur, ClampInt, ClampInt_1
		ClampInt_tooLow, ClampInt_tooHigh, Param7D_LE_Param79
Param7D_LE_Param79 ^	01EF 	Move_It_NIP, Move_It_Neg
Param7F	007F 	ClearRam, ClearRam_L2
PCLATH	000A 	
PEIE	0006 	start
PIE1	0091 	start
PIR1	0011 	, IRQ_2, IRQ_Servo1_X
PORTA	000C 	, start, ML_Btns_End
PortADDRBits	00DF 	start
PortAValue	0000 	start
Position1	0034 	CopyPos1ToDest, CopyPos1ToTemp, CopyTempToPos1, CopyToRam, SaveParams
Position2	0036 	CopyPos2ToDest, CopyPos2ToTemp, CopyTempToPos2
PR2	001B 	start
PR2_Value	007D 	start
PS0	0000 	start
PS1	0001 	start
PS2	0002 	start
PSA	0003 	start
PulseSent	SysFlags,0	IRQ_2, Set_Dest_End
RD	0000 	EERead
ReadAN0 ^	0187 	start
ReadAN0_ColdStart ^	0195 	start, ReadAN0
ReadAN0_L1 ^	018C 	ReadAN0_L1
Rev_Debounce ^	0101 	ML_Btns_End
SaveParams ^	021D 	ML_Btns_Save
SaveParams_L1 ^	0223 	SaveParams_L1
ServoMoveTime	012C 	Move_It_NIP, SS_Start_Loop
ServoOff	Flags,4	IRQ_2, start, StartServo
Set_Dest_End ^	0110 	MainLoop, ML_Btns_End, Rev_Debounce, Norm_Debounce
SetDestAsCur ^	01C7 	SS_Start_Loop
SetTrue ^	01FC 	Param7D_LE_Param79
SigOutTime	0070 	IRQ_Servo1_1, Copy7CToSig, Copy7CToSig_1
SigOutTimeH	0071 	Copy7CToSig, Copy7CToSig_1
SlewChangeRate	0010 	Move_It_NIP, Move_It_Neg
SMRevFlag	Flags,5	HomeServo, ML_Btns_End, CopyTempToPos, CopyPosToTemp, CopyPosToDest
		SS_Start_Loop
SS_Start_Loop ^	01A1 	SS_Start_Loop
start ^	005F 	
Start_L1 ^	00A2 	Start_L1
StartServo ^	019D 	Start_L1
STATUS	0003 	, Start_L1, LongFlash_L1, Delay_L1, MainLoop, ML_Btns_End, ML_CmdNormal
		Set_Dest_End, Copy7CToSig, SS_Start_Loop, ClampInt, ClampInt_1, Param7D_LE_Param79
		CopyToRam_L1, SaveParams_L1, DecTimer
SysFlags	0038 	IRQ_2, IRQ_Servo1_1, IRQ_Servo1_OL, Set_Dest_End, Move_It_NIP, SS_Start_Loop
		CopyToRam_L1, SaveParams_L1
SysLEDTrisBit	TRISA,4	, SystemBlink_on
SystemBlink_Blinking ^	0022 	
SystemBlink_end ^	0025 	
SystemBlink_on ^	0023 	
T1CON	0018 	start
T1CON_Val	0001 	start
T1GCON	0019 	start
T2CON	001C 	start
T2CON_Value	004E 	start
Timer1Hi	0029 	DecTimer1, DecTimer
Timer1Lo	0028 	Delay_1S, Delay_L1, DecTimer
Timer2Hi	002B 	Set_Dest_End, Move_It_NIP, SS_Start_Loop, DecTimer2, DecTimer
Timer2Lo	002A 	Set_Dest_End, Move_It_NIP, SS_Start_Loop, DecTimer
Timer3Hi	002D 	HomeServo, ML_Btns_End, ML_CmdNormal, DecTimer3, DecTimer
Timer3Lo	002C 	HomeServo, ML_Btns_End, ML_CmdNormal, DecTimer
Timer4Hi	002F 	MainLoop, SS_Start_Loop, DecTimer4, DecTimer
Timer4Lo	002E 	start, MainLoop, ML_Btns_Inc, ML_Btns_Dec, SS_Start_Loop, DecTimer
TMR0CS	0005 	start
TMR1GE	0007 	start
TMR1H	0017 	SS_Start_Loop
TMR1L	0016 	SS_Start_Loop
TMR2IE	0001 	start
TMR2IF	0001 	
TRISA	008C 	, SystemBlink_on, SystemBlink_end, start
useRS232	0000 	EEWriteLoop
W	0000 	, SystemBlink_end, IRQ_Servo1_1, start, Start_L1, LongFlash_L1, Delay_L1
		MainLoop, ML_Btns_End, ML_CmdNormal, Set_Dest_End, Move_It_NIP, Move_It_New, Move_It_Dest
		Move_It_Now, Copy7CToSig, Copy7CToSig_1, CopyPos1ToDest, CopyPos2ToDest, CopyPos1ToTemp
		CopyPos2ToTemp, CopyTempToPos1, CopyTempToPos2, ReadAN0_L1, SetDestAsCur, ClampInt
		ClampInt_1, Param7D_LE_Param79, CopyToRam_L1, SaveParams_L1, DecTimer, EERead, EEWrite
WDTCON	0097 	start
WR	0001 	EEWrite, EEWriteLoop
WREN	0002 	EEWrite
Z	0002 	, Start_L1, LongFlash_L1, Delay_L1, MainLoop, ML_Btns_End, ML_CmdNormal, Set_Dest_End
		Copy7CToSig, SS_Start_Loop, ClampInt, ClampInt_1, Param7D_LE_Param79, CopyToRam_L1
		SaveParams_L1, DecTimer
 

X-Ref Table (The UnCalled)
Delay100uS !	024E 	
Delay10uS !	024C 	
Delay40uS !	0250 	
EEReadW !	0255 	
EEWriteW !	025F 	
IRQ_Servo1 !	002F 	
ReadAN0_Rtn !	019B 	
RocketServo.asm   X-Ref Table                                            Page: 17
/Users/davidflynn/Projects/Rocket-Servo/Firmware Rev B/

SetMiddlePosition !	01BE 	
SS_CmdNormal !	01A4 	
SS_Move_It !	01A7 	
SystemBlink_1 !	0018 	
TestT1_Zero !	0249 	
TestT2_Zero !	0246 	
TestT3_Zero !	0243 	
TestT4_Zero !	0240 	
 

Memory Usage Map ('X' = Used, '-' = Unused)
 
0000  : XXX-XXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0100  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0140  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0180  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
01C0  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0200  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0240  : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXX----------
 
Program Memory Words Used:629
Program Memory Words Free:1419
 
UserID
8000  :XXXX
 
Config
8007  :XX
 
EEPROM
F000  : XXXXX----------- ---------------- ---------------- ----------------
 
Data EEPROM Bytes Used:5
Data EEPROM Bytes Free:251
